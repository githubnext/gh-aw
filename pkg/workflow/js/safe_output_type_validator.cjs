const{sanitizeContent}=require("./sanitize_content.cjs"),{isTemporaryId}=require("./temporary_id.cjs"),MAX_BODY_LENGTH=65e3,MAX_GITHUB_USERNAME_LENGTH=39;let cachedValidationConfig=null;function loadValidationConfig(){if(null!==cachedValidationConfig)return cachedValidationConfig;const configJson=process.env.GH_AW_VALIDATION_CONFIG;if(!configJson)return cachedValidationConfig={},cachedValidationConfig;try{const parsed=JSON.parse(configJson);return cachedValidationConfig=parsed||{},cachedValidationConfig}catch(error){const errorMsg=error instanceof Error?error.message:String(error);return"undefined"!=typeof core&&core.error(`CRITICAL: Failed to parse validation config: ${errorMsg}. Validation will be skipped.`),cachedValidationConfig={},cachedValidationConfig}}function resetValidationConfigCache(){cachedValidationConfig=null}function getMaxAllowedForType(itemType,config){const itemConfig=config?.[itemType];if(itemConfig&&"object"==typeof itemConfig&&"max"in itemConfig&&itemConfig.max)return itemConfig.max;const typeConfig=loadValidationConfig()[itemType];return typeConfig?.defaultMax??1}function getMinRequiredForType(itemType,config){const itemConfig=config?.[itemType];return itemConfig&&"object"==typeof itemConfig&&"min"in itemConfig&&itemConfig.min?itemConfig.min:0}function validatePositiveInteger(value,fieldName,lineNum){if(null==value)return{isValid:!1,error:`Line ${lineNum}: ${fieldName} is required`};if("number"!=typeof value&&"string"!=typeof value)return{isValid:!1,error:`Line ${lineNum}: ${fieldName} must be a number or string`};const parsed="string"==typeof value?parseInt(value,10):value;return isNaN(parsed)||parsed<=0||!Number.isInteger(parsed)?{isValid:!1,error:`Line ${lineNum}: ${fieldName} must be a valid positive integer (got: ${value})`}:{isValid:!0,normalizedValue:parsed}}function validateOptionalPositiveInteger(value,fieldName,lineNum){if(void 0===value)return{isValid:!0};if("number"!=typeof value&&"string"!=typeof value)return{isValid:!1,error:`Line ${lineNum}: ${fieldName} must be a number or string`};const parsed="string"==typeof value?parseInt(value,10):value;return isNaN(parsed)||parsed<=0||!Number.isInteger(parsed)?{isValid:!1,error:`Line ${lineNum}: ${fieldName} must be a valid positive integer (got: ${value})`}:{isValid:!0,normalizedValue:parsed}}function validateIssueOrPRNumber(value,fieldName,lineNum){return void 0===value?{isValid:!0}:"number"!=typeof value&&"string"!=typeof value?{isValid:!1,error:`Line ${lineNum}: ${fieldName} must be a number or string`}:{isValid:!0}}function validateIssueNumberOrTemporaryId(value,fieldName,lineNum){if(null==value)return{isValid:!1,error:`Line ${lineNum}: ${fieldName} is required`};if("number"!=typeof value&&"string"!=typeof value)return{isValid:!1,error:`Line ${lineNum}: ${fieldName} must be a number or string`};if(isTemporaryId(value))return{isValid:!0,normalizedValue:String(value).toLowerCase(),isTemporary:!0};const parsed="string"==typeof value?parseInt(value,10):value;return isNaN(parsed)||parsed<=0||!Number.isInteger(parsed)?{isValid:!1,error:`Line ${lineNum}: ${fieldName} must be a positive integer or temporary ID (got: ${value})`}:{isValid:!0,normalizedValue:parsed,isTemporary:!1}}function validateField(value,fieldName,validation,itemType,lineNum,options){if(validation.positiveInteger)return validatePositiveInteger(value,`${itemType} '${fieldName}'`,lineNum);if(validation.issueNumberOrTemporaryId)return validateIssueNumberOrTemporaryId(value,`${itemType} '${fieldName}'`,lineNum);if(validation.required&&null==value)return{isValid:!1,error:`Line ${lineNum}: ${itemType} requires a '${fieldName}' field (${validation.type||"string"})`};if(null==value)return{isValid:!0};if(validation.optionalPositiveInteger)return validateOptionalPositiveInteger(value,`${itemType} '${fieldName}'`,lineNum);if(validation.issueOrPRNumber)return validateIssueOrPRNumber(value,`${itemType} '${fieldName}'`,lineNum);if("string"===validation.type){if("string"!=typeof value)return validation.required?{isValid:!1,error:`Line ${lineNum}: ${itemType} requires a '${fieldName}' field (string)`}:{isValid:!1,error:`Line ${lineNum}: ${itemType} '${fieldName}' must be a string`};if(validation.pattern&&!new RegExp(validation.pattern).test(value.trim()))return{isValid:!1,error:`Line ${lineNum}: ${itemType} '${fieldName}' ${validation.patternError||`must match pattern ${validation.pattern}`}`};if(validation.enum){const normalizedValue=value.toLowerCase?value.toLowerCase():value,normalizedEnum=validation.enum.map(e=>e.toLowerCase?e.toLowerCase():e);if(!normalizedEnum.includes(normalizedValue)){let errorMsg;return errorMsg=2===validation.enum.length?`Line ${lineNum}: ${itemType} '${fieldName}' must be '${validation.enum[0]}' or '${validation.enum[1]}'`:`Line ${lineNum}: ${itemType} '${fieldName}' must be one of: ${validation.enum.join(", ")}`,{isValid:!1,error:errorMsg}}const matchIndex=normalizedEnum.indexOf(normalizedValue);let normalizedResult=validation.enum[matchIndex];return validation.sanitize&&validation.maxLength&&(normalizedResult=sanitizeContent(normalizedResult,{maxLength:validation.maxLength,allowedAliases:options?.allowedAliases||[]})),{isValid:!0,normalizedValue:normalizedResult}}return validation.sanitize?{isValid:!0,normalizedValue:sanitizeContent(value,{maxLength:validation.maxLength||65e3,allowedAliases:options?.allowedAliases||[]})}:{isValid:!0,normalizedValue:value}}if("array"===validation.type){if(!Array.isArray(value))return validation.required?{isValid:!1,error:`Line ${lineNum}: ${itemType} requires a '${fieldName}' field (array)`}:{isValid:!1,error:`Line ${lineNum}: ${itemType} '${fieldName}' must be an array`};if("string"===validation.itemType){if(value.some(item=>"string"!=typeof item))return{isValid:!1,error:`Line ${lineNum}: ${itemType} ${fieldName} array must contain only strings`};if(validation.itemSanitize)return{isValid:!0,normalizedValue:value.map(item=>"string"==typeof item?sanitizeContent(item,{maxLength:validation.itemMaxLength||128,allowedAliases:options?.allowedAliases||[]}):item)}}return{isValid:!0,normalizedValue:value}}return"boolean"===validation.type?"boolean"!=typeof value?{isValid:!1,error:`Line ${lineNum}: ${itemType} '${fieldName}' must be a boolean`}:{isValid:!0,normalizedValue:value}:"number"===validation.type&&"number"!=typeof value?{isValid:!1,error:`Line ${lineNum}: ${itemType} '${fieldName}' must be a number`}:{isValid:!0,normalizedValue:value}}function executeCustomValidation(item,customValidation,lineNum,itemType){if(!customValidation)return null;if(customValidation.startsWith("requiresOneOf:")){const fields=customValidation.slice(14).split(",");if(!fields.some(field=>void 0!==item[field]))return{isValid:!1,error:`Line ${lineNum}: ${itemType} requires at least one of: ${fields.map(f=>`'${f}'`).join(", ")} fields`}}if("startLineLessOrEqualLine"===customValidation&&void 0!==item.start_line&&void 0!==item.line&&("string"==typeof item.start_line?parseInt(item.start_line,10):item.start_line)>("string"==typeof item.line?parseInt(item.line,10):item.line))return{isValid:!1,error:`Line ${lineNum}: ${itemType} 'start_line' must be less than or equal to 'line'`};if("parentAndSubDifferent"===customValidation){const normalizeValue=v=>"string"==typeof v?v.toLowerCase():v;if(normalizeValue(item.parent_issue_number)===normalizeValue(item.sub_issue_number))return{isValid:!1,error:`Line ${lineNum}: ${itemType} 'parent_issue_number' and 'sub_issue_number' must be different`}}return null}function validateItem(item,itemType,lineNum,options){const typeConfig=loadValidationConfig()[itemType];if(!typeConfig)return{isValid:!0,normalizedItem:item};const normalizedItem={...item},errors=[];if(typeConfig.customValidation){const customResult=executeCustomValidation(item,typeConfig.customValidation,lineNum,itemType);if(customResult&&!customResult.isValid)return customResult}for(const[fieldName,validation]of Object.entries(typeConfig.fields)){const result=validateField(item[fieldName],fieldName,validation,itemType,lineNum,options);result.isValid?void 0!==result.normalizedValue&&(normalizedItem[fieldName]=result.normalizedValue):errors.push(result.error)}return errors.length>0?{isValid:!1,error:errors[0]}:{isValid:!0,normalizedItem}}function hasValidationConfig(itemType){return itemType in loadValidationConfig()}function getValidationConfig(itemType){return loadValidationConfig()[itemType]}function getKnownTypes(){const validationConfig=loadValidationConfig();return Object.keys(validationConfig)}module.exports={validateItem,validateField,validatePositiveInteger,validateOptionalPositiveInteger,validateIssueOrPRNumber,validateIssueNumberOrTemporaryId,loadValidationConfig,resetValidationConfigCache,getMaxAllowedForType,getMinRequiredForType,hasValidationConfig,getValidationConfig,getKnownTypes,MAX_BODY_LENGTH:65e3,MAX_GITHUB_USERNAME_LENGTH:39};