const{loadAgentOutput}=require("./load_agent_output.cjs"),{generateStagedPreview}=require("./staged_preview.cjs"),{removeDuplicateTitleFromDescription}=require("./remove_duplicate_title.cjs");function resolveTargetNumber(params){const{updateTarget,item,numberField,isValidContext,contextNumber,displayName}=params;if("*"===updateTarget){const explicitNumber=item[numberField];if(explicitNumber){const parsed=parseInt(explicitNumber,10);return isNaN(parsed)||parsed<=0?{success:!1,error:`Invalid ${numberField} specified: ${explicitNumber}`}:{success:!0,number:parsed}}return{success:!1,error:`Target is "*" but no ${numberField} specified in update item`}}if(updateTarget&&"triggering"!==updateTarget){const parsed=parseInt(updateTarget,10);return isNaN(parsed)||parsed<=0?{success:!1,error:`Invalid ${displayName} number in target configuration: ${updateTarget}`}:{success:!0,number:parsed}}return isValidContext&&contextNumber?{success:!0,number:contextNumber}:{success:!1,error:`Could not determine ${displayName} number`}}function buildUpdateData(params){const{item,canUpdateStatus,canUpdateTitle,canUpdateBody,supportsStatus}=params,updateData={};let hasUpdates=!1;const logMessages=[];supportsStatus&&canUpdateStatus&&void 0!==item.status&&("open"===item.status||"closed"===item.status?(updateData.state=item.status,hasUpdates=!0,logMessages.push(`Will update status to: ${item.status}`)):logMessages.push(`Invalid status value: ${item.status}. Must be 'open' or 'closed'`));let titleForDedup=null;if(canUpdateTitle&&void 0!==item.title){const trimmedTitle="string"==typeof item.title?item.title.trim():"";trimmedTitle.length>0?(updateData.title=trimmedTitle,titleForDedup=trimmedTitle,hasUpdates=!0,logMessages.push(`Will update title to: ${trimmedTitle}`)):logMessages.push("Invalid title value: must be a non-empty string")}if(canUpdateBody&&void 0!==item.body)if("string"==typeof item.body){let processedBody=item.body;titleForDedup&&(processedBody=removeDuplicateTitleFromDescription(titleForDedup,processedBody)),updateData.body=processedBody,hasUpdates=!0,logMessages.push(`Will update body (length: ${processedBody.length})`)}else logMessages.push("Invalid body value: must be a string");return{hasUpdates,updateData,logMessages}}async function runUpdateWorkflow(config){const{itemType,displayName,displayNamePlural,numberField,outputNumberKey,outputUrlKey,isValidContext,getContextNumber,supportsStatus,supportsOperation,renderStagedItem,executeUpdate,getSummaryLine}=config,isStaged="true"===process.env.GH_AW_SAFE_OUTPUTS_STAGED,result=loadAgentOutput();if(!result.success)return;const updateItems=result.items.filter(item=>item.type===itemType);if(0===updateItems.length)return void core.info(`No ${itemType} items found in agent output`);if(core.info(`Found ${updateItems.length} ${itemType} item(s)`),isStaged)return void await generateStagedPreview({title:`Update ${displayNamePlural.charAt(0).toUpperCase()+displayNamePlural.slice(1)}`,description:`The following ${displayName} updates would be applied if staged mode was disabled:`,items:updateItems,renderItem:renderStagedItem});const updateTarget=process.env.GH_AW_UPDATE_TARGET||"triggering",canUpdateStatus="true"===process.env.GH_AW_UPDATE_STATUS,canUpdateTitle="true"===process.env.GH_AW_UPDATE_TITLE,canUpdateBody="true"===process.env.GH_AW_UPDATE_BODY;core.info(`Update target configuration: ${updateTarget}`),supportsStatus?core.info(`Can update status: ${canUpdateStatus}, title: ${canUpdateTitle}, body: ${canUpdateBody}`):core.info(`Can update title: ${canUpdateTitle}, body: ${canUpdateBody}`);const contextIsValid=isValidContext(context.eventName,context.payload),contextNumber=getContextNumber(context.payload);if("triggering"===updateTarget&&!contextIsValid)return void core.info(`Target is "triggering" but not running in ${displayName} context, skipping ${displayName} update`);const updatedItems=[];for(let i=0;i<updateItems.length;i++){const updateItem=updateItems[i];core.info(`Processing ${itemType} item ${i+1}/${updateItems.length}`);const targetResult=resolveTargetNumber({updateTarget,item:updateItem,numberField,isValidContext:contextIsValid,contextNumber,displayName});if(!targetResult.success){core.info(targetResult.error);continue}const targetNumber=targetResult.number;core.info(`Updating ${displayName} #${targetNumber}`);const{hasUpdates,updateData,logMessages}=buildUpdateData({item:updateItem,canUpdateStatus,canUpdateTitle,canUpdateBody,supportsStatus});for(const msg of logMessages)core.info(msg);if(supportsOperation&&canUpdateBody&&void 0!==updateItem.body&&"string"==typeof updateItem.body&&(updateData._operation=updateItem.operation||"append",updateData._rawBody=updateItem.body),hasUpdates)try{const updatedItem=await executeUpdate(github,context,targetNumber,updateData);core.info(`Updated ${displayName} #${updatedItem.number}: ${updatedItem.html_url}`),updatedItems.push(updatedItem),i===updateItems.length-1&&(core.setOutput(outputNumberKey,updatedItem.number),core.setOutput(outputUrlKey,updatedItem.html_url))}catch(error){throw core.error(`âœ— Failed to update ${displayName} #${targetNumber}: ${error instanceof Error?error.message:String(error)}`),error}else core.info("No valid updates to apply for this item")}if(updatedItems.length>0){let summaryContent=`\n\n## Updated ${displayNamePlural.charAt(0).toUpperCase()+displayNamePlural.slice(1)}\n`;for(const item of updatedItems)summaryContent+=getSummaryLine(item);await core.summary.addRaw(summaryContent).write()}return core.info(`Successfully updated ${updatedItems.length} ${displayName}(s)`),updatedItems}function createRenderStagedItem(config){const{entityName,numberField,targetLabel,currentTargetText,includeOperation=!1}=config;return function(item,index){let content=`### ${entityName} Update ${index+1}\n`;return item[numberField]?content+=`**${targetLabel}** #${item[numberField]}\n\n`:content+=`**Target:** ${currentTargetText}\n\n`,void 0!==item.title&&(content+=`**New Title:** ${item.title}\n\n`),void 0!==item.body&&(includeOperation?(content+=`**Operation:** ${item.operation||"append"}\n`,content+=`**Body Content:**\n${item.body}\n\n`):content+=`**New Body:**\n${item.body}\n\n`),void 0!==item.status&&(content+=`**New Status:** ${item.status}\n\n`),content}}function createGetSummaryLine(config){const{entityPrefix}=config;return function(item){return`- ${entityPrefix} #${item.number}: [${item.title}](${item.html_url})\n`}}module.exports={runUpdateWorkflow,resolveTargetNumber,buildUpdateData,createRenderStagedItem,createGetSummaryLine};