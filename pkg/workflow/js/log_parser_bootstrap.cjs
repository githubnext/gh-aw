const{generatePlainTextSummary,generateCopilotCliStyleSummary}=require("./log_parser_shared.cjs");function runLogParser(options){const fs=require("fs"),path=require("path"),{parseLog,parserName,supportsDirectories=!1}=options;try{const logPath=process.env.GH_AW_AGENT_OUTPUT;if(!logPath)return void core.info("No agent log file specified");if(!fs.existsSync(logPath))return void core.info(`Log path not found: ${logPath}`);let content="";if(fs.statSync(logPath).isDirectory()){if(!supportsDirectories)return void core.info(`Log path is a directory but ${parserName} parser does not support directories: ${logPath}`);const logFiles=fs.readdirSync(logPath).filter(file=>file.endsWith(".log")||file.endsWith(".txt"));if(0===logFiles.length)return void core.info(`No log files found in directory: ${logPath}`);logFiles.sort();for(const file of logFiles){const filePath=path.join(logPath,file),fileContent=fs.readFileSync(filePath,"utf8");content.length>0&&!content.endsWith("\n")&&(content+="\n"),content+=fileContent}}else content=fs.readFileSync(logPath,"utf8");const result=parseLog(content);let markdown="",mcpFailures=[],maxTurnsHit=!1,logEntries=null;if("string"==typeof result?markdown=result:result&&"object"==typeof result&&(markdown=result.markdown||"",mcpFailures=result.mcpFailures||[],maxTurnsHit=result.maxTurnsHit||!1,logEntries=result.logEntries||null),markdown)if(logEntries&&Array.isArray(logEntries)&&logEntries.length>0){const initEntry=logEntries.find(entry=>"system"===entry.type&&"init"===entry.subtype),model=initEntry?.model||null,plainTextSummary=generatePlainTextSummary(logEntries,{model,parserName});core.info(plainTextSummary);const copilotCliStyleMarkdown=generateCopilotCliStyleSummary(logEntries,{model,parserName});core.summary.addRaw(copilotCliStyleMarkdown).write()}else core.info(`${parserName} log parsed successfully`),core.summary.addRaw(markdown).write();else core.error(`Failed to parse ${parserName} log`);if(mcpFailures&&mcpFailures.length>0){const failedServers=mcpFailures.join(", ");core.setFailed(`MCP server(s) failed to launch: ${failedServers}`)}maxTurnsHit&&core.setFailed("Agent execution stopped: max-turns limit reached. The agent did not complete its task successfully.")}catch(error){core.setFailed(error instanceof Error?error:String(error))}}"undefined"!=typeof module&&module.exports&&(module.exports={runLogParser});