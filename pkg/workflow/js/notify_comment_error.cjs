const{loadAgentOutput}=require("./load_agent_output.cjs"),{getRunSuccessMessage,getRunFailureMessage,getDetectionFailureMessage}=require("./messages_run_status.cjs");function collectGeneratedAssets(){const assets=[],safeOutputJobsEnv=process.env.GH_AW_SAFE_OUTPUT_JOBS;if(!safeOutputJobsEnv)return assets;let jobOutputMapping;try{jobOutputMapping=JSON.parse(safeOutputJobsEnv)}catch(error){return core.warning(`Failed to parse GH_AW_SAFE_OUTPUT_JOBS: ${error instanceof Error?error.message:String(error)}`),assets}for(const[jobName,urlKey]of Object.entries(jobOutputMapping)){const envVarName=`GH_AW_OUTPUT_${jobName.toUpperCase()}_${urlKey.toUpperCase()}`,url=process.env[envVarName];url&&""!==url.trim()&&(assets.push(url),core.info(`Collected asset URL: ${url}`))}return assets}async function main(){const commentId=process.env.GH_AW_COMMENT_ID,commentRepo=process.env.GH_AW_COMMENT_REPO,runUrl=process.env.GH_AW_RUN_URL,workflowName=process.env.GH_AW_WORKFLOW_NAME||"Workflow",agentConclusion=process.env.GH_AW_AGENT_CONCLUSION||"failure",detectionConclusion=process.env.GH_AW_DETECTION_CONCLUSION;core.info(`Comment ID: ${commentId}`),core.info(`Comment Repo: ${commentRepo}`),core.info(`Run URL: ${runUrl}`),core.info(`Workflow Name: ${workflowName}`),core.info(`Agent Conclusion: ${agentConclusion}`),detectionConclusion&&core.info(`Detection Conclusion: ${detectionConclusion}`);let noopMessages=[];const agentOutputResult=loadAgentOutput();if(agentOutputResult.success&&agentOutputResult.data){const noopItems=agentOutputResult.data.items.filter(item=>"noop"===item.type);noopItems.length>0&&(core.info(`Found ${noopItems.length} noop message(s)`),noopMessages=noopItems.map(item=>item.message))}if(!commentId&&noopMessages.length>0){core.info("No comment ID found, writing noop messages to step summary");let summaryContent="## No-Op Messages\n\n";return summaryContent+="The following messages were logged for transparency:\n\n",1===noopMessages.length?summaryContent+=noopMessages[0]:summaryContent+=noopMessages.map((msg,idx)=>`${idx+1}. ${msg}`).join("\n"),await core.summary.addRaw(summaryContent).write(),void core.info(`Successfully wrote ${noopMessages.length} noop message(s) to step summary`)}if(!commentId)return void core.info("No comment ID found and no noop messages to process, skipping comment update");if(!runUrl)return void core.setFailed("Run URL is required");const repoOwner=commentRepo?commentRepo.split("/")[0]:context.repo.owner,repoName=commentRepo?commentRepo.split("/")[1]:context.repo.repo;let message;if(core.info(`Updating comment in ${repoOwner}/${repoName}`),detectionConclusion&&"failure"===detectionConclusion)message=getDetectionFailureMessage({workflowName,runUrl});else if("success"===agentConclusion)message=getRunSuccessMessage({workflowName,runUrl});else{let statusText;statusText="cancelled"===agentConclusion?"was cancelled":"skipped"===agentConclusion?"was skipped":"timed_out"===agentConclusion?"timed out":"failed",message=getRunFailureMessage({workflowName,runUrl,status:statusText})}noopMessages.length>0&&(message+="\n\n",1===noopMessages.length?message+=noopMessages[0]:message+=noopMessages.map((msg,idx)=>`${idx+1}. ${msg}`).join("\n"));const generatedAssets=collectGeneratedAssets();generatedAssets.length>0&&(message+="\n\n",generatedAssets.forEach(url=>{message+=`${url}\n`}));const isDiscussionComment=commentId.startsWith("DC_");try{if(isDiscussionComment){const comment=(await github.graphql("\n        mutation($commentId: ID!, $body: String!) {\n          updateDiscussionComment(input: { commentId: $commentId, body: $body }) {\n            comment {\n              id\n              url\n            }\n          }\n        }",{commentId,body:message})).updateDiscussionComment.comment;core.info("Successfully updated discussion comment"),core.info(`Comment ID: ${comment.id}`),core.info(`Comment URL: ${comment.url}`)}else{const response=await github.request("PATCH /repos/{owner}/{repo}/issues/comments/{comment_id}",{owner:repoOwner,repo:repoName,comment_id:parseInt(commentId,10),body:message,headers:{Accept:"application/vnd.github+json"}});core.info("Successfully updated comment"),core.info(`Comment ID: ${response.data.id}`),core.info(`Comment URL: ${response.data.html_url}`)}}catch(error){core.warning(`Failed to update comment: ${error instanceof Error?error.message:String(error)}`)}}main().catch(error=>{core.setFailed(error instanceof Error?error.message:String(error))});