const fs=require("fs"),path=require("path"),{execSync}=require("child_process");async function main(){const artifactDir=process.env.ARTIFACT_DIR,memoryId=process.env.MEMORY_ID,targetRepo=process.env.TARGET_REPO,branchName=process.env.BRANCH_NAME,maxFileSize=parseInt(process.env.MAX_FILE_SIZE||"10240",10),maxFileCount=parseInt(process.env.MAX_FILE_COUNT||"100",10),fileGlobFilter=process.env.FILE_GLOB_FILTER||"",ghToken=process.env.GH_TOKEN,githubRunId=process.env.GITHUB_RUN_ID||"unknown";if(!(artifactDir&&memoryId&&targetRepo&&branchName&&ghToken))return void core.setFailed("Missing required environment variables: ARTIFACT_DIR, MEMORY_ID, TARGET_REPO, BRANCH_NAME, GH_TOKEN");const sourceMemoryPath=path.join(artifactDir,"memory",memoryId);if(!fs.existsSync(sourceMemoryPath))return void core.info(`Memory directory not found in artifact: ${sourceMemoryPath}`);const workspaceDir=process.env.GITHUB_WORKSPACE||process.cwd();core.info(`Working in repository: ${workspaceDir}`),core.info("Disabling sparse checkout...");try{execSync("git sparse-checkout disable",{stdio:"pipe"})}catch(error){core.info("Sparse checkout was not enabled or already disabled")}core.info(`Checking out branch: ${branchName}...`);try{const repoUrl=`https://x-access-token:${ghToken}@github.com/${targetRepo}.git`;try{execSync(`git fetch "${repoUrl}" "${branchName}:${branchName}"`,{stdio:"pipe"}),execSync(`git checkout "${branchName}"`,{stdio:"inherit"}),core.info(`Checked out existing branch: ${branchName}`)}catch(fetchError){core.info(`Branch ${branchName} does not exist, creating orphan branch...`),execSync(`git checkout --orphan "${branchName}"`,{stdio:"inherit"}),execSync("git rm -rf . || true",{stdio:"pipe"}),core.info(`Created orphan branch: ${branchName}`)}}catch(error){return void core.setFailed(`Failed to checkout branch: ${error instanceof Error?error.message:String(error)}`)}const destMemoryPath=path.join(workspaceDir,"memory",memoryId);fs.mkdirSync(destMemoryPath,{recursive:!0}),core.info(`Destination directory: ${destMemoryPath}`);let filesToCopy=[];try{const files=fs.readdirSync(sourceMemoryPath,{withFileTypes:!0});for(const file of files){if(!file.isFile())continue;const fileName=file.name,sourceFilePath=path.join(sourceMemoryPath,fileName),stats=fs.statSync(sourceFilePath);if(fileGlobFilter&&!fileGlobFilter.split(/\s+/).map(pattern=>{const regexPattern=pattern.replace(/\./g,"\\.").replace(/\*/g,"[^/]*");return new RegExp(`^${regexPattern}$`)}).some(pattern=>pattern.test(fileName)))return core.error(`File does not match allowed patterns: ${fileName}`),core.error(`Allowed patterns: ${fileGlobFilter}`),void core.setFailed("File pattern validation failed");if(stats.size>maxFileSize)return core.error(`File exceeds size limit: ${fileName} (${stats.size} bytes > ${maxFileSize} bytes)`),void core.setFailed("File size validation failed");filesToCopy.push({name:fileName,source:sourceFilePath,size:stats.size})}}catch(error){return void core.setFailed(`Failed to read artifact directory: ${error instanceof Error?error.message:String(error)}`)}if(filesToCopy.length>maxFileCount)return void core.setFailed(`Too many files (${filesToCopy.length} > ${maxFileCount})`);if(0===filesToCopy.length)return void core.info("No files to copy from artifact");core.info(`Copying ${filesToCopy.length} validated file(s)...`);for(const file of filesToCopy){const destFilePath=path.join(destMemoryPath,file.name);try{fs.copyFileSync(file.source,destFilePath),core.info(`Copied: ${file.name} (${file.size} bytes)`)}catch(error){return void core.setFailed(`Failed to copy file ${file.name}: ${error instanceof Error?error.message:String(error)}`)}}let hasChanges=!1;try{hasChanges=execSync("git status --porcelain",{encoding:"utf8"}).trim().length>0}catch(error){return void core.setFailed(`Failed to check git status: ${error instanceof Error?error.message:String(error)}`)}if(hasChanges){core.info("Changes detected, committing and pushing...");try{execSync("git add .",{stdio:"inherit"})}catch(error){return void core.setFailed(`Failed to stage changes: ${error instanceof Error?error.message:String(error)}`)}try{execSync(`git commit -m "Update repo memory from workflow run ${githubRunId}"`,{stdio:"inherit"})}catch(error){return void core.setFailed(`Failed to commit changes: ${error instanceof Error?error.message:String(error)}`)}core.info(`Pulling latest changes from ${branchName}...`);try{execSync(`git pull --no-rebase -X ours "https://x-access-token:${ghToken}@github.com/${targetRepo}.git" "${branchName}"`,{stdio:"inherit"})}catch(error){core.warning(`Pull failed (this may be expected): ${error instanceof Error?error.message:String(error)}`)}core.info(`Pushing changes to ${branchName}...`);try{execSync(`git push "https://x-access-token:${ghToken}@github.com/${targetRepo}.git" HEAD:"${branchName}"`,{stdio:"inherit"}),core.info(`Successfully pushed changes to ${branchName} branch`)}catch(error){return void core.setFailed(`Failed to push changes: ${error instanceof Error?error.message:String(error)}`)}}else core.info("No changes detected after copying files")}main().catch(error=>{core.setFailed(`Unexpected error: ${error instanceof Error?error.message:String(error)}`)});