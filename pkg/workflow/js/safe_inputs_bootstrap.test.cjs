import{describe,it,expect,beforeEach,afterEach,vi}from"vitest";import fs from"fs";import path from"path";import os from"os";describe("safe_inputs_bootstrap.cjs",()=>{let tempDir;beforeEach(()=>{vi.resetModules(),tempDir=fs.mkdtempSync(path.join(os.tmpdir(),"safe-inputs-bootstrap-test-"))}),afterEach(()=>{tempDir&&fs.existsSync(tempDir)&&fs.rmSync(tempDir,{recursive:!0})}),describe("bootstrapSafeInputsServer",()=>{it("should load configuration and return bootstrap result",async()=>{const{bootstrapSafeInputsServer}=await import("./safe_inputs_bootstrap.cjs"),configPath=path.join(tempDir,"config.json");fs.writeFileSync(configPath,JSON.stringify({serverName:"test-server",version:"1.0.0",tools:[{name:"test_tool",description:"A test tool",inputSchema:{type:"object",properties:{}}}]}));const logger={debug:vi.fn(),debugError:vi.fn()},result=bootstrapSafeInputsServer(configPath,logger);expect(result.config.serverName).toBe("test-server"),expect(result.config.version).toBe("1.0.0"),expect(result.config.tools).toHaveLength(1),expect(result.basePath).toBe(tempDir),expect(result.tools).toBeInstanceOf(Array),expect(logger.debug).toHaveBeenCalled()}),it("should load tools with handlers",async()=>{const{bootstrapSafeInputsServer}=await import("./safe_inputs_bootstrap.cjs"),handlerPath=path.join(tempDir,"test_handler.cjs");fs.writeFileSync(handlerPath,'module.exports = function(args) { return { content: [{ type: "text", text: "test" }] }; };');const configPath=path.join(tempDir,"config.json");fs.writeFileSync(configPath,JSON.stringify({serverName:"test-server",version:"1.0.0",tools:[{name:"test_tool",description:"A test tool",inputSchema:{type:"object",properties:{}},handler:"test_handler.cjs"}]}));const result=bootstrapSafeInputsServer(configPath,{debug:vi.fn(),debugError:vi.fn()});expect(result.tools).toHaveLength(1),expect(result.tools[0].name).toBe("test_tool"),expect(result.tools[0].handler).toBeInstanceOf(Function)}),it("should throw error for non-existent config file",async()=>{const{bootstrapSafeInputsServer}=await import("./safe_inputs_bootstrap.cjs"),logger={debug:vi.fn(),debugError:vi.fn()};expect(()=>bootstrapSafeInputsServer("/non/existent/config.json",logger)).toThrow("Configuration file not found")})}),describe("cleanupConfigFile",()=>{it("should delete configuration file",async()=>{const{cleanupConfigFile}=await import("./safe_inputs_bootstrap.cjs"),configPath=path.join(tempDir,"config.json");fs.writeFileSync(configPath,JSON.stringify({tools:[]}));const logger={debug:vi.fn(),debugError:vi.fn()};expect(fs.existsSync(configPath)).toBe(!0),cleanupConfigFile(configPath,logger),expect(fs.existsSync(configPath)).toBe(!1),expect(logger.debug).toHaveBeenCalledWith(expect.stringContaining("Deleted configuration file"))}),it("should handle non-existent file gracefully",async()=>{const{cleanupConfigFile}=await import("./safe_inputs_bootstrap.cjs"),logger={debug:vi.fn(),debugError:vi.fn()};cleanupConfigFile("/non/existent/config.json",logger),expect(logger.debugError).not.toHaveBeenCalled()}),it("should handle deletion errors gracefully",async()=>{const{cleanupConfigFile}=await import("./safe_inputs_bootstrap.cjs"),configPath=path.join(tempDir,"config.json");fs.writeFileSync(configPath,JSON.stringify({tools:[]}));const originalUnlink=fs.unlinkSync;fs.unlinkSync=vi.fn(()=>{throw new Error("Permission denied")});const logger={debug:vi.fn(),debugError:vi.fn()};cleanupConfigFile(configPath,logger),expect(logger.debugError).toHaveBeenCalledWith(expect.stringContaining("Warning: Could not delete configuration file"),expect.any(Error)),fs.unlinkSync=originalUnlink})})});