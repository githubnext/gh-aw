const fs=require("fs"),path=require("path"),{execSync}=require("child_process"),{getBaseBranch}=require("./get_base_branch.cjs");function generateGitPatch(branchName){const patchPath="/tmp/gh-aw/aw.patch",cwd=process.env.GITHUB_WORKSPACE||process.cwd(),defaultBranch=process.env.DEFAULT_BRANCH||getBaseBranch(),githubSha=process.env.GITHUB_SHA,patchDir=path.dirname(patchPath);fs.existsSync(patchDir)||fs.mkdirSync(patchDir,{recursive:!0});let patchGenerated=!1,errorMessage=null;try{if(branchName)try{let baseRef;execSync(`git show-ref --verify --quiet refs/heads/${branchName}`,{cwd,encoding:"utf8"});try{execSync(`git show-ref --verify --quiet refs/remotes/origin/${branchName}`,{cwd,encoding:"utf8"}),baseRef=`origin/${branchName}`}catch{execSync(`git fetch origin ${defaultBranch}`,{cwd,encoding:"utf8"}),baseRef=execSync(`git merge-base origin/${defaultBranch} ${branchName}`,{cwd,encoding:"utf8"}).trim()}if(parseInt(execSync(`git rev-list --count ${baseRef}..${branchName}`,{cwd,encoding:"utf8"}).trim(),10)>0){const patchContent=execSync(`git format-patch ${baseRef}..${branchName} --stdout`,{cwd,encoding:"utf8"});patchContent&&patchContent.trim()&&(fs.writeFileSync(patchPath,patchContent,"utf8"),patchGenerated=!0)}}catch(branchError){}if(!patchGenerated){const currentHead=execSync("git rev-parse HEAD",{cwd,encoding:"utf8"}).trim();if(githubSha)if(currentHead===githubSha);else try{if(execSync(`git merge-base --is-ancestor ${githubSha} HEAD`,{cwd,encoding:"utf8"}),parseInt(execSync(`git rev-list --count ${githubSha}..HEAD`,{cwd,encoding:"utf8"}).trim(),10)>0){const patchContent=execSync(`git format-patch ${githubSha}..HEAD --stdout`,{cwd,encoding:"utf8"});patchContent&&patchContent.trim()&&(fs.writeFileSync(patchPath,patchContent,"utf8"),patchGenerated=!0)}}catch{}else errorMessage="GITHUB_SHA environment variable is not set"}}catch(error){errorMessage=`Failed to generate patch: ${error instanceof Error?error.message:String(error)}`}if(patchGenerated&&fs.existsSync(patchPath)){const patchContent=fs.readFileSync(patchPath,"utf8"),patchSize=Buffer.byteLength(patchContent,"utf8"),patchLines=patchContent.split("\n").length;return patchContent.trim()?{success:!0,patchPath,patchSize,patchLines}:{success:!1,error:"No changes to commit - patch is empty",patchPath,patchSize:0,patchLines:0}}return{success:!1,error:errorMessage||"No changes to commit - no commits found",patchPath}}module.exports={generateGitPatch};