const{runLogParser}=require("./log_parser_bootstrap.cjs"),{generateConversationMarkdown,generateInformationSection,formatInitializationSummary,formatToolUse,parseLogEntries}=require("./log_parser_shared.cjs");function main(){runLogParser({parseLog:parseCopilotLog,parserName:"Copilot",supportsDirectories:!0})}function extractPremiumRequestCount(logContent){const patterns=[/premium\s+requests?\s+consumed:?\s*(\d+)/i,/(\d+)\s+premium\s+requests?\s+consumed/i,/consumed\s+(\d+)\s+premium\s+requests?/i];for(const pattern of patterns){const match=logContent.match(pattern);if(match&&match[1]){const count=parseInt(match[1],10);if(!isNaN(count)&&count>0)return count}}return 1}function parseCopilotLog(logContent){try{let logEntries;try{if(logEntries=JSON.parse(logContent),!Array.isArray(logEntries))throw new Error("Not a JSON array")}catch(jsonArrayError){const debugLogEntries=parseDebugLogFormat(logContent);logEntries=debugLogEntries&&debugLogEntries.length>0?debugLogEntries:parseLogEntries(logContent)}if(!logEntries||0===logEntries.length)return{markdown:"## Agent Log Summary\n\nLog format not recognized as Copilot JSON array or JSONL.\n",logEntries:[]};const conversationResult=generateConversationMarkdown(logEntries,{formatToolCallback:(toolUse,toolResult)=>formatToolUse(toolUse,toolResult,{includeDetailedParameters:!0}),formatInitCallback:initEntry=>formatInitializationSummary(initEntry,{includeSlashCommands:!1,modelInfoCallback:entry=>{if(!entry.model_info)return"";const modelInfo=entry.model_info;let markdown="";if(modelInfo.name&&(markdown+=`**Model Name:** ${modelInfo.name}`,modelInfo.vendor&&(markdown+=` (${modelInfo.vendor})`),markdown+="\n\n"),modelInfo.billing){const billing=modelInfo.billing;!0===billing.is_premium?(markdown+="**Premium Model:** Yes",billing.multiplier&&1!==billing.multiplier&&(markdown+=` (${billing.multiplier}x cost multiplier)`),markdown+="\n",billing.restricted_to&&Array.isArray(billing.restricted_to)&&billing.restricted_to.length>0&&(markdown+=`**Required Plans:** ${billing.restricted_to.join(", ")}\n`),markdown+="\n"):!1===billing.is_premium&&(markdown+="**Premium Model:** No\n\n")}return markdown}})});let markdown=conversationResult.markdown;const lastEntry=logEntries[logEntries.length-1],initEntry=logEntries.find(entry=>"system"===entry.type&&"init"===entry.subtype);return markdown+=generateInformationSection(lastEntry,{additionalInfoCallback:entry=>initEntry&&initEntry.model_info&&initEntry.model_info.billing&&!0===initEntry.model_info.billing.is_premium?`**Premium Requests Consumed:** ${extractPremiumRequestCount(logContent)}\n\n`:""}),{markdown,logEntries}}catch(error){return{markdown:`## Agent Log Summary\n\nError parsing Copilot log (tried both JSON array and JSONL formats): ${error instanceof Error?error.message:String(error)}\n`,logEntries:[]}}}function scanForToolErrors(logContent){const toolErrors=new Map,lines=logContent.split("\n"),recentToolCalls=[];for(let i=0;i<lines.length;i++){const line=lines[i];if(line.includes('"tool_calls":')&&!line.includes('\\"tool_calls\\"'))for(let j=i+1;j<Math.min(i+30,lines.length);j++){const nextLine=lines[j],idMatch=nextLine.match(/"id":\s*"([^"]+)"/);if(nextLine.match(/"name":\s*"([^"]+)"/)&&nextLine.includes('\\"name\\"'),idMatch){const toolId=idMatch[1];for(let k=j;k<Math.min(j+10,lines.length);k++){const nameLine=lines[k],funcNameMatch=nameLine.match(/"name":\s*"([^"]+)"/);if(funcNameMatch&&!nameLine.includes('\\"name\\"')){const toolName=funcNameMatch[1];recentToolCalls.unshift({id:toolId,name:toolName}),recentToolCalls.length>10&&recentToolCalls.pop();break}}}}if(line.match(/\[ERROR\].*(?:Tool execution failed|Permission denied|Resource not accessible|Error executing tool)/i)){const toolNameMatch=line.match(/Tool execution failed:\s*([^\s]+)/i),toolIdMatch=line.match(/tool_call_id:\s*([^\s]+)/i);if(toolNameMatch){const toolName=toolNameMatch[1];toolErrors.set(toolName,!0);const matchingTool=recentToolCalls.find(t=>t.name===toolName);matchingTool&&toolErrors.set(matchingTool.id,!0)}else if(toolIdMatch)toolErrors.set(toolIdMatch[1],!0);else if(recentToolCalls.length>0){const lastTool=recentToolCalls[0];toolErrors.set(lastTool.id,!0),toolErrors.set(lastTool.name,!0)}}}return toolErrors}function parseDebugLogFormat(logContent){const entries=[],lines=logContent.split("\n"),toolErrors=scanForToolErrors(logContent);let model="unknown",sessionId=null,modelInfo=null,tools=[];const modelMatch=logContent.match(/Starting Copilot CLI: ([\d.]+)/);modelMatch&&(sessionId=`copilot-${modelMatch[1]}-${Date.now()}`);const gotModelInfoIndex=logContent.indexOf("[DEBUG] Got model info: {");if(-1!==gotModelInfoIndex){const jsonStart=logContent.indexOf("{",gotModelInfoIndex);if(-1!==jsonStart){let braceCount=0,inString=!1,escapeNext=!1,jsonEnd=-1;for(let i=jsonStart;i<logContent.length;i++){const char=logContent[i];if(escapeNext)escapeNext=!1;else if("\\"!==char)if('"'!==char||escapeNext){if(!inString)if("{"===char)braceCount++;else if("}"===char&&(braceCount--,0===braceCount)){jsonEnd=i+1;break}}else inString=!inString;else escapeNext=!0}if(-1!==jsonEnd){const modelInfoJson=logContent.substring(jsonStart,jsonEnd);try{modelInfo=JSON.parse(modelInfoJson)}catch(e){}}}}const toolsIndex=logContent.indexOf("[DEBUG] Tools:");if(-1!==toolsIndex){const afterToolsLine=logContent.indexOf("\n",toolsIndex);let toolsStart=logContent.indexOf("[DEBUG] [",afterToolsLine);if(-1!==toolsStart&&(toolsStart=logContent.indexOf("[",toolsStart+7)),-1!==toolsStart){let bracketCount=0,inString=!1,escapeNext=!1,toolsEnd=-1;for(let i=toolsStart;i<logContent.length;i++){const char=logContent[i];if(escapeNext)escapeNext=!1;else if("\\"!==char)if('"'!==char||escapeNext){if(!inString)if("["===char)bracketCount++;else if("]"===char&&(bracketCount--,0===bracketCount)){toolsEnd=i+1;break}}else inString=!inString;else escapeNext=!0}if(-1!==toolsEnd){let toolsJson=logContent.substring(toolsStart,toolsEnd);toolsJson=toolsJson.replace(/^\d{4}-\d{2}-\d{2}T[\d:.]+Z \[DEBUG\] /gm,"");try{const toolsArray=JSON.parse(toolsJson);Array.isArray(toolsArray)&&(tools=toolsArray.map(tool=>{if("function"===tool.type&&tool.function&&tool.function.name){let name=tool.function.name;return name.startsWith("github-")?name="mcp__github__"+name.substring(7):name.startsWith("safe_outputs-"),name}return null}).filter(name=>null!==name))}catch(e){}}}}let inDataBlock=!1,currentJsonLines=[],turnCount=0;for(let i=0;i<lines.length;i++){const line=lines[i];if(line.includes("[DEBUG] data:"))inDataBlock=!0,currentJsonLines=[];else if(inDataBlock){const hasTimestamp=line.match(/^\d{4}-\d{2}-\d{2}T[\d:.]+Z /);if(hasTimestamp){const cleanLine=line.replace(/^\d{4}-\d{2}-\d{2}T[\d:.]+Z \[DEBUG\] /,""),isJsonContent=/^[{\[}\]"]/.test(cleanLine)||cleanLine.trim().startsWith('"');if(!isJsonContent){if(currentJsonLines.length>0)try{const jsonStr=currentJsonLines.join("\n"),jsonData=JSON.parse(jsonStr);if(jsonData.model&&(model=jsonData.model),jsonData.choices&&Array.isArray(jsonData.choices)){for(const choice of jsonData.choices)if(choice.message){const message=choice.message,content=[],toolResults=[];if(message.content&&message.content.trim()&&content.push({type:"text",text:message.content}),message.tool_calls&&Array.isArray(message.tool_calls))for(const toolCall of message.tool_calls)if(toolCall.function){let toolName=toolCall.function.name;const originalToolName=toolName,toolId=toolCall.id||`tool_${Date.now()}_${Math.random()}`;let args={};toolName.startsWith("github-")?toolName="mcp__github__"+toolName.substring(7):"bash"===toolName&&(toolName="Bash");try{args=JSON.parse(toolCall.function.arguments)}catch(e){args={}}content.push({type:"tool_use",id:toolId,name:toolName,input:args});const hasError=toolErrors.has(toolId)||toolErrors.has(originalToolName);toolResults.push({type:"tool_result",tool_use_id:toolId,content:hasError?"Permission denied or tool execution failed":"",is_error:hasError})}content.length>0&&(entries.push({type:"assistant",message:{content}}),turnCount++,toolResults.length>0&&entries.push({type:"user",message:{content:toolResults}}))}jsonData.usage&&(entries._accumulatedUsage||(entries._accumulatedUsage={input_tokens:0,output_tokens:0}),jsonData.usage.prompt_tokens&&(entries._accumulatedUsage.input_tokens+=jsonData.usage.prompt_tokens),jsonData.usage.completion_tokens&&(entries._accumulatedUsage.output_tokens+=jsonData.usage.completion_tokens),entries._lastResult={type:"result",num_turns:turnCount,usage:entries._accumulatedUsage})}}catch(e){}inDataBlock=!1,currentJsonLines=[];continue}hasTimestamp&&isJsonContent&&currentJsonLines.push(cleanLine)}else{const cleanLine=line.replace(/^\d{4}-\d{2}-\d{2}T[\d:.]+Z \[DEBUG\] /,"");currentJsonLines.push(cleanLine)}}}if(inDataBlock&&currentJsonLines.length>0)try{const jsonStr=currentJsonLines.join("\n"),jsonData=JSON.parse(jsonStr);if(jsonData.model&&(model=jsonData.model),jsonData.choices&&Array.isArray(jsonData.choices)){for(const choice of jsonData.choices)if(choice.message){const message=choice.message,content=[],toolResults=[];if(message.content&&message.content.trim()&&content.push({type:"text",text:message.content}),message.tool_calls&&Array.isArray(message.tool_calls))for(const toolCall of message.tool_calls)if(toolCall.function){let toolName=toolCall.function.name;const originalToolName=toolName,toolId=toolCall.id||`tool_${Date.now()}_${Math.random()}`;let args={};toolName.startsWith("github-")?toolName="mcp__github__"+toolName.substring(7):"bash"===toolName&&(toolName="Bash");try{args=JSON.parse(toolCall.function.arguments)}catch(e){args={}}content.push({type:"tool_use",id:toolId,name:toolName,input:args});const hasError=toolErrors.has(toolId)||toolErrors.has(originalToolName);toolResults.push({type:"tool_result",tool_use_id:toolId,content:hasError?"Permission denied or tool execution failed":"",is_error:hasError})}content.length>0&&(entries.push({type:"assistant",message:{content}}),turnCount++,toolResults.length>0&&entries.push({type:"user",message:{content:toolResults}}))}jsonData.usage&&(entries._accumulatedUsage||(entries._accumulatedUsage={input_tokens:0,output_tokens:0}),jsonData.usage.prompt_tokens&&(entries._accumulatedUsage.input_tokens+=jsonData.usage.prompt_tokens),jsonData.usage.completion_tokens&&(entries._accumulatedUsage.output_tokens+=jsonData.usage.completion_tokens),entries._lastResult={type:"result",num_turns:turnCount,usage:entries._accumulatedUsage})}}catch(e){}if(entries.length>0){const initEntry={type:"system",subtype:"init",session_id:sessionId,model,tools};modelInfo&&(initEntry.model_info=modelInfo),entries.unshift(initEntry),entries._lastResult&&(entries.push(entries._lastResult),delete entries._lastResult)}return entries}"undefined"!=typeof module&&module.exports&&(module.exports={parseCopilotLog,extractPremiumRequestCount}),main();