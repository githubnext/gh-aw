const{loadAgentOutput}=require("./load_agent_output.cjs"),{generateStagedPreview}=require("./staged_preview.cjs"),{parseAllowedItems,resolveTarget}=require("./safe_output_helpers.cjs"),{getSafeOutputConfig,validateMaxCount}=require("./safe_output_validator.cjs");async function processSafeOutput(config,stagedPreviewOptions){const{itemType,configKey,displayName,itemTypeName,supportsPR=!1,supportsIssue=!1,findMultiple=!1,envVars}=config,result=loadAgentOutput();if(!result.success)return{success:!1,reason:"Agent output not available"};let items;if(findMultiple){if(items=result.items.filter(item=>item.type===itemType),0===items.length)return core.info(`No ${itemType} items found in agent output`),{success:!1,reason:`No ${itemType} items found`};core.info(`Found ${items.length} ${itemType} item(s)`)}else{const item=result.items.find(item=>item.type===itemType);if(!item)return core.warning(`No ${itemType.replace(/_/g,"-")} item found in agent output`),{success:!1,reason:`No ${itemType} item found`};items=[item];const itemDetails=getItemDetails(item);itemDetails&&core.info(`Found ${itemType.replace(/_/g,"-")} item with ${itemDetails}`)}if("true"===process.env.GH_AW_SAFE_OUTPUTS_STAGED)return await generateStagedPreview({title:stagedPreviewOptions.title,description:stagedPreviewOptions.description,items,renderItem:stagedPreviewOptions.renderItem}),{success:!1,reason:"Staged mode - preview generated"};const safeOutputConfig=getSafeOutputConfig(configKey),allowedEnvValue=envVars.allowed?process.env[envVars.allowed]:void 0,allowed=parseAllowedItems(allowedEnvValue)||safeOutputConfig.allowed;allowed?core.info(`Allowed ${itemTypeName}s: ${JSON.stringify(allowed)}`):core.info(`No ${itemTypeName} restrictions - any ${itemTypeName}s are allowed`);const maxCountEnvValue=envVars.maxCount?process.env[envVars.maxCount]:void 0,maxCountResult=validateMaxCount(maxCountEnvValue,safeOutputConfig.max);if(!maxCountResult.valid)return core.setFailed(maxCountResult.error),{success:!1,reason:"Invalid max count configuration"};const maxCount=maxCountResult.value;core.info(`Max count: ${maxCount}`);const target=envVars.target&&process.env[envVars.target]||"triggering";if(core.info(`${displayName} target configuration: ${target}`),findMultiple)return{success:!0,items,config:{allowed,maxCount,target}};const item=items[0],targetResult=resolveTarget({targetConfig:target,item,context,itemType:itemTypeName,supportsPR:supportsPR||supportsIssue});return targetResult.success?{success:!0,item,config:{allowed,maxCount,target},targetResult:{number:targetResult.number,contextType:targetResult.contextType}}:(targetResult.shouldFail?core.setFailed(targetResult.error):core.info(targetResult.error),{success:!1,reason:targetResult.error})}function getItemDetails(item){return item.labels&&Array.isArray(item.labels)?`${item.labels.length} labels`:item.reviewers&&Array.isArray(item.reviewers)?`${item.reviewers.length} reviewers`:null}function sanitizeItems(items){return items.filter(item=>null!=item&&!1!==item&&0!==item).map(item=>String(item).trim()).filter(item=>item).filter((item,index,arr)=>arr.indexOf(item)===index)}function filterByAllowed(items,allowed){return allowed&&0!==allowed.length?items.filter(item=>allowed.includes(item)):items}function limitToMaxCount(items,maxCount){return items.length>maxCount?(core.info(`Too many items (${items.length}), limiting to ${maxCount}`),items.slice(0,maxCount)):items}function processItems(rawItems,allowed,maxCount){return limitToMaxCount(sanitizeItems(filterByAllowed(rawItems,allowed)),maxCount)}module.exports={processSafeOutput,sanitizeItems,filterByAllowed,limitToMaxCount,processItems};