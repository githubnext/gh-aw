const{spawn}=require("child_process"),path=require("path"),serverPath=path.join("/tmp/gh-aw/safeoutputs/mcp-server.cjs"),{GH_AW_SAFE_OUTPUTS_TOOL_CALLS}=process.env;function parseJsonl(input){return input?input.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(line=>JSON.parse(line)):[]}const toolCalls=parseJsonl(GH_AW_SAFE_OUTPUTS_TOOL_CALLS),child=spawn(process.execPath,[serverPath],{stdio:["pipe","pipe","pipe"],env:process.env});let stdoutBuffer=Buffer.alloc(0);const pending=new Map;let nextId=1;function writeMessage(obj){const message=JSON.stringify(obj)+"\n";child.stdin.write(message)}function sendRequest(method,params){const id=nextId++,req={jsonrpc:"2.0",id,method,params};return new Promise((resolve,reject)=>{pending.set(id,{resolve,reject}),writeMessage(req);const to=setTimeout(()=>{pending.has(id)&&(pending.delete(id),reject(new Error(`Request timed out: ${method}`)))},5e3),origResolve=resolve;resolve=value=>{clearTimeout(to),origResolve(value)}})}function handleMessage(msg){if(!msg.method||msg.id){if(void 0!==msg.id&&(void 0!==msg.result||void 0!==msg.error)){const waiter=pending.get(msg.id);return void(waiter?(pending.delete(msg.id),msg.error?waiter.reject(new Error(msg.error.message||JSON.stringify(msg.error))):waiter.resolve(msg.result)):console.error("<- response with unknown id",msg.id))}console.error("<- unexpected message",msg)}else console.error("<- notification",msg.method,msg.params||"")}child.stdout.on("data",chunk=>{for(stdoutBuffer=Buffer.concat([stdoutBuffer,chunk]);;){const newlineIndex=stdoutBuffer.indexOf("\n");if(-1===newlineIndex)break;const line=stdoutBuffer.slice(0,newlineIndex).toString("utf8").replace(/\r$/,"");if(stdoutBuffer=stdoutBuffer.slice(newlineIndex+1),""===line.trim())continue;let parsed=null;try{parsed=JSON.parse(line)}catch(e){console.error("Failed to parse server message",e);continue}handleMessage(parsed)}}),child.stderr.on("data",d=>{process.stderr.write("[server] "+d.toString())}),child.on("exit",(code,sig)=>{console.error("server exited",code,sig)}),(async()=>{try{console.error("Starting MCP client -> spawning server at",serverPath);const init=await sendRequest("initialize",{clientInfo:{name:"mcp-stdio-client",version:"0.1.0"},protocolVersion:"2024-11-05"});console.error("initialize ->",init);const toolsList=await sendRequest("tools/list",{});console.error("tools/list ->",toolsList);for(const toolCall of toolCalls){const{type,...args}=toolCall;console.error("Calling tool:",type,args);try{const res=await sendRequest("tools/call",{name:type,arguments:args});console.error("tools/call ->",res)}catch(err){console.error("tools/call error for",type,err)}}setTimeout(()=>{try{child.kill()}catch(e){}process.exit(0)},200)}catch(e){console.error("Error in MCP client:",e);try{child.kill()}catch(e){}process.exit(1)}})();