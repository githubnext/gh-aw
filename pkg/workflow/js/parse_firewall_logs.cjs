const{sanitizeWorkflowName}=require("./sanitize_workflow_name.cjs");function main(){const fs=require("fs"),path=require("path");try{const squidLogsDir="/tmp/gh-aw/sandbox/firewall/logs/";if(!fs.existsSync(squidLogsDir))return void core.info(`No firewall logs directory found at: ${squidLogsDir}`);const files=fs.readdirSync(squidLogsDir).filter(file=>file.endsWith(".log"));if(0===files.length)return void core.info(`No firewall log files found in: ${squidLogsDir}`);core.info(`Found ${files.length} firewall log file(s)`);let totalRequests=0,allowedRequests=0,deniedRequests=0;const allowedDomains=new Set,deniedDomains=new Set,requestsByDomain=new Map;for(const file of files){const filePath=path.join(squidLogsDir,file);core.info(`Parsing firewall log: ${file}`);const lines=fs.readFileSync(filePath,"utf8").split("\n").filter(line=>line.trim());for(const line of lines){const entry=parseFirewallLogLine(line);if(!entry)continue;totalRequests++;const isAllowed=isRequestAllowed(entry.decision,entry.status);isAllowed?(allowedRequests++,allowedDomains.add(entry.domain)):(deniedRequests++,deniedDomains.add(entry.domain)),requestsByDomain.has(entry.domain)||requestsByDomain.set(entry.domain,{allowed:0,denied:0});const domainStats=requestsByDomain.get(entry.domain);isAllowed?domainStats.allowed++:domainStats.denied++}}const summary=generateFirewallSummary({totalRequests,allowedRequests,deniedRequests,allowedDomains:Array.from(allowedDomains).sort(),deniedDomains:Array.from(deniedDomains).sort(),requestsByDomain});core.summary.addRaw(summary).write(),core.info("Firewall log summary generated successfully")}catch(error){core.setFailed(error instanceof Error?error:String(error))}}function parseFirewallLogLine(line){const trimmed=line.trim();if(!trimmed||trimmed.startsWith("#"))return null;const fields=trimmed.match(/(?:[^\s"]+|"[^"]*")+/g);if(!fields||fields.length<10)return null;const timestamp=fields[0];return/^\d+(\.\d+)?$/.test(timestamp)?{timestamp,clientIpPort:fields[1],domain:fields[2],destIpPort:fields[3],proto:fields[4],method:fields[5],status:fields[6],decision:fields[7],url:fields[8],userAgent:fields[9]?.replace(/^"|"$/g,"")||"-"}:null}function isRequestAllowed(decision,status){const statusCode=parseInt(status,10);return 200===statusCode||206===statusCode||304===statusCode||!!(decision.includes("TCP_TUNNEL")||decision.includes("TCP_HIT")||decision.includes("TCP_MISS"))||(decision.includes("NONE_NONE")||decision.includes("TCP_DENIED"),!1)}function generateFirewallSummary(analysis){const{totalRequests,requestsByDomain}=analysis,validDomains=Array.from(requestsByDomain.keys()).filter(domain=>"-"!==domain).sort(),uniqueDomainCount=validDomains.length;let validAllowedRequests=0,validDeniedRequests=0;for(const domain of validDomains){const stats=requestsByDomain.get(domain);validAllowedRequests+=stats.allowed,validDeniedRequests+=stats.denied}let summary="### ðŸ”¥ Firewall Activity\n\n";if(summary+="<details>\n",summary+=`<summary>ðŸ“Š ${totalRequests} request${1!==totalRequests?"s":""} | `,summary+=`${validAllowedRequests} allowed | `,summary+=`${validDeniedRequests} blocked | `,summary+=`${uniqueDomainCount} unique domain${1!==uniqueDomainCount?"s":""}</summary>\n\n`,uniqueDomainCount>0){summary+="| Domain | Allowed | Denied |\n",summary+="|--------|---------|--------|\n";for(const domain of validDomains){const stats=requestsByDomain.get(domain);summary+=`| ${domain} | ${stats.allowed} | ${stats.denied} |\n`}}else summary+="No firewall activity detected.\n";return summary+="\n</details>\n\n",summary}"undefined"!=typeof module&&module.exports&&(module.exports={parseFirewallLogLine,isRequestAllowed,generateFirewallSummary,main});const isDirectExecution="undefined"==typeof module||"undefined"!=typeof require&&void 0!==require.main&&require.main===module;isDirectExecution&&main();