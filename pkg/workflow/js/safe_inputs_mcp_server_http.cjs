const http=require("http"),{randomUUID}=require("crypto"),{MCPServer,MCPHTTPTransport}=require("./mcp_http_transport.cjs"),{validateRequiredFields}=require("./safe_inputs_validation.cjs"),{createLogger}=require("./mcp_logger.cjs"),{bootstrapSafeInputsServer,cleanupConfigFile}=require("./safe_inputs_bootstrap.cjs");function createMCPServer(configPath,options={}){const logger=createLogger("safeinputs");logger.debug("=== Creating MCP Server ==="),logger.debug(`Configuration file: ${configPath}`);const{config,tools}=bootstrapSafeInputsServer(configPath,logger),serverName=config.serverName||"safeinputs",version=config.version||"1.0.0";logger.debug(`Server name: ${serverName}`),logger.debug(`Server version: ${version}`);const server=new MCPServer({name:serverName,version},{capabilities:{tools:{}}});logger.debug("Registering tools with MCP server...");let registeredCount=0,skippedCount=0;for(const tool of tools)tool.handler?(logger.debug(`Registering tool: ${tool.name}`),server.tool(tool.name,tool.description||"",tool.inputSchema||{type:"object",properties:{}},async args=>{logger.debug(`Calling handler for tool: ${tool.name}`);const missing=validateRequiredFields(args,tool.inputSchema);if(missing.length)throw new Error(`Invalid arguments: missing or empty ${missing.map(m=>`'${m}'`).join(", ")}`);const result=await Promise.resolve(tool.handler(args));return logger.debug(`Handler returned for tool: ${tool.name}`),{content:result&&result.content?result.content:[],isError:!1}}),registeredCount++):(logger.debug(`Skipping tool ${tool.name} - no handler loaded`),skippedCount++);return logger.debug(`Tool registration complete: ${registeredCount} registered, ${skippedCount} skipped`),logger.debug("=== MCP Server Creation Complete ==="),cleanupConfigFile(configPath,logger),{server,config,logger}}async function startHttpServer(configPath,options={}){const port=options.port||3e3,stateless=options.stateless||!1,logger=createLogger("safe-inputs-startup");logger.debug("=== Starting Safe Inputs MCP HTTP Server ==="),logger.debug(`Configuration file: ${configPath}`),logger.debug(`Port: ${port}`),logger.debug("Mode: "+(stateless?"stateless":"stateful")),logger.debug(`Environment: NODE_VERSION=${process.version}, PLATFORM=${process.platform}`);try{const{server,config,logger:mcpLogger}=createMCPServer(configPath,{logDir:options.logDir});Object.assign(logger,mcpLogger),logger.debug("MCP server created successfully"),logger.debug(`Server name: ${config.serverName||"safeinputs"}`),logger.debug(`Server version: ${config.version||"1.0.0"}`),logger.debug(`Tools configured: ${config.tools.length}`),logger.debug("Creating HTTP transport...");const transport=new MCPHTTPTransport({sessionIdGenerator:stateless?void 0:()=>randomUUID(),enableJsonResponse:!0,enableDnsRebindingProtection:!1});logger.debug("HTTP transport created"),logger.debug("Connecting server to transport..."),await server.connect(transport),logger.debug("Server connected to transport successfully"),logger.debug("Creating HTTP server...");const httpServer=http.createServer(async(req,res)=>{if(res.setHeader("Access-Control-Allow-Origin","*"),res.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),res.setHeader("Access-Control-Allow-Headers","Content-Type, Accept"),"OPTIONS"===req.method)return res.writeHead(200),void res.end();if("GET"===req.method&&"/health"===req.url)return res.writeHead(200,{"Content-Type":"application/json"}),void res.end(JSON.stringify({status:"ok",server:config.serverName||"safeinputs",version:config.version||"1.0.0",tools:config.tools.length}));if("POST"!==req.method)return res.writeHead(405,{"Content-Type":"application/json"}),void res.end(JSON.stringify({error:"Method not allowed"}));try{let body=null;if("POST"===req.method){const chunks=[];for await(const chunk of req)chunks.push(chunk);const bodyStr=Buffer.concat(chunks).toString();try{body=bodyStr?JSON.parse(bodyStr):null}catch(parseError){return res.writeHead(400,{"Content-Type":"application/json"}),void res.end(JSON.stringify({jsonrpc:"2.0",error:{code:-32700,message:"Parse error: Invalid JSON in request body"},id:null}))}}await transport.handleRequest(req,res,body)}catch(error){logger.debugError("Error handling request: ",error),res.headersSent||(res.writeHead(500,{"Content-Type":"application/json"}),res.end(JSON.stringify({jsonrpc:"2.0",error:{code:-32603,message:error instanceof Error?error.message:String(error)},id:null})))}});return logger.debug(`Attempting to bind to port ${port}...`),httpServer.listen(port,()=>{logger.debug("=== Safe Inputs MCP HTTP Server Started Successfully ==="),logger.debug(`HTTP server listening on http://localhost:${port}`),logger.debug(`MCP endpoint: POST http://localhost:${port}/`),logger.debug(`Server name: ${config.serverName||"safeinputs"}`),logger.debug(`Server version: ${config.version||"1.0.0"}`),logger.debug(`Tools available: ${config.tools.length}`),logger.debug("Server is ready to accept requests")}),httpServer.on("error",error=>{"EADDRINUSE"===error.code?logger.debugError(`ERROR: Port ${port} is already in use. `,error):"EACCES"===error.code?logger.debugError(`ERROR: Permission denied to bind to port ${port}. `,error):logger.debugError("ERROR: Failed to start HTTP server: ",error),process.exit(1)}),process.on("SIGINT",()=>{logger.debug("Received SIGINT, shutting down..."),httpServer.close(()=>{logger.debug("HTTP server closed"),process.exit(0)})}),process.on("SIGTERM",()=>{logger.debug("Received SIGTERM, shutting down..."),httpServer.close(()=>{logger.debug("HTTP server closed"),process.exit(0)})}),httpServer}catch(error){const errorLogger=createLogger("safe-inputs-startup-error");throw errorLogger.debug("=== FATAL ERROR: Failed to start Safe Inputs MCP HTTP Server ==="),errorLogger.debug(`Error type: ${error.constructor.name}`),errorLogger.debug(`Error message: ${error.message}`),error.stack&&errorLogger.debug(`Stack trace:\n${error.stack}`),error.code&&errorLogger.debug(`Error code: ${error.code}`),errorLogger.debug(`Configuration file: ${configPath}`),errorLogger.debug(`Port: ${port}`),error}}if(require.main===module){const args=process.argv.slice(2);args.length<1&&(console.error("Usage: node safe_inputs_mcp_server_http.cjs <config.json> [--port <number>] [--stateless] [--log-dir <path>]"),process.exit(1));const configPath=args[0],options={port:3e3,stateless:!1,logDir:void 0};for(let i=1;i<args.length;i++)"--port"===args[i]&&args[i+1]?(options.port=parseInt(args[i+1],10),i++):"--stateless"===args[i]?options.stateless=!0:"--log-dir"===args[i]&&args[i+1]&&(options.logDir=args[i+1],i++);startHttpServer(configPath,options).catch(error=>{console.error(`Error starting HTTP server: ${error instanceof Error?error.message:String(error)}`),process.exit(1)})}module.exports={startHttpServer,createMCPServer};