import{describe,it,expect,beforeEach,vi}from"vitest";let updatePRModule;const mockCore={debug:vi.fn(),info:vi.fn(),notice:vi.fn(),warning:vi.fn(),error:vi.fn(),setFailed:vi.fn(),setOutput:vi.fn(),summary:{addRaw:vi.fn().mockReturnThis(),write:vi.fn().mockResolvedValue()}},mockGithub={rest:{pulls:{get:vi.fn(),update:vi.fn()}}},mockContext={eventName:"pull_request",repo:{owner:"testowner",repo:"testrepo"},serverUrl:"https://github.com",runId:12345,payload:{pull_request:{number:100}}};global.core=mockCore,global.github=mockGithub,global.context=mockContext,describe("update_pull_request.cjs - executePRUpdate function",()=>{beforeEach(async()=>{vi.clearAllMocks(),vi.resetModules(),process.env.GH_AW_WORKFLOW_NAME="Test Workflow",updatePRModule=await import("./update_pull_request.cjs"),mockGithub.rest.pulls.get.mockResolvedValue({data:{number:100,title:"Test PR",body:"Original body content",html_url:"https://github.com/testowner/testrepo/pull/100"}}),mockGithub.rest.pulls.update.mockResolvedValue({data:{number:100,title:"Test PR",body:"Updated body",html_url:"https://github.com/testowner/testrepo/pull/100"}})}),describe("Replace operation",()=>{it("should replace entire body when operation is replace",async()=>{mockGithub.rest.pulls.update.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"New body content",html_url:"https://github.com/testowner/testrepo/pull/100"}});expect(mockGithub.rest.pulls.get).not.toHaveBeenCalled()})}),describe("Append operation",()=>{it("should append content to empty body",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"",html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody="\n\n---\n\nNew content to append\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)";expect(expectedBody).toContain("---"),expect(expectedBody).toContain("New content to append"),expect(expectedBody).toContain("> AI generated by")}),it("should append content to existing body",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original content",html_url:"https://github.com/testowner/testrepo/pull/100"}});const newContent="New content to append",expectedBody=`Original content\n\n---\n\n${newContent}\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)`;expect(expectedBody).toContain("Original content"),expect(expectedBody).toContain("---"),expect(expectedBody).toContain(newContent),expect(expectedBody).toContain("> AI generated by"),expect(expectedBody.indexOf("Original content")).toBeLessThan(expectedBody.indexOf(newContent))}),it("should preserve copilot section when appending",async()=>{const copilotSection="\x3c!-- copilot --\x3e\n## Copilot Progress\n- [x] Step 1\n- [ ] Step 2";mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:`Original content\n\n${copilotSection}`,html_url:"https://github.com/testowner/testrepo/pull/100"}});const newContent="New content to append",expectedBody=`Original content\n\n${copilotSection}\n\n---\n\n${newContent}\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)`;expect(expectedBody).toContain(copilotSection),expect(expectedBody).toContain("Original content"),expect(expectedBody).toContain(newContent),expect(expectedBody.indexOf(copilotSection)).toBeLessThan(expectedBody.indexOf(newContent))}),it("should append with special characters in content",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original",html_url:"https://github.com/testowner/testrepo/pull/100"}});const newContent="Content with **markdown**, `code`, and [links](http://example.com)",expectedBody=`Original\n\n---\n\n${newContent}\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)`;expect(expectedBody).toContain(newContent),expect(expectedBody).toContain("**markdown**"),expect(expectedBody).toContain("`code`"),expect(expectedBody).toContain("[links](http://example.com)")}),it("should handle multiple append operations correctly",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original content",html_url:"https://github.com/testowner/testrepo/pull/100"}});const bodyAfterFirst="Original content\n\n---\n\nFirst append\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)";mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:bodyAfterFirst,html_url:"https://github.com/testowner/testrepo/pull/100"}});const bodyAfterSecond=`${bodyAfterFirst}\n\n---\n\nSecond append\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)`;expect(bodyAfterSecond).toContain("Original content"),expect(bodyAfterSecond).toContain("First append"),expect(bodyAfterSecond).toContain("Second append");const separatorCount=(bodyAfterSecond.match(/---/g)||[]).length;expect(separatorCount).toBe(2)}),it("should append to body with existing AI footer",async()=>{const existingFooter="\n\n> AI generated by [Previous Workflow](https://github.com/testowner/testrepo/actions/runs/11111)";mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:`Original content${existingFooter}`,html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody=`Original content${existingFooter}\n\n---\n\nNew content\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)`;expect(expectedBody).toContain("Previous Workflow"),expect(expectedBody).toContain("Test Workflow")}),it("should handle very long content",async()=>{const longContent="A".repeat(1e4);mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original",html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody=`Original\n\n---\n\n${longContent}\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)`;expect(expectedBody).toContain(longContent),expect(expectedBody.length).toBeGreaterThan(1e4)}),it("should handle null body as empty string",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:null,html_url:"https://github.com/testowner/testrepo/pull/100"}});expect("\n\n---\n\nNew content\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)").toContain("New content")})}),describe("Prepend operation",()=>{it("should prepend content to empty body",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"",html_url:"https://github.com/testowner/testrepo/pull/100"}});const newContent="New content to prepend",expectedBody=`${newContent}\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\n---\n\n`;expect(expectedBody).toContain(newContent),expect(expectedBody).toContain("---"),expect(expectedBody).toContain("> AI generated by"),expect(expectedBody.indexOf(newContent)).toBeLessThan(expectedBody.indexOf("---"))}),it("should prepend content to existing body",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original content",html_url:"https://github.com/testowner/testrepo/pull/100"}});const newContent="New content to prepend",expectedBody=`${newContent}\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\n---\n\nOriginal content`;expect(expectedBody).toContain("Original content"),expect(expectedBody).toContain(newContent),expect(expectedBody.indexOf(newContent)).toBeLessThan(expectedBody.indexOf("Original content"))}),it("should preserve copilot section when prepending",async()=>{const copilotSection="\x3c!-- copilot --\x3e\n## Copilot Progress\n- [x] Step 1\n- [ ] Step 2";mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:`${copilotSection}\n\nOriginal content`,html_url:"https://github.com/testowner/testrepo/pull/100"}});const newContent="New content to prepend",expectedBody=`${newContent}\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\n---\n\n${copilotSection}\n\nOriginal content`;expect(expectedBody).toContain(copilotSection),expect(expectedBody).toContain("Original content"),expect(expectedBody).toContain(newContent),expect(expectedBody.indexOf(newContent)).toBeLessThan(expectedBody.indexOf("---")),expect(expectedBody.indexOf("---")).toBeLessThan(expectedBody.indexOf(copilotSection))}),it("should prepend with special characters",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original",html_url:"https://github.com/testowner/testrepo/pull/100"}});const newContent="Content with **markdown**, `code`, and [links](http://example.com)",expectedBody=`${newContent}\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\n---\n\nOriginal`;expect(expectedBody).toContain(newContent),expect(expectedBody).toContain("**markdown**")}),it("should handle multiple prepend operations correctly",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original content",html_url:"https://github.com/testowner/testrepo/pull/100"}});const bodyAfterFirst="First prepend\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\n---\n\nOriginal content";mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:bodyAfterFirst,html_url:"https://github.com/testowner/testrepo/pull/100"}});const bodyAfterSecond=`Second prepend\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\n---\n\n${bodyAfterFirst}`;expect(bodyAfterSecond.indexOf("Second prepend")).toBeLessThan(bodyAfterSecond.indexOf("First prepend")),expect(bodyAfterSecond.indexOf("First prepend")).toBeLessThan(bodyAfterSecond.indexOf("Original content"))}),it("should handle null body as empty string",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:null,html_url:"https://github.com/testowner/testrepo/pull/100"}});expect("New content\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\n---\n\n").toContain("New content")})}),describe("Copilot section preservation",()=>{it("should preserve HTML comment markers",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"\x3c!-- copilot --\x3e\n## Progress\nContent here",html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody="\x3c!-- copilot --\x3e\n## Progress\nContent here\n\n---\n\nNew content\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)";expect(expectedBody).toContain("\x3c!-- copilot --\x3e"),expect(expectedBody).toContain("## Progress")}),it("should preserve multiple HTML comment sections",async()=>{const body="\x3c!-- section1 --\x3e\nSection 1\n\n\x3c!-- section2 --\x3e\nSection 2";mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body,html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody=`${body}\n\n---\n\nNew content\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)`;expect(expectedBody).toContain("\x3c!-- section1 --\x3e"),expect(expectedBody).toContain("\x3c!-- section2 --\x3e"),expect(expectedBody).toContain("Section 1"),expect(expectedBody).toContain("Section 2")}),it("should preserve task list checkboxes",async()=>{const body="## Tasks\n- [x] Completed task\n- [ ] Pending task\n- [x] Another completed";mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body,html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody=`${body}\n\n---\n\nNew content\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)`;expect(expectedBody).toContain("- [x] Completed task"),expect(expectedBody).toContain("- [ ] Pending task"),expect(expectedBody).toContain("- [x] Another completed")}),it("should preserve code blocks",async()=>{const body="```javascript\nconst x = 1;\nconsole.log(x);\n```";mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body,html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody=`${body}\n\n---\n\nNew content\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)`;expect(expectedBody).toContain("```javascript"),expect(expectedBody).toContain("const x = 1;"),expect(expectedBody).toContain("```")}),it("should preserve tables",async()=>{const body="| Column 1 | Column 2 |\n|----------|----------|\n| Value 1  | Value 2  |";mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body,html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody=`${body}\n\n---\n\nNew content\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)`;expect(expectedBody).toContain("| Column 1 | Column 2 |"),expect(expectedBody).toContain("| Value 1  | Value 2  |")})}),describe("Edge cases",()=>{it("should handle empty string content",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original",html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody="Original\n\n---\n\n\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)";expect(expectedBody).toContain("Original"),expect(expectedBody).toContain("> AI generated by")}),it("should handle content with newlines at boundaries",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original\n\n\n",html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody="Original\n\n\n\n\n---\n\n\n\nNew content\n\n\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)";expect(expectedBody).toContain("Original"),expect(expectedBody).toContain("New content")}),it("should handle unicode characters",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original ä½ å¥½",html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody="Original ä½ å¥½\n\n---\n\nNew content ä¸–ç•Œ ðŸš€\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)";expect(expectedBody).toContain("ä½ å¥½"),expect(expectedBody).toContain("ä¸–ç•Œ ðŸš€")}),it("should handle content with many separators",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Content 1\n\n---\n\nContent 2\n\n---\n\nContent 3",html_url:"https://github.com/testowner/testrepo/pull/100"}});const separatorCount=("Content 1\n\n---\n\nContent 2\n\n---\n\nContent 3\n\n---\n\nNew content\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)".match(/---/g)||[]).length;expect(separatorCount).toBe(3)})}),describe("Workflow name handling",()=>{it("should use custom workflow name from environment",async()=>{process.env.GH_AW_WORKFLOW_NAME="Custom Workflow Name",mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original",html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody="Original\n\n---\n\nNew content\n\n> AI generated by [Custom Workflow Name](https://github.com/testowner/testrepo/actions/runs/12345)";expect(expectedBody).toContain("Custom Workflow Name"),expect(expectedBody).not.toContain("Test Workflow")}),it("should use default workflow name when not set",async()=>{delete process.env.GH_AW_WORKFLOW_NAME,mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original",html_url:"https://github.com/testowner/testrepo/pull/100"}});expect("Original\n\n---\n\nNew content\n\n> AI generated by [GitHub Agentic Workflow](https://github.com/testowner/testrepo/actions/runs/12345)").toContain("GitHub Agentic Workflow")})}),describe("Replace-island operation",()=>{it("should create new island when not found",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original content",html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody="Original content\n\n---\n\n\x3c!-- gh-aw-island-start:12345 --\x3e\nIsland content\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\x3c!-- gh-aw-island-end:12345 --\x3e";expect(expectedBody).toContain("Original content"),expect(expectedBody).toContain("Island content"),expect(expectedBody).toContain("\x3c!-- gh-aw-island-start:12345 --\x3e"),expect(expectedBody).toContain("\x3c!-- gh-aw-island-end:12345 --\x3e")}),it("should replace existing island content",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Before\n\x3c!-- gh-aw-island-start:12345 --\x3e\nOld island\n\x3c!-- gh-aw-island-end:12345 --\x3e\nAfter",html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody="Before\n\x3c!-- gh-aw-island-start:12345 --\x3e\nNew island\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\x3c!-- gh-aw-island-end:12345 --\x3e\nAfter";expect(expectedBody).toContain("Before"),expect(expectedBody).toContain("After"),expect(expectedBody).toContain("New island"),expect(expectedBody).not.toContain("Old island")}),it("should preserve content outside island",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"# Title\n\n\x3c!-- gh-aw-island-start:12345 --\x3e\nOld\n\x3c!-- gh-aw-island-end:12345 --\x3e\n\n## Footer",html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody="# Title\n\n\x3c!-- gh-aw-island-start:12345 --\x3e\nUpdated\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\x3c!-- gh-aw-island-end:12345 --\x3e\n\n## Footer";expect(expectedBody).toContain("# Title"),expect(expectedBody).toContain("## Footer"),expect(expectedBody).toContain("Updated"),expect(expectedBody).not.toContain("Old")}),it("should not replace island with different run ID",async()=>{const existingBody="\x3c!-- gh-aw-island-start:99999 --\x3e\nOther island\n\x3c!-- gh-aw-island-end:99999 --\x3e";mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:existingBody,html_url:"https://github.com/testowner/testrepo/pull/100"}});const expectedBody=`${existingBody}\n\n---\n\n\x3c!-- gh-aw-island-start:12345 --\x3e\nNew island\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\x3c!-- gh-aw-island-end:12345 --\x3e`;expect(expectedBody).toContain("Other island"),expect(expectedBody).toContain("New island"),expect(expectedBody).toContain("\x3c!-- gh-aw-island-start:99999 --\x3e"),expect(expectedBody).toContain("\x3c!-- gh-aw-island-start:12345 --\x3e")}),it("should allow multiple updates to same island",async()=>{mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original content",html_url:"https://github.com/testowner/testrepo/pull/100"}});mockGithub.rest.pulls.get.mockResolvedValueOnce({data:{number:100,title:"Test PR",body:"Original content\n\n---\n\n\x3c!-- gh-aw-island-start:12345 --\x3e\nFirst update\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\x3c!-- gh-aw-island-end:12345 --\x3e",html_url:"https://github.com/testowner/testrepo/pull/100"}});const bodyAfterSecond="Original content\n\n---\n\n\x3c!-- gh-aw-island-start:12345 --\x3e\nSecond update\n\n> AI generated by [Test Workflow](https://github.com/testowner/testrepo/actions/runs/12345)\n\x3c!-- gh-aw-island-end:12345 --\x3e";expect(bodyAfterSecond).toContain("Original content"),expect(bodyAfterSecond).toContain("Second update"),expect(bodyAfterSecond).not.toContain("First update");const startMarkerCount=(bodyAfterSecond.match(/<!-- gh-aw-island-start:12345 -->/g)||[]).length;expect(startMarkerCount).toBe(1)})})});