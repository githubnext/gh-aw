const fs=require("fs"),{isTruthy}=require("./is_truthy.cjs"),{processRuntimeImports}=require("./runtime_import.cjs");function interpolateVariables(content,variables){let result=content;for(const[varName,value]of Object.entries(variables)){const pattern=new RegExp(`\\$\\{${varName}\\}`,"g");result=result.replace(pattern,value)}return result}function renderMarkdownTemplate(markdown){let result=markdown.replace(/(\n?)([ \t]*{{#if\s+([^}]*)}}[ \t]*\n)([\s\S]*?)([ \t]*{{\/if}}[ \t]*)(\n?)/g,(match,leadNL,openLine,cond,body,closeLine,trailNL)=>isTruthy(cond)?leadNL+body:"");return result=result.replace(/{{#if\s+([^}]*)}}([\s\S]*?){{\/if}}/g,(_,cond,body)=>isTruthy(cond)?body:""),result=result.replace(/\n{3,}/g,"\n\n"),result}async function main(){try{const promptPath=process.env.GH_AW_PROMPT;if(!promptPath)return void core.setFailed("GH_AW_PROMPT environment variable is not set");const workspaceDir=process.env.GITHUB_WORKSPACE;if(!workspaceDir)return void core.setFailed("GITHUB_WORKSPACE environment variable is not set");let content=fs.readFileSync(promptPath,"utf8");/{{#runtime-import\??[ \t]+[^\}]+}}/.test(content)?(core.info("Processing runtime import macros"),content=processRuntimeImports(content,workspaceDir),core.info("Runtime imports processed successfully")):core.info("No runtime import macros found, skipping runtime import processing");const variables={};for(const[key,value]of Object.entries(process.env))key.startsWith("GH_AW_EXPR_")&&(variables[key]=value||"");const varCount=Object.keys(variables).length;varCount>0?(core.info(`Found ${varCount} expression variable(s) to interpolate`),content=interpolateVariables(content,variables),core.info(`Successfully interpolated ${varCount} variable(s) in prompt`)):core.info("No expression variables found, skipping interpolation"),/{{#if\s+[^}]+}}/.test(content)?(core.info("Processing conditional template blocks"),content=renderMarkdownTemplate(content),core.info("Template rendered successfully")):core.info("No conditional blocks found in prompt, skipping template rendering"),fs.writeFileSync(promptPath,content,"utf8")}catch(error){core.setFailed(error instanceof Error?error.message:String(error))}}main();