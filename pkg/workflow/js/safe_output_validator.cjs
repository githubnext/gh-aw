const fs=require("fs"),{sanitizeLabelContent}=require("./sanitize_label_content.cjs");function loadSafeOutputsConfig(){const configPath="/tmp/gh-aw/safeoutputs/config.json";try{if(!fs.existsSync(configPath))return core.warning(`Config file not found at ${configPath}, using defaults`),{};const configContent=fs.readFileSync(configPath,"utf8");return JSON.parse(configContent)}catch(error){return core.warning(`Failed to load config: ${error instanceof Error?error.message:String(error)}`),{}}}function getSafeOutputConfig(outputType){return loadSafeOutputsConfig()[outputType]||{}}function validateTitle(title,fieldName="title"){if(null==title)return{valid:!1,error:`${fieldName} is required`};if("string"!=typeof title)return{valid:!1,error:`${fieldName} must be a string`};const trimmed=title.trim();return 0===trimmed.length?{valid:!1,error:`${fieldName} cannot be empty`}:{valid:!0,value:trimmed}}function validateBody(body,fieldName="body",required=!1){return null==body?required?{valid:!1,error:`${fieldName} is required`}:{valid:!0,value:""}:"string"!=typeof body?{valid:!1,error:`${fieldName} must be a string`}:{valid:!0,value:body}}function validateLabels(labels,allowedLabels=void 0,maxCount=3){if(!labels||!Array.isArray(labels))return{valid:!1,error:"labels must be an array"};for(const label of labels)if(label&&"string"==typeof label&&label.startsWith("-"))return{valid:!1,error:`Label removal is not permitted. Found line starting with '-': ${label}`};let validLabels=labels;allowedLabels&&allowedLabels.length>0&&(validLabels=labels.filter(label=>allowedLabels.includes(label)));const uniqueLabels=validLabels.filter(label=>null!=label&&!1!==label&&0!==label).map(label=>String(label).trim()).filter(label=>label).map(label=>sanitizeLabelContent(label)).filter(label=>label).map(label=>label.length>64?label.substring(0,64):label).filter((label,index,arr)=>arr.indexOf(label)===index);return uniqueLabels.length>maxCount?(core.info(`Too many labels (${uniqueLabels.length}), limiting to ${maxCount}`),{valid:!0,value:uniqueLabels.slice(0,maxCount)}):0===uniqueLabels.length?{valid:!1,error:"No valid labels found after sanitization"}:{valid:!0,value:uniqueLabels}}function validateMaxCount(envValue,configDefault,fallbackDefault=1){if(!envValue)return{valid:!0,value:void 0!==configDefault?configDefault:fallbackDefault};const parsed=parseInt(envValue,10);return isNaN(parsed)||parsed<1?{valid:!1,error:`Invalid max value: ${envValue}. Must be a positive integer`}:{valid:!0,value:parsed}}module.exports={loadSafeOutputsConfig,getSafeOutputConfig,validateTitle,validateBody,validateLabels,validateMaxCount};