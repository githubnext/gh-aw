const fs=require("fs"),path=require("path");async function main(){core.setOutput("task_number",""),core.setOutput("task_url","");const isStaged="true"===process.env.GITHUB_AW_SAFE_OUTPUTS_STAGED,agentOutputFile=process.env.GITHUB_AW_AGENT_OUTPUT;if(!agentOutputFile)return void core.info("No GITHUB_AW_AGENT_OUTPUT environment variable found");let outputContent,validatedOutput;try{outputContent=fs.readFileSync(agentOutputFile,"utf8")}catch(error){return void core.setFailed(`Error reading agent output file: ${error instanceof Error?error.message:String(error)}`)}if(""===outputContent.trim())return void core.info("Agent output content is empty");core.info(`Agent output content length: ${outputContent.length}`);try{validatedOutput=JSON.parse(outputContent)}catch(error){return void core.setFailed(`Error parsing agent output JSON: ${error instanceof Error?error.message:String(error)}`)}if(!validatedOutput.items||!Array.isArray(validatedOutput.items))return void core.info("No valid items found in agent output");const createAgentTaskItems=validatedOutput.items.filter(item=>"create_agent_task"===item.type);if(0===createAgentTaskItems.length)return void core.info("No create-agent-task items found in agent output");if(core.info(`Found ${createAgentTaskItems.length} create-agent-task item(s)`),isStaged){let summaryContent="## ðŸŽ­ Staged Mode: Create Agent Tasks Preview\n\n";summaryContent+="The following agent tasks would be created if staged mode was disabled:\n\n";for(const[index,item]of createAgentTaskItems.entries())summaryContent+=`### Task ${index+1}\n\n`,summaryContent+=`**Description:**\n${item.body||"No description provided"}\n\n`,summaryContent+=`**Base Branch:** ${process.env.GITHUB_AW_AGENT_TASK_BASE||"main"}\n\n`,summaryContent+=`**Target Repository:** ${process.env.GITHUB_AW_TARGET_REPO||process.env.GITHUB_REPOSITORY||"unknown"}\n\n`,summaryContent+="---\n\n";return core.info(summaryContent),core.summary.addRaw(summaryContent),void await core.summary.write()}const baseBranch=process.env.GITHUB_AW_AGENT_TASK_BASE||process.env.GITHUB_REF_NAME||"main",targetRepo=process.env.GITHUB_AW_TARGET_REPO,createdTasks=[];let summaryContent="## âœ… Agent Tasks Created\n\n";for(const[index,taskItem]of createAgentTaskItems.entries()){const taskDescription=taskItem.body;if(taskDescription&&""!==taskDescription.trim())try{const tmpDir="/tmp/gh-aw";fs.existsSync(tmpDir)||fs.mkdirSync(tmpDir,{recursive:!0});const taskFile=path.join(tmpDir,`agent-task-description-${index+1}.md`);fs.writeFileSync(taskFile,taskDescription,"utf8"),core.info(`Task ${index+1}: Task description written to ${taskFile}`);const ghArgs=["agent-task","create","--from-file",taskFile,"--base",baseBranch];let taskOutput;targetRepo&&ghArgs.push("--repo",targetRepo),core.info(`Task ${index+1}: Creating agent task with command: gh ${ghArgs.join(" ")}`);try{taskOutput=await exec.getExecOutput("gh",ghArgs,{silent:!1,ignoreReturnCode:!1})}catch(execError){const errorMessage=execError instanceof Error?execError.message:String(execError);errorMessage.includes("authentication")||errorMessage.includes("permission")||errorMessage.includes("forbidden")||errorMessage.includes("401")||errorMessage.includes("403")?(core.error(`Task ${index+1}: Failed to create agent task due to authentication/permission error.`),core.error("The default GITHUB_TOKEN does not have permission to create agent tasks."),core.error("You must configure a Personal Access Token (PAT) as COPILOT_GITHUB_TOKEN or GH_AW_GITHUB_TOKEN."),core.error("See documentation: https://githubnext.github.io/gh-aw/reference/safe-outputs/#agent-task-creation-create-agent-task")):core.error(`Task ${index+1}: Failed to create agent task: ${errorMessage}`);continue}const output=taskOutput.stdout.trim();core.info(`Task ${index+1}: Agent task created: ${output}`);const urlMatch=output.match(/github\.com\/[^/]+\/[^/]+\/issues\/(\d+)/);if(urlMatch){const taskNumber=urlMatch[1];createdTasks.push({number:taskNumber,url:output}),summaryContent+=`### Task ${index+1}\n\n`,summaryContent+=`**Task:** [#${taskNumber}](${output})\n\n`,summaryContent+=`**Base Branch:** ${baseBranch}\n\n`,core.info(`âœ… Successfully created agent task #${taskNumber}`)}else core.warning(`Task ${index+1}: Could not parse task number from output: ${output}`),createdTasks.push({number:"",url:output})}catch(error){core.error(`Task ${index+1}: Error creating agent task: ${error instanceof Error?error.message:String(error)}`)}else core.warning(`Task ${index+1}: Agent task description is empty, skipping`)}createdTasks.length>0?(core.setOutput("task_number",createdTasks[0].number),core.setOutput("task_url",createdTasks[0].url),core.info(summaryContent),core.summary.addRaw(summaryContent),await core.summary.write()):core.setFailed("No agent tasks were created")}main().catch(error=>{core.setFailed(error instanceof Error?error.message:String(error))});