import{describe,it,expect,beforeEach,afterEach,vi}from"vitest";import fs from"fs";import path from"path";import{loadConfig}from"./safe_outputs_config.cjs";describe("safe_outputs_config",()=>{let mockServer,testConfigPath,testOutputPath;beforeEach(()=>{mockServer={debug:vi.fn()};const testId=Math.random().toString(36).substring(7);testConfigPath=`/tmp/test-safe-outputs-config-${testId}/config.json`,testOutputPath=`/tmp/test-safe-outputs-config-${testId}/outputs.jsonl`,process.env.GH_AW_SAFE_OUTPUTS_CONFIG_PATH=testConfigPath,process.env.GH_AW_SAFE_OUTPUTS=testOutputPath}),afterEach(()=>{try{fs.existsSync(testConfigPath)&&fs.unlinkSync(testConfigPath);const testDir=path.dirname(testConfigPath);fs.existsSync(testDir)&&fs.rmdirSync(testDir,{recursive:!0})}catch(error){}delete process.env.GH_AW_SAFE_OUTPUTS_CONFIG_PATH,delete process.env.GH_AW_SAFE_OUTPUTS}),describe("loadConfig",()=>{it("should load and parse valid config file",()=>{const configDir=path.dirname(testConfigPath);fs.mkdirSync(configDir,{recursive:!0}),fs.writeFileSync(testConfigPath,JSON.stringify({"create-pull-request":!0,"upload-assets":{maxSize:1024}}));const result=loadConfig(mockServer);expect(result.config).toEqual({create_pull_request:!0,upload_assets:{maxSize:1024}}),expect(result.outputFile).toBe(testOutputPath),expect(mockServer.debug).toHaveBeenCalled()}),it("should handle missing config file",()=>{const result=loadConfig(mockServer);expect(result.config).toEqual({}),expect(result.outputFile).toBe(testOutputPath),expect(mockServer.debug).toHaveBeenCalledWith(expect.stringContaining("does not exist"))}),it("should handle invalid JSON in config file",()=>{const configDir=path.dirname(testConfigPath);fs.mkdirSync(configDir,{recursive:!0}),fs.writeFileSync(testConfigPath,"{ invalid json }");const result=loadConfig(mockServer);expect(result.config).toEqual({}),expect(mockServer.debug).toHaveBeenCalledWith(expect.stringContaining("Error reading config file"))}),it("should normalize dashes to underscores in config keys",()=>{const configDir=path.dirname(testConfigPath);fs.mkdirSync(configDir,{recursive:!0}),fs.writeFileSync(testConfigPath,JSON.stringify({"create-pull-request":!0,"push-to-pull-request-branch":!0,"upload-assets":!0}));const result=loadConfig(mockServer);expect(result.config).toEqual({create_pull_request:!0,push_to_pull_request_branch:!0,upload_assets:!0})}),it("should use default output path when env var not set",()=>{delete process.env.GH_AW_SAFE_OUTPUTS;const configDir=path.dirname(testConfigPath);fs.mkdirSync(configDir,{recursive:!0}),fs.writeFileSync(testConfigPath,JSON.stringify({}));const result=loadConfig(mockServer);expect(result.outputFile).toBe("/tmp/gh-aw/safeoutputs/outputs.jsonl"),expect(mockServer.debug).toHaveBeenCalledWith(expect.stringContaining("GH_AW_SAFE_OUTPUTS not set"))}),it("should create output directory if it doesn't exist",()=>{const customOutputPath=`/tmp/test-safe-outputs-config-${Date.now()}/custom/path/outputs.jsonl`;process.env.GH_AW_SAFE_OUTPUTS=customOutputPath;const configDir=path.dirname(testConfigPath);fs.mkdirSync(configDir,{recursive:!0}),fs.writeFileSync(testConfigPath,JSON.stringify({}));const outputDir=path.dirname(customOutputPath);expect(fs.existsSync(outputDir)).toBe(!1),loadConfig(mockServer),expect(fs.existsSync(outputDir)).toBe(!0),fs.rmdirSync(outputDir,{recursive:!0})}),it("should handle empty config file",()=>{const configDir=path.dirname(testConfigPath);fs.mkdirSync(configDir,{recursive:!0}),fs.writeFileSync(testConfigPath,JSON.stringify({}));const result=loadConfig(mockServer);expect(result.config).toEqual({}),expect(result.outputFile).toBe(testOutputPath)}),it("should log config file details during loading",()=>{const configDir=path.dirname(testConfigPath);fs.mkdirSync(configDir,{recursive:!0}),fs.writeFileSync(testConfigPath,JSON.stringify({"test-tool":!0})),loadConfig(mockServer),expect(mockServer.debug).toHaveBeenCalledWith(expect.stringContaining("Reading config from file")),expect(mockServer.debug).toHaveBeenCalledWith(expect.stringContaining("Config file exists")),expect(mockServer.debug).toHaveBeenCalledWith(expect.stringContaining("Successfully parsed config")),expect(mockServer.debug).toHaveBeenCalledWith(expect.stringContaining("Final processed config"))})})});