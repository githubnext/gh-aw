import{describe,it,expect,beforeEach,vi}from"vitest";const mockCore={warning:vi.fn(),info:vi.fn(),error:vi.fn()};global.core=mockCore;const SAMPLE_VALIDATION_CONFIG={create_issue:{defaultMax:1,fields:{title:{required:!0,type:"string",sanitize:!0,maxLength:128},body:{required:!0,type:"string",sanitize:!0,maxLength:65e3},labels:{type:"array",itemType:"string",itemSanitize:!0,itemMaxLength:128},parent:{issueOrPRNumber:!0},temporary_id:{type:"string"}}},add_comment:{defaultMax:1,fields:{body:{required:!0,type:"string",sanitize:!0,maxLength:65e3},item_number:{issueOrPRNumber:!0}}},create_pull_request:{defaultMax:1,fields:{title:{required:!0,type:"string",sanitize:!0,maxLength:128},body:{required:!0,type:"string",sanitize:!0,maxLength:65e3},branch:{required:!0,type:"string",sanitize:!0,maxLength:256},labels:{type:"array",itemType:"string",itemSanitize:!0,itemMaxLength:128}}},update_issue:{defaultMax:1,customValidation:"requiresOneOf:status,title,body",fields:{status:{type:"string",enum:["open","closed"]},title:{type:"string",sanitize:!0,maxLength:128},body:{type:"string",sanitize:!0,maxLength:65e3},issue_number:{issueOrPRNumber:!0}}},create_pull_request_review_comment:{defaultMax:1,customValidation:"startLineLessOrEqualLine",fields:{path:{required:!0,type:"string"},line:{required:!0,positiveInteger:!0},body:{required:!0,type:"string",sanitize:!0,maxLength:65e3},start_line:{optionalPositiveInteger:!0},side:{type:"string",enum:["LEFT","RIGHT"]}}},link_sub_issue:{defaultMax:5,customValidation:"parentAndSubDifferent",fields:{parent_issue_number:{required:!0,issueNumberOrTemporaryId:!0},sub_issue_number:{required:!0,issueNumberOrTemporaryId:!0}}},noop:{defaultMax:1,fields:{message:{required:!0,type:"string",sanitize:!0,maxLength:65e3}}},missing_tool:{defaultMax:20,fields:{tool:{required:!0,type:"string",sanitize:!0,maxLength:128},reason:{required:!0,type:"string",sanitize:!0,maxLength:256},alternatives:{type:"string",sanitize:!0,maxLength:512}}},create_code_scanning_alert:{defaultMax:40,fields:{file:{required:!0,type:"string",sanitize:!0,maxLength:512},line:{required:!0,positiveInteger:!0},severity:{required:!0,type:"string",enum:["error","warning","info","note"]},message:{required:!0,type:"string",sanitize:!0,maxLength:2048},column:{optionalPositiveInteger:!0},ruleIdSuffix:{type:"string",pattern:"^[a-zA-Z0-9_-]+$",patternError:"must contain only alphanumeric characters, hyphens, and underscores",sanitize:!0,maxLength:128}}}};describe("safe_output_type_validator",()=>{beforeEach(async()=>{vi.clearAllMocks();const{resetValidationConfigCache}=await import("./safe_output_type_validator.cjs");resetValidationConfigCache(),process.env.GH_AW_VALIDATION_CONFIG=JSON.stringify(SAMPLE_VALIDATION_CONFIG)}),describe("loadValidationConfig",()=>{it("should load config from environment variable",async()=>{const{loadValidationConfig}=await import("./safe_output_type_validator.cjs"),config=loadValidationConfig();expect(config).toBeDefined(),expect(config.create_issue).toBeDefined(),expect(config.create_issue.defaultMax).toBe(1)}),it("should return empty config when env var is not set",async()=>{delete process.env.GH_AW_VALIDATION_CONFIG;const{loadValidationConfig,resetValidationConfigCache}=await import("./safe_output_type_validator.cjs");resetValidationConfigCache();const config=loadValidationConfig();expect(config).toEqual({})}),it("should return empty config on invalid JSON",async()=>{process.env.GH_AW_VALIDATION_CONFIG="invalid json";const{loadValidationConfig,resetValidationConfigCache}=await import("./safe_output_type_validator.cjs");resetValidationConfigCache();const config=loadValidationConfig();expect(config).toEqual({}),expect(mockCore.error).toHaveBeenCalled()})}),describe("validateItem",()=>{it("should validate create_issue with all required fields",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"create_issue",title:"Test Issue",body:"Test body"},"create_issue",1);expect(result.isValid).toBe(!0),expect(result.normalizedItem).toBeDefined()}),it("should fail validation when required title is missing",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"create_issue",body:"Test body"},"create_issue",1);expect(result.isValid).toBe(!1),expect(result.error).toContain("title")}),it("should fail validation when required body is missing",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"create_issue",title:"Test title"},"create_issue",1);expect(result.isValid).toBe(!1),expect(result.error).toContain("body")}),it("should sanitize string fields",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"create_issue",title:"Test @mention Issue",body:"Test body"},"create_issue",1);expect(result.isValid).toBe(!0),expect(result.normalizedItem.title).toContain("`@mention`")})}),describe("validatePositiveInteger",()=>{it("should validate positive integer",async()=>{const{validatePositiveInteger}=await import("./safe_output_type_validator.cjs"),result=validatePositiveInteger(42,"line",1);expect(result.isValid).toBe(!0),expect(result.normalizedValue).toBe(42)}),it("should reject negative numbers",async()=>{const{validatePositiveInteger}=await import("./safe_output_type_validator.cjs"),result=validatePositiveInteger(-1,"line",1);expect(result.isValid).toBe(!1)}),it("should reject zero",async()=>{const{validatePositiveInteger}=await import("./safe_output_type_validator.cjs"),result=validatePositiveInteger(0,"line",1);expect(result.isValid).toBe(!1)}),it("should parse string numbers",async()=>{const{validatePositiveInteger}=await import("./safe_output_type_validator.cjs"),result=validatePositiveInteger("42","line",1);expect(result.isValid).toBe(!0),expect(result.normalizedValue).toBe(42)})}),describe("validateOptionalPositiveInteger",()=>{it("should accept undefined",async()=>{const{validateOptionalPositiveInteger}=await import("./safe_output_type_validator.cjs"),result=validateOptionalPositiveInteger(void 0,"column",1);expect(result.isValid).toBe(!0)}),it("should validate positive integer when provided",async()=>{const{validateOptionalPositiveInteger}=await import("./safe_output_type_validator.cjs"),result=validateOptionalPositiveInteger(5,"column",1);expect(result.isValid).toBe(!0),expect(result.normalizedValue).toBe(5)}),it("should reject zero when provided",async()=>{const{validateOptionalPositiveInteger}=await import("./safe_output_type_validator.cjs"),result=validateOptionalPositiveInteger(0,"column",1);expect(result.isValid).toBe(!1)})}),describe("validateIssueOrPRNumber",()=>{it("should accept undefined",async()=>{const{validateIssueOrPRNumber}=await import("./safe_output_type_validator.cjs"),result=validateIssueOrPRNumber(void 0,"item_number",1);expect(result.isValid).toBe(!0)}),it("should accept number",async()=>{const{validateIssueOrPRNumber}=await import("./safe_output_type_validator.cjs"),result=validateIssueOrPRNumber(123,"item_number",1);expect(result.isValid).toBe(!0)}),it("should accept string",async()=>{const{validateIssueOrPRNumber}=await import("./safe_output_type_validator.cjs"),result=validateIssueOrPRNumber("456","item_number",1);expect(result.isValid).toBe(!0)})}),describe("validateIssueNumberOrTemporaryId",()=>{it("should accept positive integer",async()=>{const{validateIssueNumberOrTemporaryId}=await import("./safe_output_type_validator.cjs"),result=validateIssueNumberOrTemporaryId(123,"issue_number",1);expect(result.isValid).toBe(!0),expect(result.normalizedValue).toBe(123),expect(result.isTemporary).toBe(!1)}),it("should accept temporary ID",async()=>{const{validateIssueNumberOrTemporaryId}=await import("./safe_output_type_validator.cjs"),result=validateIssueNumberOrTemporaryId("aw_abc123def456","issue_number",1);expect(result.isValid).toBe(!0),expect(result.isTemporary).toBe(!0),expect(result.normalizedValue).toBe("aw_abc123def456")}),it("should reject invalid values",async()=>{const{validateIssueNumberOrTemporaryId}=await import("./safe_output_type_validator.cjs"),result=validateIssueNumberOrTemporaryId(-1,"issue_number",1);expect(result.isValid).toBe(!1)})}),describe("getMaxAllowedForType",()=>{it("should return defaultMax from config",async()=>{const{getMaxAllowedForType}=await import("./safe_output_type_validator.cjs"),max=getMaxAllowedForType("create_issue");expect(max).toBe(1)}),it("should return overridden max from config",async()=>{const{getMaxAllowedForType}=await import("./safe_output_type_validator.cjs"),max=getMaxAllowedForType("create_issue",{create_issue:{max:5}});expect(max).toBe(5)}),it("should return 1 for unknown type",async()=>{const{getMaxAllowedForType}=await import("./safe_output_type_validator.cjs"),max=getMaxAllowedForType("unknown_type");expect(max).toBe(1)})}),describe("hasValidationConfig",()=>{it("should return true for known type",async()=>{const{hasValidationConfig}=await import("./safe_output_type_validator.cjs");expect(hasValidationConfig("create_issue")).toBe(!0)}),it("should return false for unknown type",async()=>{const{hasValidationConfig}=await import("./safe_output_type_validator.cjs");expect(hasValidationConfig("unknown_type")).toBe(!1)})}),describe("custom validation: requiresOneOf",()=>{it("should pass when at least one field is present",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"update_issue",status:"open"},"update_issue",1);expect(result.isValid).toBe(!0)}),it("should fail when none of the required fields are present",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"update_issue"},"update_issue",1);expect(result.isValid).toBe(!1),expect(result.error).toContain("requires at least one of")})}),describe("custom validation: startLineLessOrEqualLine",()=>{it("should pass when start_line <= line",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"create_pull_request_review_comment",path:"test.js",line:10,start_line:5,body:"Test comment"},"create_pull_request_review_comment",1);expect(result.isValid).toBe(!0)}),it("should fail when start_line > line",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"create_pull_request_review_comment",path:"test.js",line:5,start_line:10,body:"Test comment"},"create_pull_request_review_comment",1);expect(result.isValid).toBe(!1),expect(result.error).toContain("start_line")})}),describe("custom validation: parentAndSubDifferent",()=>{it("should pass when parent and sub are different",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"link_sub_issue",parent_issue_number:1,sub_issue_number:2},"link_sub_issue",1);expect(result.isValid).toBe(!0)}),it("should fail when parent and sub are the same",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"link_sub_issue",parent_issue_number:1,sub_issue_number:1},"link_sub_issue",1);expect(result.isValid).toBe(!1),expect(result.error).toContain("must be different")})}),describe("enum validation",()=>{it("should validate enum values (case-insensitive)",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"update_issue",status:"OPEN"},"update_issue",1);expect(result.isValid).toBe(!0),expect(result.normalizedItem.status).toBe("open")}),it("should reject invalid enum value",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"update_issue",status:"invalid"},"update_issue",1);expect(result.isValid).toBe(!1),expect(result.error).toContain("must be 'open' or 'closed'")})}),describe("pattern validation",()=>{it("should validate pattern match",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"create_code_scanning_alert",file:"test.js",line:10,severity:"warning",message:"Test",ruleIdSuffix:"test-rule-123"},"create_code_scanning_alert",1);expect(result.isValid).toBe(!0)}),it("should reject pattern mismatch with custom error",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"create_code_scanning_alert",file:"test.js",line:10,severity:"warning",message:"Test",ruleIdSuffix:"test rule!"},"create_code_scanning_alert",1);expect(result.isValid).toBe(!1),expect(result.error).toContain("must contain only alphanumeric characters, hyphens, and underscores")})}),describe("array validation",()=>{it("should validate array of strings",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"create_issue",title:"Test",body:"Body",labels:["bug","enhancement"]},"create_issue",1);expect(result.isValid).toBe(!0),expect(Array.isArray(result.normalizedItem.labels)).toBe(!0)}),it("should reject array with non-string items",async()=>{const{validateItem}=await import("./safe_output_type_validator.cjs"),result=validateItem({type:"create_issue",title:"Test",body:"Body",labels:["bug",123]},"create_issue",1);expect(result.isValid).toBe(!1),expect(result.error).toContain("must contain only strings")})})});