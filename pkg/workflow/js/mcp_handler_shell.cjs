const fs=require("fs"),path=require("path"),{execFile}=require("child_process"),os=require("os");function createShellHandler(server,toolName,scriptPath,timeoutSeconds=60){return async args=>{server.debug(`  [${toolName}] Invoking shell handler: ${scriptPath}`),server.debug(`  [${toolName}] Shell handler args: ${JSON.stringify(args)}`),server.debug(`  [${toolName}] Timeout: ${timeoutSeconds}s`);const env={...process.env};for(const[key,value]of Object.entries(args||{})){const envKey=`INPUT_${key.toUpperCase().replace(/-/g,"_")}`;env[envKey]=String(value),server.debug(`  [${toolName}] Set env: ${envKey}=${String(value).substring(0,100)}${String(value).length>100?"...":""}`)}const outputFile=path.join(os.tmpdir(),`mcp-shell-output-${Date.now()}-${Math.random().toString(36).substring(2)}.txt`);return env.GITHUB_OUTPUT=outputFile,server.debug(`  [${toolName}] Output file: ${outputFile}`),fs.writeFileSync(outputFile,""),new Promise((resolve,reject)=>{server.debug(`  [${toolName}] Executing shell script...`),execFile(scriptPath,[],{env,timeout:1e3*timeoutSeconds,maxBuffer:10485760},(error,stdout,stderr)=>{if(stdout&&server.debug(`  [${toolName}] stdout: ${stdout.substring(0,500)}${stdout.length>500?"...":""}`),stderr&&server.debug(`  [${toolName}] stderr: ${stderr.substring(0,500)}${stderr.length>500?"...":""}`),error){server.debugError(`  [${toolName}] Shell script error: `,error);try{fs.existsSync(outputFile)&&fs.unlinkSync(outputFile)}catch{}return void reject(error)}const outputs={};try{if(fs.existsSync(outputFile)){const outputContent=fs.readFileSync(outputFile,"utf-8");server.debug(`  [${toolName}] Output file content: ${outputContent.substring(0,500)}${outputContent.length>500?"...":""}`);const lines=outputContent.split("\n");for(const line of lines){const trimmed=line.trim();if(trimmed&&trimmed.includes("=")){const eqIndex=trimmed.indexOf("="),key=trimmed.substring(0,eqIndex),value=trimmed.substring(eqIndex+1);outputs[key]=value,server.debug(`  [${toolName}] Parsed output: ${key}=${value.substring(0,100)}${value.length>100?"...":""}`)}}}}catch(readError){server.debugError(`  [${toolName}] Error reading output file: `,readError)}try{fs.existsSync(outputFile)&&fs.unlinkSync(outputFile)}catch{}const result={stdout:stdout||"",stderr:stderr||"",outputs};server.debug(`  [${toolName}] Shell handler completed, outputs: ${Object.keys(outputs).join(", ")||"(none)"}`),resolve({content:[{type:"text",text:JSON.stringify(result)}]})})})}}module.exports={createShellHandler};