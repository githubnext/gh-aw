const fs=require("fs"),path=require("path"),os=require("os"),assert=require("assert"),{bootstrapSafeOutputsServer,cleanupConfigFile}=require("./safe_outputs_bootstrap.cjs");describe("safe_outputs_bootstrap",()=>{let tempDir;beforeEach(()=>{tempDir=fs.mkdtempSync(path.join(os.tmpdir(),"test-safe-outputs-bootstrap-"))}),afterEach(()=>{tempDir&&fs.existsSync(tempDir)&&fs.rmSync(tempDir,{recursive:!0,force:!0}),delete process.env.GH_AW_SAFE_OUTPUTS_CONFIG_PATH,delete process.env.GH_AW_SAFE_OUTPUTS_TOOLS_PATH,delete process.env.GH_AW_SAFE_OUTPUTS}),describe("bootstrapSafeOutputsServer",()=>{it("should load configuration and tools successfully",()=>{const configPath=path.join(tempDir,"config.json"),toolsPath=path.join(tempDir,"tools.json");fs.writeFileSync(configPath,JSON.stringify({"create-pull-request":{enabled:!0}})),fs.writeFileSync(toolsPath,JSON.stringify([{name:"create_pull_request",description:"Test tool"}])),process.env.GH_AW_SAFE_OUTPUTS_CONFIG_PATH=configPath,process.env.GH_AW_SAFE_OUTPUTS_TOOLS_PATH=toolsPath,process.env.GH_AW_SAFE_OUTPUTS=path.join(tempDir,"outputs.jsonl");const result=bootstrapSafeOutputsServer({debug:()=>{},debugError:()=>{}});assert.ok(result.config),assert.strictEqual(result.config.create_pull_request.enabled,!0),assert.ok(result.tools),assert.strictEqual(result.tools.length,1),assert.strictEqual(result.tools[0].name,"create_pull_request"),assert.ok(result.outputFile),assert.strictEqual(result.outputFile,path.join(tempDir,"outputs.jsonl"))}),it("should handle missing configuration file gracefully",()=>{const toolsPath=path.join(tempDir,"tools.json");fs.writeFileSync(toolsPath,JSON.stringify([])),process.env.GH_AW_SAFE_OUTPUTS_CONFIG_PATH=path.join(tempDir,"nonexistent.json"),process.env.GH_AW_SAFE_OUTPUTS_TOOLS_PATH=toolsPath,process.env.GH_AW_SAFE_OUTPUTS=path.join(tempDir,"outputs.jsonl");const result=bootstrapSafeOutputsServer({debug:()=>{},debugError:()=>{}});assert.ok(result.config),assert.strictEqual(Object.keys(result.config).length,0)}),it("should handle missing tools file gracefully",()=>{const configPath=path.join(tempDir,"config.json");fs.writeFileSync(configPath,JSON.stringify({})),process.env.GH_AW_SAFE_OUTPUTS_CONFIG_PATH=configPath,process.env.GH_AW_SAFE_OUTPUTS_TOOLS_PATH=path.join(tempDir,"nonexistent.json"),process.env.GH_AW_SAFE_OUTPUTS=path.join(tempDir,"outputs.jsonl");const result=bootstrapSafeOutputsServer({debug:()=>{},debugError:()=>{}});assert.ok(result.tools),assert.strictEqual(result.tools.length,0)})}),describe("cleanupConfigFile",()=>{it("should delete config file if it exists",()=>{const configPath=path.join(tempDir,"config.json");fs.writeFileSync(configPath,JSON.stringify({})),process.env.GH_AW_SAFE_OUTPUTS_CONFIG_PATH=configPath,assert.ok(fs.existsSync(configPath)),cleanupConfigFile({debug:()=>{},debugError:()=>{}}),assert.ok(!fs.existsSync(configPath))}),it("should handle missing config file gracefully",()=>{const configPath=path.join(tempDir,"nonexistent.json");process.env.GH_AW_SAFE_OUTPUTS_CONFIG_PATH=configPath;const logger={debug:()=>{},debugError:()=>{}};assert.doesNotThrow(()=>{cleanupConfigFile(logger)})})})});