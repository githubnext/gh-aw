function extractMentions(text){if(!text||"string"!=typeof text)return[];const mentionRegex=/(^|[^\w`])@([A-Za-z0-9](?:[A-Za-z0-9-]{0,37}[A-Za-z0-9])?(?:\/[A-Za-z0-9._-]+)?)/g,mentions=[],seen=new Set;let match;for(;null!==(match=mentionRegex.exec(text));){const username=match[2],lowercaseUsername=username.toLowerCase();seen.has(lowercaseUsername)||(seen.add(lowercaseUsername),mentions.push(username))}return mentions}function isPayloadUserBot(user){return!(!user||"Bot"!==user.type)}async function getRecentCollaborators(owner,repo,github,core){try{const collaborators=await github.rest.repos.listCollaborators({owner,repo,affiliation:"direct",per_page:30}),allowedMap=new Map;for(const collaborator of collaborators.data){const lowercaseLogin=collaborator.login.toLowerCase(),isAllowed="Bot"!==collaborator.type;allowedMap.set(lowercaseLogin,isAllowed)}return allowedMap}catch(error){return core.warning(`Failed to fetch recent collaborators: ${error instanceof Error?error.message:String(error)}`),new Map}}async function checkUserPermission(username,owner,repo,github,core){try{const{data:user}=await github.rest.users.getByUsername({username});if("Bot"===user.type)return!1;const{data:permissionData}=await github.rest.repos.getCollaboratorPermissionLevel({owner,repo,username});return"none"!==permissionData.permission}catch(error){return!1}}async function resolveMentionsLazily(text,knownAuthors,owner,repo,github,core){const mentions=extractMentions(text),totalMentions=mentions.length;core.info(`Found ${totalMentions} unique mentions in text`);const limitExceeded=totalMentions>50,mentionsToProcess=limitExceeded?mentions.slice(0,50):mentions;limitExceeded&&core.warning(`Mention limit exceeded: ${totalMentions} mentions found, processing only first 50`);const knownAuthorsLowercase=new Set(knownAuthors.filter(a=>a).map(a=>a.toLowerCase())),collaboratorCache=await getRecentCollaborators(owner,repo,github,core);core.info(`Cached ${collaboratorCache.size} recent collaborators for optimistic resolution`);const allowedMentions=[];let resolvedCount=0;for(const mention of mentionsToProcess){const lowerMention=mention.toLowerCase();knownAuthorsLowercase.has(lowerMention)?allowedMentions.push(mention):collaboratorCache.has(lowerMention)?collaboratorCache.get(lowerMention)&&allowedMentions.push(mention):(resolvedCount++,await checkUserPermission(mention,owner,repo,github,core)&&allowedMentions.push(mention))}return core.info(`Resolved ${resolvedCount} mentions via individual API calls`),core.info(`Total allowed mentions: ${allowedMentions.length}`),{allowedMentions,totalMentions,resolvedCount,limitExceeded}}module.exports={extractMentions,isPayloadUserBot,getRecentCollaborators,checkUserPermission,resolveMentionsLazily};