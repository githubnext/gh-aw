const{resolveMentionsLazily,isPayloadUserBot}=require("./resolve_mentions.cjs");async function resolveAllowedMentionsFromPayload(context,github,core,mentionsConfig){if(!context||!github||!core)return[];if(mentionsConfig&&!1===mentionsConfig.enabled)return core.info("[MENTIONS] Mentions explicitly disabled - all mentions will be escaped"),[];mentionsConfig&&mentionsConfig.enabled;const allowTeamMembers=!1!==mentionsConfig?.allowTeamMembers,allowContext=!1!==mentionsConfig?.allowContext,allowedList=mentionsConfig?.allowed||[],maxMentions=mentionsConfig?.max||50;try{const{owner,repo}=context.repo,knownAuthors=[];if(allowContext)switch(context.eventName){case"issues":if(context.payload.issue?.user?.login&&!isPayloadUserBot(context.payload.issue.user)&&knownAuthors.push(context.payload.issue.user.login),context.payload.issue?.assignees&&Array.isArray(context.payload.issue.assignees))for(const assignee of context.payload.issue.assignees)assignee?.login&&!isPayloadUserBot(assignee)&&knownAuthors.push(assignee.login);break;case"pull_request":case"pull_request_target":if(context.payload.pull_request?.user?.login&&!isPayloadUserBot(context.payload.pull_request.user)&&knownAuthors.push(context.payload.pull_request.user.login),context.payload.pull_request?.assignees&&Array.isArray(context.payload.pull_request.assignees))for(const assignee of context.payload.pull_request.assignees)assignee?.login&&!isPayloadUserBot(assignee)&&knownAuthors.push(assignee.login);break;case"issue_comment":if(context.payload.comment?.user?.login&&!isPayloadUserBot(context.payload.comment.user)&&knownAuthors.push(context.payload.comment.user.login),context.payload.issue?.user?.login&&!isPayloadUserBot(context.payload.issue.user)&&knownAuthors.push(context.payload.issue.user.login),context.payload.issue?.assignees&&Array.isArray(context.payload.issue.assignees))for(const assignee of context.payload.issue.assignees)assignee?.login&&!isPayloadUserBot(assignee)&&knownAuthors.push(assignee.login);break;case"pull_request_review_comment":if(context.payload.comment?.user?.login&&!isPayloadUserBot(context.payload.comment.user)&&knownAuthors.push(context.payload.comment.user.login),context.payload.pull_request?.user?.login&&!isPayloadUserBot(context.payload.pull_request.user)&&knownAuthors.push(context.payload.pull_request.user.login),context.payload.pull_request?.assignees&&Array.isArray(context.payload.pull_request.assignees))for(const assignee of context.payload.pull_request.assignees)assignee?.login&&!isPayloadUserBot(assignee)&&knownAuthors.push(assignee.login);break;case"pull_request_review":if(context.payload.review?.user?.login&&!isPayloadUserBot(context.payload.review.user)&&knownAuthors.push(context.payload.review.user.login),context.payload.pull_request?.user?.login&&!isPayloadUserBot(context.payload.pull_request.user)&&knownAuthors.push(context.payload.pull_request.user.login),context.payload.pull_request?.assignees&&Array.isArray(context.payload.pull_request.assignees))for(const assignee of context.payload.pull_request.assignees)assignee?.login&&!isPayloadUserBot(assignee)&&knownAuthors.push(assignee.login);break;case"discussion":context.payload.discussion?.user?.login&&!isPayloadUserBot(context.payload.discussion.user)&&knownAuthors.push(context.payload.discussion.user.login);break;case"discussion_comment":context.payload.comment?.user?.login&&!isPayloadUserBot(context.payload.comment.user)&&knownAuthors.push(context.payload.comment.user.login),context.payload.discussion?.user?.login&&!isPayloadUserBot(context.payload.discussion.user)&&knownAuthors.push(context.payload.discussion.user.login);break;case"release":context.payload.release?.author?.login&&!isPayloadUserBot(context.payload.release.author)&&knownAuthors.push(context.payload.release.author.login);break;case"workflow_dispatch":knownAuthors.push(context.actor)}if(knownAuthors.push(...allowedList),!allowTeamMembers){core.info(`[MENTIONS] Team members disabled - only allowing context (${knownAuthors.length} users)`);const limitedMentions=knownAuthors.slice(0,maxMentions);return knownAuthors.length>maxMentions&&core.warning(`[MENTIONS] Mention limit exceeded: ${knownAuthors.length} mentions, limiting to ${maxMentions}`),limitedMentions}const fakeText=knownAuthors.map(author=>`@${author}`).join(" ");let allowedMentions=(await resolveMentionsLazily(fakeText,knownAuthors,owner,repo,github,core)).allowedMentions;return allowedMentions.length>maxMentions&&(core.warning(`[MENTIONS] Mention limit exceeded: ${allowedMentions.length} mentions, limiting to ${maxMentions}`),allowedMentions=allowedMentions.slice(0,maxMentions)),allowedMentions.length>0?core.info(`[OUTPUT COLLECTOR] Allowed mentions: ${allowedMentions.join(", ")}`):core.info("[OUTPUT COLLECTOR] No allowed mentions - all mentions will be escaped"),allowedMentions}catch(error){return core.warning(`Failed to resolve mentions for output collector: ${error instanceof Error?error.message:String(error)}`),[]}}module.exports={resolveAllowedMentionsFromPayload};