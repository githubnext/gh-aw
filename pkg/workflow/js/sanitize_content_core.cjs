const redactedDomains=[];function getRedactedDomains(){return[...redactedDomains]}function addRedactedDomain(domain){redactedDomains.push(domain)}function clearRedactedDomains(){redactedDomains.length=0}function writeRedactedDomainsLog(filePath){if(0===redactedDomains.length)return null;const fs=require("fs"),targetPath=filePath||"/tmp/gh-aw/redacted-urls.log",dir=require("path").dirname(targetPath);return fs.existsSync(dir)||fs.mkdirSync(dir,{recursive:!0}),fs.writeFileSync(targetPath,redactedDomains.join("\n")+"\n"),targetPath}function extractDomainsFromUrl(url){if(!url||"string"!=typeof url)return[];try{const hostname=new URL(url).hostname.toLowerCase(),domains=[hostname];return"github.com"===hostname?(domains.push("api.github.com"),domains.push("raw.githubusercontent.com"),domains.push("*.githubusercontent.com")):hostname.startsWith("api.")||(domains.push("api."+hostname),domains.push("raw."+hostname)),domains}catch(e){return[]}}function sanitizeContentCore(content,maxLength){if(!content||"string"!=typeof content)return"";const allowedDomainsEnv=process.env.GH_AW_ALLOWED_DOMAINS;let allowedDomains=allowedDomainsEnv?allowedDomainsEnv.split(",").map(d=>d.trim()).filter(d=>d):["github.com","github.io","githubusercontent.com","githubassets.com","github.dev","codespaces.new"];const githubServerUrl=process.env.GITHUB_SERVER_URL,githubApiUrl=process.env.GITHUB_API_URL;if(githubServerUrl){const serverDomains=extractDomainsFromUrl(githubServerUrl);allowedDomains=allowedDomains.concat(serverDomains)}if(githubApiUrl){const apiDomains=extractDomainsFromUrl(githubApiUrl);allowedDomains=allowedDomains.concat(apiDomains)}allowedDomains=[...new Set(allowedDomains)];let sanitized=content;sanitized=sanitized.replace(/\x1b\[[0-9;]*[mGKH]/g,""),sanitized=sanitized.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),sanitized=function(s){const commandName=process.env.GH_AW_COMMAND;if(!commandName)return s;const escapedCommand=commandName.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return s.replace(new RegExp(`^(\\s*)/(${escapedCommand})\\b`,"i"),"$1`/$2`")}(sanitized),sanitized=sanitized.replace(/(^|[^\w`])@([A-Za-z0-9](?:[A-Za-z0-9-]{0,37}[A-Za-z0-9])?(?:\/[A-Za-z0-9._-]+)?)/g,(m,p1,p2)=>("undefined"!=typeof core&&core.info&&core.info(`Escaped mention: @${p2} (not in allowed list)`),`${p1}\`@${p2}\``)),sanitized=sanitized.replace(/<!--[\s\S]*?-->/g,"").replace(/<!--[\s\S]*?--!>/g,""),sanitized=function(s){const allowedTags=["b","blockquote","br","code","details","em","h1","h2","h3","h4","h5","h6","hr","i","li","ol","p","pre","strong","sub","summary","sup","table","tbody","td","th","thead","tr","ul"];return s=s.replace(/<!\[CDATA\[([\s\S]*?)\]\]>/g,(match,content)=>`(![CDATA[${content.replace(/<(\/?[A-Za-z][A-Za-z0-9]*(?:[^>]*?))>/g,"($1)")}]])`),s.replace(/<(\/?[A-Za-z!][^>]*?)>/g,(match,tagContent)=>{const tagNameMatch=tagContent.match(/^\/?\s*([A-Za-z][A-Za-z0-9]*)/);if(tagNameMatch){const tagName=tagNameMatch[1].toLowerCase();if(allowedTags.includes(tagName))return match}return`(${tagContent})`})}(sanitized),sanitized=function(s){return s.replace(/((?:http|ftp|file|ssh|git):\/\/([\w.-]*)(?:[^\s]*)|(?:data|javascript|vbscript|about|mailto|tel):[^\s]+)/gi,(match,_fullMatch,domain)=>{if(domain){const domainLower=domain.toLowerCase(),truncated=domainLower.length>12?domainLower.substring(0,12)+"...":domainLower;"undefined"!=typeof core&&core.info&&core.info(`Redacted URL: ${truncated}`),"undefined"!=typeof core&&core.debug&&core.debug(`Redacted URL (full): ${match}`),addRedactedDomain(domainLower)}else{const protocolMatch=match.match(/^([^:]+):/);if(protocolMatch){const protocol=protocolMatch[1]+":",truncated=match.length>12?match.substring(0,12)+"...":match;"undefined"!=typeof core&&core.info&&core.info(`Redacted URL: ${truncated}`),"undefined"!=typeof core&&core.debug&&core.debug(`Redacted URL (full): ${match}`),addRedactedDomain(protocol)}}return"(redacted)"})}(sanitized),sanitized=function(s,allowed){return s.replace(/https:\/\/([\w.-]+(?::\d+)?)(\/(?:(?!https:\/\/)[^\s,])*)?/gi,(match,hostnameWithPort,pathPart)=>{const hostname=hostnameWithPort.split(":")[0].toLowerCase();if(pathPart=pathPart||"",allowed.some(allowedDomain=>{const normalizedAllowed=allowedDomain.toLowerCase();if(hostname===normalizedAllowed)return!0;if(normalizedAllowed.startsWith("*.")){const baseDomain=normalizedAllowed.substring(2);return hostname.endsWith("."+baseDomain)||hostname===baseDomain}return hostname.endsWith("."+normalizedAllowed)}))return match;{const truncated=hostname.length>12?hostname.substring(0,12)+"...":hostname;return"undefined"!=typeof core&&core.info&&core.info(`Redacted URL: ${truncated}`),"undefined"!=typeof core&&core.debug&&core.debug(`Redacted URL (full): ${match}`),addRedactedDomain(hostname),"(redacted)"}})}(sanitized,allowedDomains);const lines=sanitized.split("\n");if(maxLength=maxLength||524288,lines.length>65e3){const truncationMsg="\n[Content truncated due to line count]",truncatedLines=lines.slice(0,65e3).join("\n")+truncationMsg;sanitized=truncatedLines.length>maxLength?truncatedLines.substring(0,maxLength-truncationMsg.length)+truncationMsg:truncatedLines}else sanitized.length>maxLength&&(sanitized=sanitized.substring(0,maxLength)+"\n[Content truncated due to length]");return sanitized=function(s){return s.replace(/\b(fixes?|closes?|resolves?|fix|close|resolve)\s+#(\w+)/gi,(match,action,ref)=>`\`${action} #${ref}\``)}(sanitized),sanitized.trim()}module.exports={sanitizeContentCore,getRedactedDomains,addRedactedDomain,clearRedactedDomains,writeRedactedDomainsLog,extractDomainsFromUrl};