import{describe,it,expect,beforeEach,afterEach}from"vitest";import fs from"fs";import path from"path";import{createAppendFunction}from"./safe_outputs_append.cjs";describe("safe_outputs_append",()=>{let testOutputFile,appendFn;beforeEach(()=>{const testId=Math.random().toString(36).substring(7);testOutputFile=`/tmp/test-safe-outputs-append-${testId}/outputs.jsonl`;const outputDir=path.dirname(testOutputFile);fs.mkdirSync(outputDir,{recursive:!0}),appendFn=createAppendFunction(testOutputFile)}),afterEach(()=>{try{fs.existsSync(testOutputFile)&&fs.unlinkSync(testOutputFile);const testDir=path.dirname(testOutputFile);fs.existsSync(testDir)&&fs.rmdirSync(testDir,{recursive:!0})}catch(error){}}),describe("createAppendFunction",()=>{it("should append entry to output file",()=>{appendFn({type:"test-type",data:"test-data"});const lines=fs.readFileSync(testOutputFile,"utf8").trim().split("\n");expect(lines).toHaveLength(1);const parsedEntry=JSON.parse(lines[0]);expect(parsedEntry).toEqual({type:"test_type",data:"test-data"})}),it("should normalize dashes to underscores in type",()=>{appendFn({type:"create-pull-request",title:"Test PR"});const content=fs.readFileSync(testOutputFile,"utf8"),parsedEntry=JSON.parse(content.trim());expect(parsedEntry.type).toBe("create_pull_request")}),it("should append multiple entries",()=>{[{type:"type-1",data:"data-1"},{type:"type-2",data:"data-2"},{type:"type-3",data:"data-3"}].forEach(entry=>appendFn(entry));const lines=fs.readFileSync(testOutputFile,"utf8").trim().split("\n");expect(lines).toHaveLength(3);const parsedEntries=lines.map(line=>JSON.parse(line));expect(parsedEntries[0].type).toBe("type_1"),expect(parsedEntries[1].type).toBe("type_2"),expect(parsedEntries[2].type).toBe("type_3")}),it("should preserve entry fields",()=>{appendFn({type:"upload-asset",path:"/test/file.png",sha:"abc123",size:1024,url:"https://example.com/file.png"});const content=fs.readFileSync(testOutputFile,"utf8"),parsedEntry=JSON.parse(content.trim());expect(parsedEntry).toEqual({type:"upload_asset",path:"/test/file.png",sha:"abc123",size:1024,url:"https://example.com/file.png"})}),it("should throw error when output file is not configured",()=>{const badAppendFn=createAppendFunction(""),entry={type:"test",data:"test"};expect(()=>badAppendFn(entry)).toThrow("No output file configured")}),it("should throw error when write fails",()=>{fs.mkdirSync(testOutputFile,{recursive:!0});const entry={type:"test",data:"test"};expect(()=>appendFn(entry)).toThrow("Failed to write to output file"),fs.rmdirSync(testOutputFile,{recursive:!0})}),it("should handle entries with nested objects",()=>{appendFn({type:"complex-type",nested:{field1:"value1",field2:{subfield:"value2"}}});const content=fs.readFileSync(testOutputFile,"utf8"),parsedEntry=JSON.parse(content.trim());expect(parsedEntry.nested).toEqual({field1:"value1",field2:{subfield:"value2"}})}),it("should handle entries with arrays",()=>{appendFn({type:"array-type",items:["item1","item2","item3"]});const content=fs.readFileSync(testOutputFile,"utf8"),parsedEntry=JSON.parse(content.trim());expect(parsedEntry.items).toEqual(["item1","item2","item3"])}),it("should create file if it doesn't exist",()=>{expect(fs.existsSync(testOutputFile)).toBe(!1),appendFn({type:"test",data:"test"}),expect(fs.existsSync(testOutputFile)).toBe(!0)}),it("should append to existing file",()=>{fs.writeFileSync(testOutputFile,JSON.stringify({type:"initial",data:"initial"})+"\n"),appendFn({type:"new",data:"new"});const lines=fs.readFileSync(testOutputFile,"utf8").trim().split("\n");expect(lines).toHaveLength(2)}),it("should write single-line JSON without formatting (JSONL format)",()=>{appendFn({type:"complex-type",nested:{field1:"value1",field2:{subfield:"value2"}},array:["item1","item2","item3"]});const lines=fs.readFileSync(testOutputFile,"utf8").split("\n");expect(lines).toHaveLength(2),expect(lines[1]).toBe("");const parsed=JSON.parse(lines[0]);expect(parsed.type).toBe("complex_type");const firstLine=lines[0];expect(firstLine).not.toContain("\n"),expect(firstLine).not.toContain("\r"),expect(firstLine).not.toMatch(/\n\s+/)}),it("should handle entries with string fields containing newlines",()=>{appendFn({type:"text-with-newlines",message:"Line 1\nLine 2\nLine 3",description:"Multi-line\r\ntext\r\nhere"});const lines=fs.readFileSync(testOutputFile,"utf8").split("\n");expect(lines).toHaveLength(2),expect(lines[1]).toBe("");const parsed=JSON.parse(lines[0]);expect(parsed.message).toBe("Line 1\nLine 2\nLine 3"),expect(parsed.description).toBe("Multi-line\r\ntext\r\nhere"),expect(lines[0]).toContain("\\n"),expect(lines[0]).not.toContain("\nLine 2")})})});