import{describe,it,expect,beforeEach,afterEach,vi}from"vitest";import fs from"fs";import path from"path";import{createHandlers}from"./safe_outputs_handlers.cjs";describe("safe_outputs_handlers",()=>{let mockServer,mockAppendSafeOutput,handlers,testWorkspaceDir;beforeEach(()=>{mockServer={debug:vi.fn()},mockAppendSafeOutput=vi.fn(),handlers=createHandlers(mockServer,mockAppendSafeOutput);const testId=Math.random().toString(36).substring(7);testWorkspaceDir=`/tmp/test-handlers-workspace-${testId}`,fs.mkdirSync(testWorkspaceDir,{recursive:!0}),process.env.GITHUB_WORKSPACE=testWorkspaceDir,process.env.GITHUB_SERVER_URL="https://github.com",process.env.GITHUB_REPOSITORY="owner/repo"}),afterEach(()=>{try{fs.existsSync(testWorkspaceDir)&&fs.rmSync(testWorkspaceDir,{recursive:!0,force:!0})}catch(error){}delete process.env.GITHUB_WORKSPACE,delete process.env.GITHUB_SERVER_URL,delete process.env.GITHUB_REPOSITORY,delete process.env.GH_AW_ASSETS_BRANCH,delete process.env.GH_AW_ASSETS_MAX_SIZE_KB,delete process.env.GH_AW_ASSETS_ALLOWED_EXTS}),describe("defaultHandler",()=>{it("should handle basic entry without large content",()=>{const result=handlers.defaultHandler("test-type")({field1:"value1",field2:"value2"});expect(mockAppendSafeOutput).toHaveBeenCalledWith({field1:"value1",field2:"value2",type:"test-type"}),expect(result).toEqual({content:[{type:"text",text:JSON.stringify({result:"success"})}]})}),it("should handle entry with large content",()=>{const result=handlers.defaultHandler("test-type")({largeField:"x".repeat(7e4),normalField:"normal"});expect(mockAppendSafeOutput).toHaveBeenCalled();const appendedEntry=mockAppendSafeOutput.mock.calls[0][0];expect(appendedEntry.largeField).toContain("[Content too large, saved to file:"),expect(appendedEntry.normalField).toBe("normal"),expect(appendedEntry.type).toBe("test-type"),expect(result.content[0].type).toBe("text");const fileInfo=JSON.parse(result.content[0].text);expect(fileInfo.filename).toBeDefined()}),it("should handle null args",()=>{const result=handlers.defaultHandler("test-type")(null);expect(mockAppendSafeOutput).toHaveBeenCalledWith({type:"test-type"}),expect(result.content[0].text).toBe(JSON.stringify({result:"success"}))}),it("should handle undefined args",()=>{const result=handlers.defaultHandler("test-type")(void 0);expect(mockAppendSafeOutput).toHaveBeenCalledWith({type:"test-type"}),expect(result.content[0].text).toBe(JSON.stringify({result:"success"}))})}),describe("uploadAssetHandler",()=>{it("should validate and process valid asset upload",()=>{process.env.GH_AW_ASSETS_BRANCH="test-branch";const testFile=path.join(testWorkspaceDir,"test.png");fs.writeFileSync(testFile,"test content");const args={path:testFile},result=handlers.uploadAssetHandler(args);expect(mockAppendSafeOutput).toHaveBeenCalled();const entry=mockAppendSafeOutput.mock.calls[0][0];expect(entry.type).toBe("upload_asset"),expect(entry.fileName).toBe("test.png"),expect(entry.sha).toBeDefined(),expect(entry.url).toContain("test-branch"),expect(result.content[0].type).toBe("text");const resultData=JSON.parse(result.content[0].text);expect(resultData.result).toContain("https://")}),it("should throw error if GH_AW_ASSETS_BRANCH not set",()=>{delete process.env.GH_AW_ASSETS_BRANCH;const args={path:"/tmp/test.png"};expect(()=>handlers.uploadAssetHandler(args)).toThrow("GH_AW_ASSETS_BRANCH not set")}),it("should throw error if file not found",()=>{process.env.GH_AW_ASSETS_BRANCH="test-branch";const args={path:path.join(testWorkspaceDir,"nonexistent.png")};expect(()=>handlers.uploadAssetHandler(args)).toThrow("File not found")}),it("should throw error if file outside allowed directories",()=>{process.env.GH_AW_ASSETS_BRANCH="test-branch";const args={path:"/etc/passwd"};expect(()=>handlers.uploadAssetHandler(args)).toThrow("File path must be within workspace directory")}),it("should allow files in /tmp directory",()=>{process.env.GH_AW_ASSETS_BRANCH="test-branch";const testFile=`/tmp/test-upload-${Date.now()}.png`;fs.writeFileSync(testFile,"test content");try{const args={path:testFile},result=handlers.uploadAssetHandler(args);expect(mockAppendSafeOutput).toHaveBeenCalled(),expect(result.content[0].type).toBe("text")}finally{fs.existsSync(testFile)&&fs.unlinkSync(testFile)}}),it("should reject file with disallowed extension",()=>{process.env.GH_AW_ASSETS_BRANCH="test-branch";const testFile=path.join(testWorkspaceDir,"test.txt");fs.writeFileSync(testFile,"test content");const args={path:testFile};expect(()=>handlers.uploadAssetHandler(args)).toThrow("File extension '.txt' is not allowed")}),it("should accept custom allowed extensions",()=>{process.env.GH_AW_ASSETS_BRANCH="test-branch",process.env.GH_AW_ASSETS_ALLOWED_EXTS=".txt,.md";const testFile=path.join(testWorkspaceDir,"test.txt");fs.writeFileSync(testFile,"test content");const args={path:testFile},result=handlers.uploadAssetHandler(args);expect(mockAppendSafeOutput).toHaveBeenCalled(),expect(result.content[0].type).toBe("text")}),it("should reject file exceeding size limit",()=>{process.env.GH_AW_ASSETS_BRANCH="test-branch",process.env.GH_AW_ASSETS_MAX_SIZE_KB="1";const testFile=path.join(testWorkspaceDir,"large.png");fs.writeFileSync(testFile,"x".repeat(2048));const args={path:testFile};expect(()=>handlers.uploadAssetHandler(args)).toThrow("exceeds maximum allowed size")})}),describe("createPullRequestHandler",()=>{it("should handle create pull request with valid branch",()=>{vi.mock("child_process",()=>({execSync:vi.fn(()=>Buffer.from("test-branch"))})),expect(handlers.createPullRequestHandler).toBeDefined()})}),describe("pushToPullRequestBranchHandler",()=>{it("should be defined",()=>{expect(handlers.pushToPullRequestBranchHandler).toBeDefined()})}),describe("handler structure",()=>{it("should export all required handlers",()=>{expect(handlers.defaultHandler).toBeDefined(),expect(handlers.uploadAssetHandler).toBeDefined(),expect(handlers.createPullRequestHandler).toBeDefined(),expect(handlers.pushToPullRequestBranchHandler).toBeDefined()}),it("should create handlers that return proper structure",()=>{const result=handlers.defaultHandler("test-type")({test:"data"});expect(result).toHaveProperty("content"),expect(Array.isArray(result.content)).toBe(!0),expect(result.content[0]).toHaveProperty("type"),expect(result.content[0]).toHaveProperty("text")})})});