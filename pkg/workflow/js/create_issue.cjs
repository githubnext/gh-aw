const{sanitizeLabelContent}=require("./sanitize_label_content.cjs"),{loadAgentOutput}=require("./load_agent_output.cjs"),{generateStagedPreview}=require("./staged_preview.cjs"),{generateFooter}=require("./generate_footer.cjs"),{getTrackerID}=require("./get_tracker_id.cjs"),{generateTemporaryId,isTemporaryId,normalizeTemporaryId,replaceTemporaryIdReferences,serializeTemporaryIdMap}=require("./temporary_id.cjs"),{parseAllowedRepos,getDefaultTargetRepo,validateRepo,parseRepoSlug}=require("./repo_helpers.cjs"),{addExpirationComment}=require("./expiration_helpers.cjs"),{removeDuplicateTitleFromDescription}=require("./remove_duplicate_title.cjs");async function main(){core.setOutput("issue_number",""),core.setOutput("issue_url",""),core.setOutput("temporary_id_map","{}"),core.setOutput("issues_to_assign_copilot","");const isStaged="true"===process.env.GH_AW_SAFE_OUTPUTS_STAGED,result=loadAgentOutput();if(!result.success)return;const createIssueItems=result.items.filter(item=>"create_issue"===item.type);if(0===createIssueItems.length)return void core.info("No create-issue items found in agent output");core.info(`Found ${createIssueItems.length} create-issue item(s)`);const allowedRepos=parseAllowedRepos(),defaultTargetRepo=getDefaultTargetRepo();if(core.info(`Default target repo: ${defaultTargetRepo}`),allowedRepos.size>0&&core.info(`Allowed repos: ${Array.from(allowedRepos).join(", ")}`),isStaged)return void await generateStagedPreview({title:"Create Issues",description:"The following issues would be created if staged mode was disabled:",items:createIssueItems,renderItem:(item,index)=>{let content=`### Issue ${index+1}\n`;return content+=`**Title:** ${item.title||"No title provided"}\n\n`,item.temporary_id&&(content+=`**Temporary ID:** ${item.temporary_id}\n\n`),item.repo&&(content+=`**Repository:** ${item.repo}\n\n`),item.body&&(content+=`**Body:**\n${item.body}\n\n`),item.labels&&item.labels.length>0&&(content+=`**Labels:** ${item.labels.join(", ")}\n\n`),item.parent&&(content+=`**Parent:** ${item.parent}\n\n`),content}});const parentIssueNumber=context.payload?.issue?.number,temporaryIdMap=new Map,triggeringIssueNumber=context.payload?.issue?.number&&!context.payload?.issue?.pull_request?context.payload.issue.number:void 0,triggeringPRNumber=context.payload?.pull_request?.number||(context.payload?.issue?.pull_request?context.payload.issue.number:void 0),triggeringDiscussionNumber=context.payload?.discussion?.number,labelsEnv=process.env.GH_AW_ISSUE_LABELS;let envLabels=labelsEnv?labelsEnv.split(",").map(label=>label.trim()).filter(label=>label):[];const createdIssues=[];for(let i=0;i<createIssueItems.length;i++){const createIssueItem=createIssueItems[i],itemRepo=createIssueItem.repo?String(createIssueItem.repo).trim():defaultTargetRepo,repoValidation=validateRepo(itemRepo,defaultTargetRepo,allowedRepos);if(!repoValidation.valid){core.warning(`Skipping issue: ${repoValidation.error}`);continue}const repoParts=parseRepoSlug(itemRepo);if(!repoParts){core.warning(`Skipping issue: Invalid repository format '${itemRepo}'. Expected 'owner/repo'.`);continue}const temporaryId=createIssueItem.temporary_id||generateTemporaryId();let effectiveParentIssueNumber;core.info(`Processing create-issue item ${i+1}/${createIssueItems.length}: title=${createIssueItem.title}, bodyLength=${createIssueItem.body.length}, temporaryId=${temporaryId}, repo=${itemRepo}`),core.info(`Debug: createIssueItem.parent = ${JSON.stringify(createIssueItem.parent)}`),core.info(`Debug: parentIssueNumber from context = ${JSON.stringify(parentIssueNumber)}`);let effectiveParentRepo=itemRepo;if(void 0!==createIssueItem.parent)if(isTemporaryId(createIssueItem.parent)){const resolvedParent=temporaryIdMap.get(normalizeTemporaryId(createIssueItem.parent));void 0!==resolvedParent?(effectiveParentIssueNumber=resolvedParent.number,effectiveParentRepo=resolvedParent.repo,core.info(`Resolved parent temporary ID '${createIssueItem.parent}' to ${effectiveParentRepo}#${effectiveParentIssueNumber}`)):(core.warning(`Parent temporary ID '${createIssueItem.parent}' not found in map. Ensure parent issue is created before sub-issues.`),effectiveParentIssueNumber=void 0)}else effectiveParentIssueNumber=parseInt(String(createIssueItem.parent),10),isNaN(effectiveParentIssueNumber)&&(core.warning(`Invalid parent value: ${createIssueItem.parent}`),effectiveParentIssueNumber=void 0);else itemRepo===`${context.repo.owner}/${context.repo.repo}`&&(effectiveParentIssueNumber=parentIssueNumber);core.info(`Debug: effectiveParentIssueNumber = ${JSON.stringify(effectiveParentIssueNumber)}, effectiveParentRepo = ${effectiveParentRepo}`),effectiveParentIssueNumber&&void 0!==createIssueItem.parent&&core.info(`Using explicit parent issue number from item: ${effectiveParentRepo}#${effectiveParentIssueNumber}`);let labels=[...envLabels];createIssueItem.labels&&Array.isArray(createIssueItem.labels)&&(labels=[...labels,...createIssueItem.labels]),labels=labels.filter(label=>!!label).map(label=>String(label).trim()).filter(label=>label).map(label=>sanitizeLabelContent(label)).filter(label=>label).map(label=>label.length>64?label.substring(0,64):label).filter((label,index,arr)=>arr.indexOf(label)===index);let title=createIssueItem.title?createIssueItem.title.trim():"",processedBody=replaceTemporaryIdReferences(createIssueItem.body,temporaryIdMap,itemRepo);processedBody=removeDuplicateTitleFromDescription(title,processedBody);let bodyLines=processedBody.split("\n");title||(title=createIssueItem.body||"Agent Output");const titlePrefix=process.env.GH_AW_ISSUE_TITLE_PREFIX;titlePrefix&&!title.startsWith(titlePrefix)&&(title=titlePrefix+title),effectiveParentIssueNumber&&(core.info("Detected issue context, parent issue "+effectiveParentRepo+"#"+effectiveParentIssueNumber),effectiveParentRepo===itemRepo?bodyLines.push(`Related to #${effectiveParentIssueNumber}`):bodyLines.push(`Related to ${effectiveParentRepo}#${effectiveParentIssueNumber}`));const workflowName=process.env.GH_AW_WORKFLOW_NAME||"Workflow",workflowSource=process.env.GH_AW_WORKFLOW_SOURCE||"",workflowSourceURL=process.env.GH_AW_WORKFLOW_SOURCE_URL||"",runId=context.runId,githubServer=process.env.GITHUB_SERVER_URL||"https://github.com",runUrl=context.payload.repository?`${context.payload.repository.html_url}/actions/runs/${runId}`:`${githubServer}/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`,trackerIDComment=getTrackerID("markdown");trackerIDComment&&bodyLines.push(trackerIDComment),addExpirationComment(bodyLines,"GH_AW_ISSUE_EXPIRES","Issue"),bodyLines.push("","",generateFooter(workflowName,runUrl,workflowSource,workflowSourceURL,triggeringIssueNumber,triggeringPRNumber,triggeringDiscussionNumber).trimEnd(),"");const body=bodyLines.join("\n").trim();core.info(`Creating issue in ${itemRepo} with title: ${title}`),core.info(`Labels: ${labels}`),core.info(`Body length: ${body.length}`);try{const{data:issue}=await github.rest.issues.create({owner:repoParts.owner,repo:repoParts.repo,title,body,labels});if(core.info(`Created issue ${itemRepo}#${issue.number}: ${issue.html_url}`),createdIssues.push({...issue,_repo:itemRepo}),temporaryIdMap.set(normalizeTemporaryId(temporaryId),{repo:itemRepo,number:issue.number}),core.info(`Stored temporary ID mapping: ${temporaryId} -> ${itemRepo}#${issue.number}`),core.info(`Debug: About to check if sub-issue linking is needed. effectiveParentIssueNumber = ${effectiveParentIssueNumber}`),effectiveParentIssueNumber&&effectiveParentRepo===itemRepo){core.info(`Attempting to link issue #${issue.number} as sub-issue of #${effectiveParentIssueNumber}`);try{core.info(`Fetching node ID for parent issue #${effectiveParentIssueNumber}...`);const getIssueNodeIdQuery="\n            query($owner: String!, $repo: String!, $issueNumber: Int!) {\n              repository(owner: $owner, name: $repo) {\n                issue(number: $issueNumber) {\n                  id\n                }\n              }\n            }\n          ",parentNodeId=(await github.graphql(getIssueNodeIdQuery,{owner:repoParts.owner,repo:repoParts.repo,issueNumber:effectiveParentIssueNumber})).repository.issue.id;core.info(`Parent issue node ID: ${parentNodeId}`),core.info(`Fetching node ID for child issue #${issue.number}...`);const childNodeId=(await github.graphql(getIssueNodeIdQuery,{owner:repoParts.owner,repo:repoParts.repo,issueNumber:issue.number})).repository.issue.id;core.info(`Child issue node ID: ${childNodeId}`),core.info("Executing addSubIssue mutation...");const addSubIssueMutation="\n            mutation($issueId: ID!, $subIssueId: ID!) {\n              addSubIssue(input: {\n                issueId: $issueId,\n                subIssueId: $subIssueId\n              }) {\n                subIssue {\n                  id\n                  number\n                }\n              }\n            }\n          ";await github.graphql(addSubIssueMutation,{issueId:parentNodeId,subIssueId:childNodeId}),core.info("✓ Successfully linked issue #"+issue.number+" as sub-issue of #"+effectiveParentIssueNumber)}catch(error){core.info(`Warning: Could not link sub-issue to parent: ${error instanceof Error?error.message:String(error)}`),core.info(`Error details: ${error instanceof Error?error.stack:String(error)}`);try{core.info(`Attempting fallback: adding comment to parent issue #${effectiveParentIssueNumber}...`),await github.rest.issues.createComment({owner:repoParts.owner,repo:repoParts.repo,issue_number:effectiveParentIssueNumber,body:`Created related issue: #${issue.number}`}),core.info("✓ Added comment to parent issue #"+effectiveParentIssueNumber+" (sub-issue linking not available)")}catch(commentError){core.info(`Warning: Could not add comment to parent issue: ${commentError instanceof Error?commentError.message:String(commentError)}`)}}}else effectiveParentIssueNumber&&effectiveParentRepo!==itemRepo?core.info(`Skipping sub-issue linking: parent is in different repository (${effectiveParentRepo})`):core.info("Debug: No parent issue number set, skipping sub-issue linking");i===createIssueItems.length-1&&(core.setOutput("issue_number",issue.number),core.setOutput("issue_url",issue.html_url))}catch(error){const errorMessage=error instanceof Error?error.message:String(error);if(errorMessage.includes("Issues has been disabled in this repository")){core.info(`⚠ Cannot create issue "${title}" in ${itemRepo}: Issues are disabled for this repository`),core.info("Consider enabling issues in repository settings if you want to create issues automatically");continue}throw core.error(`✗ Failed to create issue "${title}" in ${itemRepo}: ${errorMessage}`),error}}if(createdIssues.length>0){let summaryContent="\n\n## GitHub Issues\n";for(const issue of createdIssues){const repoLabel=issue._repo!==defaultTargetRepo?` (${issue._repo})`:"";summaryContent+=`- Issue #${issue.number}${repoLabel}: [${issue.title}](${issue.html_url})\n`}await core.summary.addRaw(summaryContent).write()}const tempIdMapOutput=serializeTemporaryIdMap(temporaryIdMap);if(core.setOutput("temporary_id_map",tempIdMapOutput),core.info(`Temporary ID map: ${tempIdMapOutput}`),"true"===process.env.GH_AW_ASSIGN_COPILOT&&createdIssues.length>0){const issuesToAssign=createdIssues.map(issue=>`${issue._repo}:${issue.number}`).join(",");core.setOutput("issues_to_assign_copilot",issuesToAssign),core.info(`Issues to assign copilot: ${issuesToAssign}`)}core.info(`Successfully created ${createdIssues.length} issue(s)`)}(async()=>{await main()})();