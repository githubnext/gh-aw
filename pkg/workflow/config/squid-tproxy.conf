# Squid configuration for TPROXY-based transparent proxy
# This configuration enables both HTTP (port 3128) and HTTPS (port 3129) proxying
# with TPROXY support for preserving original destination information

# Port configuration
# Standard HTTP proxy port (for REDIRECT traffic from iptables)
http_port 3128

# TPROXY port for HTTPS traffic (preserves original destination)
# This allows Squid to see the original destination IP and make correct upstream connections
http_port 3129 tproxy

# ACL definitions for allowed domains
# Domain allowlist loaded from external file
acl allowed_domains dstdomain "/etc/squid/allowed_domains.txt"

# Local network ranges that should be allowed
acl localnet src 127.0.0.1/8        # Localhost
acl localnet src 10.0.0.0/8         # Private network (Class A)
acl localnet src 172.16.0.0/12      # Private network (Class B)
acl localnet src 192.168.0.0/16     # Private network (Class C)

# Safe ports for HTTP traffic
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443

# HTTP methods
acl CONNECT method CONNECT

# Access rules (evaluated in order)
# Deny requests to domains not in the allowlist
http_access deny !allowed_domains

# Deny non-safe ports (only 80 and 443 allowed)
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Allow local network access
http_access allow localnet

# Allow localhost access
http_access allow localhost

# Default deny all other access
http_access deny all

# Logging configuration
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# Disable caching (we want all requests to go through in real-time)
cache deny all

# DNS configuration
# Use Google DNS for reliability
dns_nameservers 8.8.8.8 8.8.4.4

# Privacy settings
# Don't forward client information
forwarded_for delete
via off

# Error page configuration
error_directory /usr/share/squid/errors/en

# Log format (detailed for debugging)
logformat combined %>a %[ui %[un [%tl] "%rm %ru HTTP/%rv" %>Hs %<st "%{Referer}>h" "%{User-Agent}>h" %Ss:%Sh
access_log /var/log/squid/access.log combined

# Memory and resource limits
cache_mem 64 MB
maximum_object_size 0 KB

# Connection timeout settings
connect_timeout 30 seconds
read_timeout 60 seconds
request_timeout 30 seconds

# Keep-alive settings
client_persistent_connections on
server_persistent_connections on
