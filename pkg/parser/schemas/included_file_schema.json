{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "services": {
      "type": "object",
      "description": "Service containers to be merged with main workflow services",
      "additionalProperties": true
    },
    "mcp-servers": {
      "type": "object",
      "description": "MCP server definitions that can be imported into workflows",
      "patternProperties": {
        "^[a-zA-Z0-9_-]+$": {
          "oneOf": [
            {
              "$ref": "#/$defs/stdio_mcp_tool"
            },
            {
              "$ref": "#/$defs/http_mcp_tool"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "steps": {
      "description": "Custom workflow steps to be merged with main workflow",
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": true
        },
        {
          "type": "array",
          "items": {
            "oneOf": [
              {
                "type": "string"
              },
              {
                "type": "object",
                "additionalProperties": true
              }
            ]
          }
        }
      ]
    },
    "post-steps": {
      "description": "Custom workflow steps to run after AI execution, to be merged with main workflow",
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": true
        },
        {
          "type": "array",
          "items": {
            "oneOf": [
              {
                "type": "string"
              },
              {
                "type": "object",
                "additionalProperties": true
              }
            ]
          }
        }
      ]
    },
    "secret-masking-steps": {
      "description": "Custom workflow steps to run after secret redaction before artifact uploads, to be merged with main workflow",
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": true
        },
        {
          "type": "array",
          "items": {
            "oneOf": [
              {
                "type": "string"
              },
              {
                "type": "object",
                "additionalProperties": true
              }
            ]
          }
        }
      ]
    },
    "tools": {
      "type": "object",
      "description": "Tools configuration for the included file",
      "properties": {
        "bash": {
          "description": "Bash shell command execution tool for running command-line programs and scripts",
          "oneOf": [
            {
              "type": "null",
              "description": "Enable bash tool with all shell commands allowed"
            },
            {
              "type": "array",
              "description": "List of allowed bash commands and patterns (e.g., ['ast-grep:*', 'sg:*'])",
              "items": {
                "type": "string"
              }
            }
          ]
        },
        "cache-memory": {
          "description": "Cache memory MCP configuration for persistent memory storage",
          "oneOf": [
            {
              "type": "boolean",
              "description": "Enable cache-memory with default settings"
            },
            {
              "type": "null",
              "description": "Enable cache-memory with default settings (same as true)"
            },
            {
              "type": "object",
              "description": "Cache-memory configuration object",
              "properties": {
                "key": {
                  "type": "string",
                  "description": "Custom cache key for memory MCP data (restore keys are auto-generated by splitting on '-')"
                },
                "description": {
                  "type": "string",
                  "description": "Optional description for the cache that will be shown in the agent prompt"
                },
                "docker-image": {
                  "type": "string",
                  "description": "Docker image to use for the memory MCP server (default: mcp/memory)"
                },
                "retention-days": {
                  "type": "integer",
                  "minimum": 1,
                  "maximum": 90,
                  "description": "Number of days to retain uploaded artifacts (1-90 days, default: repository setting)"
                }
              },
              "additionalProperties": false
            },
            {
              "type": "array",
              "description": "Array of cache-memory configurations for multiple caches",
              "items": {
                "type": "object",
                "properties": {
                  "id": {
                    "type": "string",
                    "description": "Cache identifier (required for array notation, default: 'default')"
                  },
                  "key": {
                    "type": "string",
                    "description": "Custom cache key for this memory cache (restore keys are auto-generated by splitting on '-')"
                  },
                  "description": {
                    "type": "string",
                    "description": "Optional description for this cache that will be shown in the agent prompt"
                  },
                  "retention-days": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 90,
                    "description": "Number of days to retain uploaded artifacts (1-90 days, default: repository setting)"
                  }
                },
                "additionalProperties": false
              },
              "minItems": 1
            }
          ]
        },
        "github": {
          "description": "GitHub tools configuration",
          "oneOf": [
            {
              "type": "string",
              "description": "Simple github tool string"
            },
            {
              "type": "object",
              "description": "GitHub tools object configuration",
              "properties": {
                "allowed": {
                  "type": "array",
                  "description": "List of allowed GitHub tools",
                  "items": {
                    "type": "string"
                  }
                }
              },
              "additionalProperties": true
            }
          ]
        }
      },
      "additionalProperties": {
        "description": "Custom tool configuration",
        "oneOf": [
          {
            "type": "string",
            "description": "Simple tool string"
          },
          {
            "type": "object",
            "description": "Custom tool object configuration",
            "properties": {
              "mcp": {
                "description": "MCP server configuration",
                "additionalProperties": true
              },
              "allowed": {
                "type": "array",
                "description": "List of allowed tool functions",
                "items": {
                  "type": "string"
                }
              }
            },
            "additionalProperties": true
          }
        ]
      }
    },
    "engine": {
    "description": "AI engine configuration for included files",
    "oneOf": [
      {
        "type": "string",
        "enum": [
          "claude",
          "codex",
          "custom"
        ],
        "description": "Simple engine name (claude, codex, or custom)"
      },
      {
        "type": "object",
        "description": "Extended engine configuration object",
        "properties": {
          "id": {
            "type": "string",
            "enum": [
              "claude",
              "codex",
              "custom"
            ],
            "description": "Agent CLI identifier (claude, codex, or custom)"
          },
          "version": {
            "type": "string",
            "description": "Optional version of the action"
          },
          "model": {
            "type": "string",
            "description": "Optional LLM model to use"
          },
          "max-turns": {
            "type": "integer",
            "description": "Maximum number of chat iterations per run"
          },
          "env": {
            "type": "object",
            "description": "Custom environment variables to pass to the agentic engine",
            "additionalProperties": {
              "type": "string"
            }
          },
          "steps": {
            "type": "array",
            "description": "Custom GitHub Actions steps (for custom engine)",
            "items": {
              "type": "object",
              "additionalProperties": true
            }
          }
        },
        "required": [
          "id"
        ],
        "additionalProperties": false
      }
    ]
  },
  "safe-outputs": {
    "type": "object",
    "description": "Safe outputs configuration (only jobs allowed in included files)",
    "properties": {
      "jobs": {
        "type": "object",
        "description": "Custom safe-job definitions",
        "patternProperties": {
          "^[a-zA-Z0-9_-]+$": {
            "$ref": "#/$defs/safe_job"
          }
        },
        "additionalProperties": false
      }
    },
    "additionalProperties": false
  },
  "runtimes": {
    "type": "object",
    "description": "Runtime environment version overrides. Allows customizing runtime versions (e.g., Node.js, Python) or defining new runtimes. Merged with main workflow runtimes.",
    "patternProperties": {
      "^[a-z][a-z0-9-]*$": {
        "type": "object",
        "description": "Runtime configuration object identified by runtime ID (e.g., 'node', 'python', 'go')",
        "properties": {
          "version": {
            "oneOf": [
              {
                "type": "string",
                "description": "Runtime version as a string (e.g., '22', '3.12', 'latest')"
              },
              {
                "type": "number",
                "description": "Runtime version as a number (e.g., 22, 3.12)"
              }
            ]
          },
          "action-repo": {
            "type": "string",
            "description": "GitHub Actions repository for setting up the runtime (e.g., 'actions/setup-node', 'custom/setup-runtime'). Overrides the default setup action."
          },
          "action-version": {
            "type": "string",
            "description": "Version of the setup action to use (e.g., 'v4', 'v5'). Overrides the default action version."
          }
        },
        "additionalProperties": false
      }
    },
    "additionalProperties": false
  }
},
"additionalProperties": false,
"$defs": {
  "stdio_mcp_tool": {
    "type": "object",
    "description": "Stdio MCP tool configuration",
    "properties": {
      "type": {
        "type": "string",
        "enum": [
          "stdio",
          "local"
        ],
        "description": "MCP connection type for stdio (local is an alias for stdio)"
      },
      "registry": {
        "type": "string",
        "description": "URI to the installation location when MCP is installed from a registry"
      },
      "command": {
        "type": "string",
        "description": "Command for stdio MCP connections"
      },
      "container": {
        "type": "string",
        "pattern": "^[a-zA-Z0-9][a-zA-Z0-9/:_.-]*$",
        "description": "Container image for stdio MCP connections (alternative to command)"
      },
      "version": {
        "type": "string",
        "description": "Optional version/tag for the container image (e.g., 'latest', 'v1.0.0')"
      },
      "args": {
        "type": "array",
        "items": {
          "type": "string"
        },
        "description": "Arguments for command or container execution"
      },
      "env": {
        "type": "object",
        "patternProperties": {
          "^[A-Z_][A-Z0-9_]*$": {
            "type": "string"
          }
        },
        "additionalProperties": false,
        "description": "Environment variables for MCP server"
      },
      "network": {
        "type": "object",
        "properties": {
          "allowed": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^[a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?(\\.[a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?)*$",
              "description": "Allowed domain name"
            },
            "minItems": 1,
            "uniqueItems": true,
            "description": "List of allowed domain names for network access"
          },
          "proxy-args": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Custom proxy arguments for container-based MCP servers"
          }
        },
        "additionalProperties": false,
        "description": "Network configuration for container-based MCP servers"
      },
      "allowed": {
        "type": "array",
        "description": "List of allowed tool functions",
        "items": {
          "type": "string"
        }
      }
    },
    "additionalProperties": false,
    "anyOf": [
      {
        "required": [
          "command"
        ]
      },
      {
        "required": [
          "container"
        ]
      }
    ],
    "not": {
      "allOf": [
        {
          "required": [
            "command"
          ]
        },
        {
          "required": [
            "container"
          ]
        }
      ]
    },
    "allOf": [
      {
        "if": {
          "required": [
            "network"
          ]
        },
        "then": {
          "required": [
            "container"
          ]
        }
      }
    ]
  },
  "http_mcp_tool": {
    "type": "object",
    "description": "HTTP MCP tool configuration",
    "properties": {
      "type": {
        "type": "string",
        "const": "http",
        "description": "MCP connection type for HTTP"
      },
      "registry": {
        "type": "string",
        "description": "URI to the installation location when MCP is installed from a registry"
      },
      "url": {
        "type": "string",
        "description": "URL for HTTP MCP connections"
      },
      "headers": {
        "type": "object",
        "patternProperties": {
          "^[A-Za-z0-9_-]+$": {
            "type": "string"
          }
        },
        "additionalProperties": false,
        "description": "HTTP headers for HTTP MCP connections"
      },
      "allowed": {
        "type": "array",
        "description": "List of allowed tool functions",
        "items": {
          "type": "string"
        }
      }
    },
    "required": [
      "url"
    ],
    "additionalProperties": false
  },
  "safe_job": {
    "type": "object",
    "description": "Custom safe-job configuration",
    "properties": {
      "name": {
        "type": "string",
        "description": "Display name for the job"
      },
      "description": {
        "type": "string",
        "description": "Description of the safe-job (used in MCP tool registration)"
      },
      "runs-on": {
        "oneOf": [
          {
            "type": "string",
            "description": "Runner type (e.g., 'ubuntu-latest')"
          },
          {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Array of runner types"
          }
        ],
        "description": "GitHub Actions runner specification"
      },
      "if": {
        "type": "string",
        "description": "Conditional execution expression"
      },
      "needs": {
        "oneOf": [
          {
            "type": "string",
            "description": "Single job dependency"
          },
          {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Array of job dependencies"
          }
        ]
      },
      "steps": {
        "type": "array",
        "description": "GitHub Actions steps",
        "items": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "env": {
        "type": "object",
        "description": "Environment variables",
        "additionalProperties": {
          "type": "string"
        }
      },
      "permissions": {
        "type": "object",
        "description": "Job-level permissions",
        "additionalProperties": {
          "type": "string"
        }
      },
      "inputs": {
        "type": "object",
        "description": "Input parameters for the safe-job (required)",
        "patternProperties": {
          "^[a-zA-Z0-9_-]+$": {
            "type": "object",
            "properties": {
              "description": {
                "type": "string",
                "description": "Input description"
              },
              "required": {
                "type": "boolean",
                "description": "Whether the input is required"
              },
              "default": {
                "type": "string",
                "description": "Default value"
              },
              "type": {
                "type": "string",
                "enum": ["string", "number", "boolean", "choice"],
                "description": "Input type"
              },
              "options": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Options for choice type"
              }
            },
            "additionalProperties": false
          }
        },
        "minProperties": 1,
        "additionalProperties": false
      },
      "github-token": {
        "type": "string",
        "description": "Custom GitHub token"
      },
      "output": {
        "type": "string",
        "description": "Custom output message"
      }
    },
    "required": ["inputs"],
    "additionalProperties": false
  }
}
}