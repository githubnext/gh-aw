---
# Python Chart Discussion Report - Comprehensive reporting with charts
# Extends python-dataviz.md for workflows that generate reports with visualizations
#
# Usage:
#   imports:
#     - shared/python-chart-discussion-report.md
#
# This import provides:
# - Python environment with scientific libraries (via python-dataviz.md)
# - Report structure guidelines for chart-based discussions
# - Chart upload and embedding instructions
# - Quality standards for charts and reports
# - Best practices for discussion creation

imports:
  - shared/python-dataviz.md
  - shared/reporting.md

safe-outputs:
  upload-asset:
  create-discussion:
    max: 1
    close-older-discussions: true

tools:
  cache-memory: true
---

# Python Chart Discussion Report Guide

This component extends `python-dataviz.md` for workflows that generate comprehensive reports with multiple visualization charts uploaded as assets and embedded in GitHub discussions.

## Standard Report Structure

All chart-based reports should follow this structure:

```markdown
# [Report Title] - [Date]

## Executive Summary

[2-3 paragraphs summarizing key findings, trends, and recommendations]

**Key Statistics:**
- Metric 1: [value]
- Metric 2: [value]
- Metric 3: [value]

## Key Visualizations

### [Chart 1 Title]
![Chart 1 Description](CHART_1_URL)

[2-3 sentence analysis of what this chart shows and key insights]

### [Chart 2 Title]
![Chart 2 Description](CHART_2_URL)

[2-3 sentence analysis of what this chart shows and key insights]

### [Chart 3 Title] (if applicable)
![Chart 3 Description](CHART_3_URL)

[2-3 sentence analysis]

<details>
<summary><b>ðŸ“Š Detailed Metrics</b></summary>

## Detailed Data Tables

[Detailed metrics in table format]

</details>

## ðŸ’¡ Insights and Recommendations

1. [Specific actionable recommendation based on data]
2. [Another recommendation]
3. [Additional recommendation]

---
*Report generated by [Workflow Name] workflow*
*Data period: [period] | Generated: [timestamp]*
```

## Chart Upload Process

After generating charts in `/tmp/gh-aw/python/charts/`:

### Step 1: Upload Charts as Assets

Upload each chart and collect URLs:

```bash
# Upload each chart and collect URLs
declare -A chart_urls

for chart_file in /tmp/gh-aw/python/charts/*.png; do
  if [ -f "$chart_file" ]; then
    chart_name=$(basename "$chart_file" .png)
    echo "Uploading $chart_name..."
    
    # Use upload-asset tool (returns URL)
    # Store URL in associative array
    # chart_urls["$chart_name"]="$returned_url"
  fi
done
```

### Step 2: Create Discussion with Embedded Charts

Use the collected URLs to embed charts in your discussion markdown following the standard report structure above.

## Standard Chart Set

Most workflows should generate **2-4 charts**:

### 1. Primary Trend Chart
Time series showing main metrics over 30 days
- Line chart with multiple series
- Include 7-day moving average
- Annotate significant changes

### 2. Distribution Chart
Breakdown of current state
- Bar chart or pie chart
- Show proportions or counts
- Sort by significance

### 3. Comparison Chart (optional)
Before/after or comparative analysis
- Grouped bars or side-by-side comparison
- Highlight differences
- Include percentage changes

### 4. Detailed Analysis Chart (optional)
Deep dive into specific aspect
- Heatmap, scatter plot, or specialized visualization
- Focus on specific insight

## Chart Quality Standards

All charts MUST meet these requirements (from python-dataviz.md):

- **DPI**: 300 minimum for publication quality
- **Figure Size**: 12x7 inches (or 10x6 for smaller charts)
- **Styling**: Use seaborn styling (`sns.set_style("whitegrid")`)
- **Color Palette**: Professional colors (`sns.set_palette("husl")` or custom)
- **Labels**: Clear titles, axis labels, and legends
- **Grid Lines**: Enable for readability (`ax.grid(True, alpha=0.3)`)
- **Save Format**: PNG with `bbox_inches='tight'`

## Chart Generation Template

```python
#!/usr/bin/env python3
"""
Chart generation script for [workflow name]
Generates [number] charts for the daily report
"""
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime

# Set consistent style
sns.set_style("whitegrid")
sns.set_palette("husl")

# Load data (NEVER inline - always from external file)
data = pd.read_json('/tmp/gh-aw/python/data/metrics.json')

# Chart 1: Trend Chart
def generate_trend_chart():
    fig, ax = plt.subplots(figsize=(12, 7), dpi=300)
    
    # Your plotting code
    data.plot(x='date', y=['metric1', 'metric2'], ax=ax)
    
    # Customize
    ax.set_title('Metric Trends - Last 30 Days', fontsize=16, fontweight='bold')
    ax.set_xlabel('Date', fontsize=12)
    ax.set_ylabel('Value', fontsize=12)
    ax.legend(loc='best')
    ax.grid(True, alpha=0.3)
    
    # Save
    plt.savefig('/tmp/gh-aw/python/charts/trend_chart.png',
                dpi=300, bbox_inches='tight', facecolor='white')
    print("âœ“ Trend chart generated")

# Chart 2: Distribution Chart
def generate_distribution_chart():
    fig, ax = plt.subplots(figsize=(10, 6), dpi=300)
    
    # Your plotting code
    data['category'].value_counts().plot(kind='barh', ax=ax)
    
    # Customize
    ax.set_title('Distribution by Category', fontsize=16, fontweight='bold')
    ax.set_xlabel('Count', fontsize=12)
    ax.grid(True, alpha=0.3)
    
    # Save
    plt.savefig('/tmp/gh-aw/python/charts/distribution_chart.png',
                dpi=300, bbox_inches='tight', facecolor='white')
    print("âœ“ Distribution chart generated")

# Generate all charts
if __name__ == '__main__':
    generate_trend_chart()
    generate_distribution_chart()
    print("All charts generated successfully")
```

## Discussion Creation Best Practices

1. **Title format**: `[Category] Report Name - YYYY-MM-DD`
2. **Executive summary**: 2-3 paragraphs max, highlight key findings
3. **Chart placement**: Embed charts early, before detailed metrics
4. **Analysis text**: 2-3 sentences per chart explaining insights
5. **Collapsible details**: Put detailed tables/metrics in `<details>` tag
6. **Recommendations**: 3-5 bullet points, specific and actionable
7. **Metadata footer**: Include workflow name, data period, generation timestamp

## Cache Memory Integration

Store reusable chart generation code in cache:

```bash
# Check for cached chart utilities
if [ -f /tmp/gh-aw/cache-memory/chart_utils.py ]; then
  cp /tmp/gh-aw/cache-memory/chart_utils.py /tmp/gh-aw/python/
  echo "Using cached chart utilities"
fi

# Save new utilities to cache
if [ -f /tmp/gh-aw/python/chart_utils.py ]; then
  cp /tmp/gh-aw/python/chart_utils.py /tmp/gh-aw/cache-memory/
  echo "Saved chart utilities to cache"
fi
```

## Complete Example Usage

```yaml
---
imports:
  - shared/python-chart-discussion-report.md
  - shared/issues-data-fetch.md  # Or other data source
  
safe-outputs:
  create-discussion:
    category: "audits"
---

# Your Workflow Instructions

Then in your workflow:

1. Load and process data
2. Generate charts with Python (following quality standards)
3. Upload charts as assets (collect URLs)
4. Create discussion using standard report structure
5. Embed chart URLs in markdown
```

## Migration Tips

When migrating existing workflows to use this shared component:

1. **Replace imports**: Replace individual `python-dataviz.md` and `reporting.md` imports with this component
2. **Simplify instructions**: Remove duplicated chart quality guidelines and report structure instructions
3. **Keep workflow-specific logic**: Retain data collection and analysis logic specific to your workflow
4. **Use standard structure**: Follow the standard report structure for consistency
5. **Leverage cache**: Use cache memory for reusable utilities

## Error Handling

Always handle errors gracefully in chart generation:

```python
import os
import sys

# Check data file existence
data_file = '/tmp/gh-aw/python/data/metrics.json'
if not os.path.exists(data_file):
    print(f"Error: Data file not found: {data_file}", file=sys.stderr)
    sys.exit(1)

# Validate data
try:
    data = pd.read_json(data_file)
    if data.empty:
        raise ValueError("Data file is empty")
except Exception as e:
    print(f"Error loading data: {e}", file=sys.stderr)
    sys.exit(1)

# Generate charts with error handling
try:
    generate_trend_chart()
except Exception as e:
    print(f"Error generating trend chart: {e}", file=sys.stderr)
    # Continue with other charts
```

## Tips for Success

1. **Follow standards**: Use the chart quality standards consistently
2. **Structure reports**: Follow the standard report structure
3. **Upload early**: Upload charts before creating the discussion
4. **Analyze charts**: Provide 2-3 sentence analysis for each chart
5. **Be actionable**: Include specific, actionable recommendations
6. **Test locally**: Test chart generation before committing
7. **Use cache**: Leverage cache memory for reusable code
8. **Handle errors**: Gracefully handle missing data or failed chart generation
