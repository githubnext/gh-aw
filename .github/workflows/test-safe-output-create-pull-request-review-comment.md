---
on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize]

safe-outputs:
  create-pull-request-review-comment:
    max: 3
    side: "RIGHT"
  staged: true

engine:
  id: custom
  steps:
    - name: Generate PR Review Comment Safe Output
      run: |
        echo '{"type": "create-pull-request-review-comment", "path": "README.md", "line": 1, "body": "## Custom Engine Review Comment Test\n\nThis review comment was automatically created by the test-safe-output-create-pull-request-review-comment workflow to validate the create-pull-request-review-comment safe output functionality.\n\n**Review Details:**\n- Safe Output Type: create-pull-request-review-comment\n- Generated by: Custom Engine\n- Test time: '"$(date)"'\n- Workflow: test-safe-output-create-pull-request-review-comment\n- Event: ${{ github.event_name }}\n- Staged Mode: true\n\nâœ… PR review comment safe output test completed.\n\nThis comment should not appear in actual pull requests due to staged mode."}' >> $GITHUB_AW_SAFE_OUTPUTS
        
        # Generate a second review comment to test multi-line comments
        echo '{"type": "create-pull-request-review-comment", "path": "package.json", "line": 5, "start_line": 3, "body": "### Multi-line Review Comment Test\n\nThis is a test of multi-line review comments using start_line and line properties.\n\n**Test Information:**\n- Lines: 3-5\n- File: package.json\n- Purpose: Validate multi-line comment functionality\n- Staged: true (no actual API calls)", "side": "RIGHT"}' >> $GITHUB_AW_SAFE_OUTPUTS
        
    - name: Verify Safe Output File
      run: |
        echo "Generated safe output entries:"
        if [ -f "$GITHUB_AW_SAFE_OUTPUTS" ]; then
          cat "$GITHUB_AW_SAFE_OUTPUTS"
        else
          echo "No safe outputs file found"
        fi

permissions: read-all
---

# Test Safe Output - Create Pull Request Review Comment

This workflow tests the `create-pull-request-review-comment` safe output functionality using a custom engine that directly writes to the safe output file.

## Purpose

This workflow validates the create-pull-request-review-comment safe output type by:
- Generating JSON entries with the `create-pull-request-review-comment` type
- Including all required fields: path, line, body
- Testing both single-line and multi-line review comments
- Using staged mode to prevent actual GitHub interactions
- Demonstrating custom engine safe output writing for PR review comments

## Trigger Events

- **workflow_dispatch**: Manual execution for testing
- **pull_request.opened**: Responds to new pull requests being created
- **pull_request.synchronize**: Responds to PR updates

## Safe Output Configuration

- **staged: true**: Prevents real GitHub interactions
- **max: 3**: Allows up to 3 review comments per workflow run
- **side: "RIGHT"**: Comments target the new version of files (default behavior)

## Custom Engine Implementation

The workflow uses a custom engine with GitHub Actions steps to:
1. Generate multiple review comment JSON outputs for testing
2. Test both single-line and multi-line comments (using start_line)
3. Include comprehensive review information
4. Target different files (README.md and package.json)
5. Append entries to the $GITHUB_AW_SAFE_OUTPUTS file
6. Verify the outputs were generated correctly

This demonstrates how custom engines can leverage the safe output system for creating line-specific review comments on pull requests, enabling detailed code feedback.