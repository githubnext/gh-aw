---
name: Copilot Maintenance

on:
  schedule:
    - cron: "0 2 * * *"  # Daily at 2:00 AM UTC
  workflow_dispatch:
    inputs:
      delete_branches:
        description: 'Delete branches (if false, only preview)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  delete-old-copilot-branches:
    name: Delete Old Copilot Branches
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        # v4.2.2
        with:
          fetch-depth: 0  # Fetch all history for all branches
          persist-credentials: false

      - name: Run copilot branch cleanup script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running copilot branch cleanup script..."
          ./scripts/delete-old-copilot-branches.sh

      - name: Execute deletion commands
        if: github.event.inputs.delete_branches == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Executing deletion commands..."
          ./scripts/delete-old-copilot-branches.sh | \
            grep "git push origin --delete" | \
            while read -r cmd; do
              echo "Executing: $cmd"
              eval "$cmd" || \
                echo "Failed to delete branch (may already be deleted)"
            done
          echo "✓ Copilot branch cleanup completed"

      - name: Preview mode notice
        if: github.event.inputs.delete_branches != 'true'
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "⚠️  PREVIEW MODE - No branches were deleted"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "To delete branches, re-run this workflow with:"
          echo "  delete_branches: true"
          echo ""
          echo "See the 'Run copilot branch cleanup script' step"
          echo "for the list of branches that would be deleted."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
