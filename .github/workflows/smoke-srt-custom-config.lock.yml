#
#    ___                   _   _      
#   / _ \                 | | (_)     
#  | |_| | __ _  ___ _ __ | |_ _  ___ 
#  |  _  |/ _` |/ _ \ '_ \| __| |/ __|
#  | | | | (_| |  __/ | | | |_| | (__ 
#  \_| |_/\__, |\___|_| |_|\__|_|\___|
#          __/ |
#  _    _ |___/ 
# | |  | |                / _| |
# | |  | | ___ _ __ _  __| |_| | _____      ____
# | |/\| |/ _ \ '__| |/ /|  _| |/ _ \ \ /\ / / ___|
# \  /\  / (_) | | | | ( | | | | (_) \ V  V /\__ \
#  \/  \/ \___/|_| |_|\_\|_| |_|\___/ \_/\_/ |___/
#
# This file was automatically generated by gh-aw. DO NOT EDIT.
#
# To update this file, edit the corresponding .md file and run:
#   gh aw compile
# For more information: https://github.com/githubnext/gh-aw/blob/main/.github/aw/github-agentic-workflows.md
#
# Smoke test workflow for Sandbox Runtime (SRT) with custom configuration

name: "Smoke SRT Custom Config"
"on":
  workflow_dispatch:

permissions:
  contents: read
  issues: read
  pull-requests: read

concurrency:
  group: "gh-aw-${{ github.workflow }}"

run-name: "Smoke SRT Custom Config"

jobs:
  activation:
    runs-on: ubuntu-slim
    permissions:
      contents: read
    outputs:
      comment_id: ""
      comment_repo: ""
    steps:
      - name: Checkout actions folder
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          sparse-checkout: |
            actions
          persist-credentials: false
      - name: Setup Scripts
        uses: ./actions/setup
        with:
          destination: /opt/gh-aw/actions
      - name: Check workflow file timestamps
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_WORKFLOW_FILE: "smoke-srt-custom-config.lock.yml"
        with:
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/check_workflow_timestamp_api.cjs');
            await main();

  agent:
    needs: activation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read
    concurrency:
      group: "gh-aw-copilot-${{ github.workflow }}"
    outputs:
      model: ${{ steps.generate_aw_info.outputs.model }}
    steps:
      - name: Checkout actions folder
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          sparse-checkout: |
            actions
          persist-credentials: false
      - name: Setup Scripts
        uses: ./actions/setup
        with:
          destination: /opt/gh-aw/actions
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          persist-credentials: false
      - name: Create gh-aw temp directory
        run: bash /opt/gh-aw/actions/create_gh_aw_tmp_dir.sh
      - name: Configure Git credentials
        env:
          REPO_NAME: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          # Re-authenticate git with GitHub token
          SERVER_URL_STRIPPED="${SERVER_URL#https://}"
          git remote set-url origin "https://x-access-token:${{ github.token }}@${SERVER_URL_STRIPPED}/${REPO_NAME}.git"
          echo "Git configured with standard GitHub Actions identity"
      - name: Checkout PR branch
        if: |
          github.event.pull_request
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_TOKEN: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN || secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          github-token: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN || secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/checkout_pr_branch.cjs');
            await main();
      - name: Validate COPILOT_GITHUB_TOKEN secret
        run: /opt/gh-aw/actions/validate_multi_secret.sh COPILOT_GITHUB_TOKEN GitHub Copilot CLI https://githubnext.github.io/gh-aw/reference/engines/#github-copilot-default
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '24'
          package-manager-cache: false
      - name: Install Sandbox Runtime System Dependencies
        run: |
          echo "Installing system dependencies for Sandbox Runtime"
          sudo apt-get update
          sudo apt-get install -y ripgrep bubblewrap socat
          echo "System dependencies installed successfully"
          echo "Verifying installations:"
          rg --version
          bwrap --version
          socat -V
      - name: Configure System for Sandbox Runtime
        run: |
          echo "Disabling AppArmor namespace restrictions for bubblewrap"
          sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0
          echo "System configuration applied successfully"
      - name: Install Sandbox Runtime
        run: |
          echo "Installing @anthropic-ai/sandbox-runtime@0.0.25 locally"
          npm install @anthropic-ai/sandbox-runtime@0.0.25
          echo "Sandbox Runtime installed successfully"
      - name: Install GitHub Copilot CLI
        run: npm install --silent @github/copilot@0.0.376
      - name: Determine automatic lockdown mode for GitHub MCP server
        id: determine-automatic-lockdown
        env:
          TOKEN_CHECK: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN }}
        if: env.TOKEN_CHECK != ''
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const determineAutomaticLockdown = require('/opt/gh-aw/actions/determine_automatic_lockdown.cjs');
            await determineAutomaticLockdown(github, context, core);
      - name: Downloading container images
        run: bash /opt/gh-aw/actions/download_docker_images.sh ghcr.io/github/github-mcp-server:v0.27.0
      - name: Setup MCPs
        env:
          GITHUB_MCP_LOCKDOWN: ${{ steps.determine-automatic-lockdown.outputs.lockdown == 'true' && '1' || '0' }}
          GITHUB_MCP_SERVER_TOKEN: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN || secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p /tmp/gh-aw/mcp-config
          mkdir -p /home/runner/.copilot
          cat > /home/runner/.copilot/mcp-config.json << EOF
          {
            "mcpServers": {
              "github": {
                "type": "local",
                "command": "docker",
                "args": [
                  "run",
                  "-i",
                  "--rm",
                  "-e",
                  "GITHUB_PERSONAL_ACCESS_TOKEN",
                  "-e",
                  "GITHUB_READ_ONLY=1",
                  "-e",
                  "GITHUB_LOCKDOWN_MODE=$GITHUB_MCP_LOCKDOWN",
                  "-e",
                  "GITHUB_TOOLSETS=context,repos,issues,pull_requests",
                  "ghcr.io/github/github-mcp-server:v0.27.0"
                ],
                "tools": ["*"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "\${GITHUB_MCP_SERVER_TOKEN}"
                }
              }
            }
          }
          EOF
          echo "-------START MCP CONFIG-----------"
          cat /home/runner/.copilot/mcp-config.json
          echo "-------END MCP CONFIG-----------"
          echo "-------/home/runner/.copilot-----------"
          find /home/runner/.copilot
          echo "HOME: $HOME"
          echo "GITHUB_COPILOT_CLI_MODE: $GITHUB_COPILOT_CLI_MODE"
      - name: Generate agentic run info
        id: generate_aw_info
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            
            const awInfo = {
              engine_id: "copilot",
              engine_name: "GitHub Copilot CLI",
              model: process.env.GH_AW_MODEL_AGENT_COPILOT || "",
              version: "",
              agent_version: "0.0.376",
              workflow_name: "Smoke SRT Custom Config",
              experimental: false,
              supports_tools_allowlist: true,
              supports_http_transport: true,
              run_id: context.runId,
              run_number: context.runNumber,
              run_attempt: process.env.GITHUB_RUN_ATTEMPT,
              repository: context.repo.owner + '/' + context.repo.repo,
              ref: context.ref,
              sha: context.sha,
              actor: context.actor,
              event_name: context.eventName,
              staged: false,
              network_mode: "defaults",
              allowed_domains: ["defaults","github","node","python","java","go","ruby","rust","*.githubcopilot.com","example.com"],
              firewall_enabled: false,
              awf_version: "",
              steps: {
                firewall: ""
              },
              created_at: new Date().toISOString()
            };
            
            // Write to /tmp/gh-aw directory to avoid inclusion in PR
            const tmpPath = '/tmp/gh-aw/aw_info.json';
            fs.writeFileSync(tmpPath, JSON.stringify(awInfo, null, 2));
            console.log('Generated aw_info.json at:', tmpPath);
            console.log(JSON.stringify(awInfo, null, 2));
            
            // Set model as output for reuse in other steps/jobs
            core.setOutput('model', awInfo.model);
      - name: Generate workflow overview
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { generateWorkflowOverview } = require('/opt/gh-aw/actions/generate_workflow_overview.cjs');
            await generateWorkflowOverview(core);
      - name: Create prompt
        env:
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        run: |
          bash /opt/gh-aw/actions/create_prompt_first.sh
          cat << 'PROMPT_EOF' > "$GH_AW_PROMPT"
          **IMPORTANT: Keep all outputs extremely short and concise. Use single-line responses where possible. No verbose explanations.**
          
          Test the Sandbox Runtime (SRT) with custom configuration:
          
          1. Run `echo "Testing SRT with custom config"` using bash
          2. Verify you can access GitHub by running a simple github tool operation
          3. Check the environment with `env | grep -i copilot`
          
          Output a **very brief** summary (max 3-5 lines): ✅ or ❌ for each test, overall status.
          
          PROMPT_EOF
      - name: Append XPIA security instructions to prompt
        env:
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        run: |
          cat "/opt/gh-aw/prompts/xpia_prompt.md" >> "$GH_AW_PROMPT"
      - name: Append temporary folder instructions to prompt
        env:
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        run: |
          cat "/opt/gh-aw/prompts/temp_folder_prompt.md" >> "$GH_AW_PROMPT"
      - name: Append GitHub context to prompt
        env:
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GH_AW_GITHUB_ACTOR: ${{ github.actor }}
          GH_AW_GITHUB_EVENT_COMMENT_ID: ${{ github.event.comment.id }}
          GH_AW_GITHUB_EVENT_DISCUSSION_NUMBER: ${{ github.event.discussion.number }}
          GH_AW_GITHUB_EVENT_ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_AW_GITHUB_EVENT_PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
          GH_AW_GITHUB_REPOSITORY: ${{ github.repository }}
          GH_AW_GITHUB_RUN_ID: ${{ github.run_id }}
          GH_AW_GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          cat << 'PROMPT_EOF' >> "$GH_AW_PROMPT"
          <github-context>
          The following GitHub context information is available for this workflow:
          {{#if __GH_AW_GITHUB_ACTOR__ }}
          - **actor**: __GH_AW_GITHUB_ACTOR__
          {{/if}}
          {{#if __GH_AW_GITHUB_REPOSITORY__ }}
          - **repository**: __GH_AW_GITHUB_REPOSITORY__
          {{/if}}
          {{#if __GH_AW_GITHUB_WORKSPACE__ }}
          - **workspace**: __GH_AW_GITHUB_WORKSPACE__
          {{/if}}
          {{#if __GH_AW_GITHUB_EVENT_ISSUE_NUMBER__ }}
          - **issue-number**: #__GH_AW_GITHUB_EVENT_ISSUE_NUMBER__
          {{/if}}
          {{#if __GH_AW_GITHUB_EVENT_DISCUSSION_NUMBER__ }}
          - **discussion-number**: #__GH_AW_GITHUB_EVENT_DISCUSSION_NUMBER__
          {{/if}}
          {{#if __GH_AW_GITHUB_EVENT_PULL_REQUEST_NUMBER__ }}
          - **pull-request-number**: #__GH_AW_GITHUB_EVENT_PULL_REQUEST_NUMBER__
          {{/if}}
          {{#if __GH_AW_GITHUB_EVENT_COMMENT_ID__ }}
          - **comment-id**: __GH_AW_GITHUB_EVENT_COMMENT_ID__
          {{/if}}
          {{#if __GH_AW_GITHUB_RUN_ID__ }}
          - **workflow-run-id**: __GH_AW_GITHUB_RUN_ID__
          {{/if}}
          </github-context>
          
          PROMPT_EOF
      - name: Substitute placeholders
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GH_AW_GITHUB_ACTOR: ${{ github.actor }}
          GH_AW_GITHUB_EVENT_COMMENT_ID: ${{ github.event.comment.id }}
          GH_AW_GITHUB_EVENT_DISCUSSION_NUMBER: ${{ github.event.discussion.number }}
          GH_AW_GITHUB_EVENT_ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_AW_GITHUB_EVENT_PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
          GH_AW_GITHUB_REPOSITORY: ${{ github.repository }}
          GH_AW_GITHUB_RUN_ID: ${{ github.run_id }}
          GH_AW_GITHUB_WORKSPACE: ${{ github.workspace }}
        with:
          script: |
            const substitutePlaceholders = require('/opt/gh-aw/actions/substitute_placeholders.cjs');
            
            // Call the substitution function
            return await substitutePlaceholders({
              file: process.env.GH_AW_PROMPT,
              substitutions: {
                GH_AW_GITHUB_ACTOR: process.env.GH_AW_GITHUB_ACTOR,
                GH_AW_GITHUB_EVENT_COMMENT_ID: process.env.GH_AW_GITHUB_EVENT_COMMENT_ID,
                GH_AW_GITHUB_EVENT_DISCUSSION_NUMBER: process.env.GH_AW_GITHUB_EVENT_DISCUSSION_NUMBER,
                GH_AW_GITHUB_EVENT_ISSUE_NUMBER: process.env.GH_AW_GITHUB_EVENT_ISSUE_NUMBER,
                GH_AW_GITHUB_EVENT_PULL_REQUEST_NUMBER: process.env.GH_AW_GITHUB_EVENT_PULL_REQUEST_NUMBER,
                GH_AW_GITHUB_REPOSITORY: process.env.GH_AW_GITHUB_REPOSITORY,
                GH_AW_GITHUB_RUN_ID: process.env.GH_AW_GITHUB_RUN_ID,
                GH_AW_GITHUB_WORKSPACE: process.env.GH_AW_GITHUB_WORKSPACE
              }
            });
      - name: Interpolate variables and render templates
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        with:
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/interpolate_prompt.cjs');
            await main();
      - name: Print prompt
        env:
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        run: bash /opt/gh-aw/actions/print_prompt_summary.sh
      - name: Execute GitHub Copilot CLI
        id: agentic_execution
        # Copilot CLI tool arguments (sorted):
        # --allow-tool github
        # --allow-tool shell(cat)
        # --allow-tool shell(date)
        # --allow-tool shell(echo)
        # --allow-tool shell(grep)
        # --allow-tool shell(head)
        # --allow-tool shell(ls)
        # --allow-tool shell(pwd)
        # --allow-tool shell(sort)
        # --allow-tool shell(tail)
        # --allow-tool shell(uniq)
        # --allow-tool shell(wc)
        # --allow-tool shell(yq)
        # --allow-tool write
        timeout-minutes: 5
        run: |
          set -o pipefail

          # Pre-create required directories for Sandbox Runtime
          mkdir -p /home/runner/.copilot
          mkdir -p /tmp/claude

          # Create .srt-settings.json
          cat > .srt-settings.json << 'SRT_CONFIG_EOF'
          {
            "network": {
              "allowedDomains": [
                "*.githubcopilot.com",
                "*.githubusercontent.com",
                "*.pythonhosted.org",
                "*.rvm.io",
                "adoptium.net",
                "anaconda.org",
                "api.adoptium.net",
                "api.business.githubcopilot.com",
                "api.enterprise.githubcopilot.com",
                "api.github.com",
                "api.githubcopilot.com",
                "api.individual.githubcopilot.com",
                "api.npms.io",
                "api.rubygems.org",
                "api.snapcraft.io",
                "archive.ubuntu.com",
                "azure.archive.ubuntu.com",
                "binstar.org",
                "bootstrap.pypa.io",
                "bun.sh",
                "bundler.rubygems.org",
                "cache.ruby-lang.org",
                "codeload.github.com",
                "conda.anaconda.org",
                "conda.binstar.org",
                "crates.io",
                "crl.geotrust.com",
                "crl.globalsign.com",
                "crl.identrust.com",
                "crl.sectigo.com",
                "crl.thawte.com",
                "crl.usertrust.com",
                "crl.verisign.com",
                "crl3.digicert.com",
                "crl4.digicert.com",
                "crls.ssl.com",
                "deb.nodesource.com",
                "deno.land",
                "download.eclipse.org",
                "download.oracle.com",
                "example.com",
                "files.pythonhosted.org",
                "gems.rubyforge.org",
                "gems.rubyonrails.org",
                "get.pnpm.io",
                "github-cloud.githubusercontent.com",
                "github-cloud.s3.amazonaws.com",
                "github.com",
                "github.githubassets.com",
                "go.dev",
                "golang.org",
                "goproxy.io",
                "gradle.org",
                "host.docker.internal",
                "index.crates.io",
                "index.rubygems.org",
                "jcenter.bintray.com",
                "jdk.java.net",
                "json-schema.org",
                "json.schemastore.org",
                "keyserver.ubuntu.com",
                "lfs.github.com",
                "maven.apache.org",
                "maven.oracle.com",
                "maven.pkg.github.com",
                "nodejs.org",
                "npm.pkg.github.com",
                "npmjs.com",
                "npmjs.org",
                "objects.githubusercontent.com",
                "ocsp.digicert.com",
                "ocsp.geotrust.com",
                "ocsp.globalsign.com",
                "ocsp.identrust.com",
                "ocsp.sectigo.com",
                "ocsp.ssl.com",
                "ocsp.thawte.com",
                "ocsp.usertrust.com",
                "ocsp.verisign.com",
                "packagecloud.io",
                "packages.cloud.google.com",
                "packages.microsoft.com",
                "pip.pypa.io",
                "pkg.go.dev",
                "plugins-artifacts.gradle.org",
                "plugins.gradle.org",
                "ppa.launchpad.net",
                "proxy.golang.org",
                "pypi.org",
                "pypi.python.org",
                "raw.githubusercontent.com",
                "registry.bower.io",
                "registry.npmjs.com",
                "registry.npmjs.org",
                "registry.yarnpkg.com",
                "repo.anaconda.com",
                "repo.continuum.io",
                "repo.grails.org",
                "repo.maven.apache.org",
                "repo.spring.io",
                "repo.yarnpkg.com",
                "repo1.maven.org",
                "rubygems.org",
                "rubygems.pkg.github.com",
                "s.symcb.com",
                "s.symcd.com",
                "security.ubuntu.com",
                "services.gradle.org",
                "sh.rustup.rs",
                "skimdb.npmjs.com",
                "static.crates.io",
                "static.rust-lang.org",
                "sum.golang.org",
                "ts-crl.ws.symantec.com",
                "ts-ocsp.ws.symantec.com",
                "www.java.com",
                "www.npmjs.com",
                "www.npmjs.org",
                "yarnpkg.com"
              ],
              "blockedDomains": [],
              "allowUnixSockets": [
                "/var/run/docker.sock"
              ],
              "allowLocalBinding": false,
              "allowAllUnixSockets": true
            },
            "filesystem": {
              "denyRead": [],
              "allowWrite": [
                ".",
                "/tmp",
                "/home/runner/.copilot",
                "/home/runner"
              ],
              "denyWrite": []
            },
            "enableWeakerNestedSandbox": true
          }
          SRT_CONFIG_EOF

          # Create Node.js wrapper script for SRT
          cat > ./.srt-wrapper.js << 'SRT_WRAPPER_EOF'
          const { SandboxManager } = require('@anthropic-ai/sandbox-runtime');
          const { spawn } = require('child_process');
          const { readFileSync } = require('fs');

          async function main() {
            try {
              // Load the sandbox configuration from .srt-settings.json
              const configData = readFileSync('.srt-settings.json', 'utf-8');
              const config = JSON.parse(configData);

              // Initialize the sandbox (starts proxy servers, etc.)
              await SandboxManager.initialize(config);

              // Collect required environment variables for the sandboxed process
              // These need to be explicitly passed because bwrap doesn't inherit env vars
              // NOTE: Do NOT include GITHUB_TOKEN or GH_TOKEN here - they conflict with
              // COPILOT_GITHUB_TOKEN. The Copilot CLI checks these tokens and if it finds
              // the GitHub Actions default GITHUB_TOKEN (which is not valid for Copilot auth),
              // it will fail with "No authentication information found" even when
              // COPILOT_GITHUB_TOKEN is correctly set.
              const requiredEnvVars = [
                'COPILOT_GITHUB_TOKEN',
                'COPILOT_AGENT_RUNNER_TYPE',
                'XDG_CONFIG_HOME',
                'GITHUB_STEP_SUMMARY',
                'GITHUB_HEAD_REF',
                'GITHUB_REF_NAME',
                'GITHUB_WORKSPACE',
                'GH_AW_PROMPT',
                'GH_AW_MCP_CONFIG',
                'GITHUB_MCP_SERVER_TOKEN',
                'GH_AW_SAFE_OUTPUTS',
                'GH_AW_STARTUP_TIMEOUT',
                'GH_AW_TOOL_TIMEOUT',
                'GH_AW_MAX_TURNS',
              ];

              // Build environment variable export statements for the command
              // Use 'export' with semicolon to ensure variables propagate through nested bash invocations
              const envPrefix = requiredEnvVars
                .filter(key => process.env[key] !== undefined)
                .map(key => {
                  const value = process.env[key].replace(/'/g, "'\\''"); // Escape single quotes for shell
                  return "export " + key + "='" + value + "';";
                })
                .join(' ');

              // The command to run
              const baseCommand = 'node ./node_modules/.bin/copilot --add-dir /tmp/gh-aw/ --log-level all --log-dir /tmp/gh-aw/sandbox/agent/logs/ --add-dir "${GITHUB_WORKSPACE}" --disable-builtin-mcps --allow-tool github --allow-tool \'shell(cat)\' --allow-tool \'shell(date)\' --allow-tool \'shell(echo)\' --allow-tool \'shell(grep)\' --allow-tool \'shell(head)\' --allow-tool \'shell(ls)\' --allow-tool \'shell(pwd)\' --allow-tool \'shell(sort)\' --allow-tool \'shell(tail)\' --allow-tool \'shell(uniq)\' --allow-tool \'shell(wc)\' --allow-tool \'shell(yq)\' --allow-tool write --allow-all-paths --share /tmp/gh-aw/sandbox/agent/logs/conversation.md --prompt "$(cat /tmp/gh-aw/aw-prompts/prompt.txt)"${GH_AW_MODEL_DETECTION_COPILOT:+ --model "$GH_AW_MODEL_DETECTION_COPILOT"}';

              // Prepend environment variables to the command
              const command = envPrefix ? envPrefix + ' ' + baseCommand : baseCommand;

              // Wrap the command with sandbox restrictions
              const sandboxedCommand = await SandboxManager.wrapWithSandbox(command);

              // Execute the sandboxed command
              const child = spawn(sandboxedCommand, {
                shell: true,
                stdio: 'inherit',
                env: process.env
              });

              // Handle exit
              child.on('exit', async (code) => {
                // Cleanup when done
                await SandboxManager.reset();
                process.exit(code || 0);
              });

              // Handle errors
              child.on('error', async (err) => {
                console.error('Error executing command:', err);
                await SandboxManager.reset();
                process.exit(1);
              });
            } catch (err) {
              console.error('Fatal error:', err);
              try {
                await SandboxManager.reset();
              } catch (cleanupErr) {
                console.error('Error during cleanup:', cleanupErr);
              }
              process.exit(1);
            }
          }

          main();
          SRT_WRAPPER_EOF

          # Run the Node.js wrapper script
          node ./.srt-wrapper.js 2>&1 | tee /tmp/gh-aw/agent-stdio.log

          # Move preserved Copilot logs to expected location
          COPILOT_LOGS_DIR="$(find /tmp -maxdepth 1 -type d -name 'copilot-logs-*' -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -1 | cut -d' ' -f2)"
          if [ -n "$COPILOT_LOGS_DIR" ] && [ -d "$COPILOT_LOGS_DIR" ]; then
            echo "Moving Copilot logs from $COPILOT_LOGS_DIR to /tmp/gh-aw/sandbox/agent/logs/"
            mkdir -p /tmp/gh-aw/sandbox/agent/logs/
            mv "$COPILOT_LOGS_DIR"/* /tmp/gh-aw/sandbox/agent/logs/ || true
            rmdir "$COPILOT_LOGS_DIR" || true
          fi
        env:
          COPILOT_AGENT_RUNNER_TYPE: STANDALONE
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          GH_AW_MCP_CONFIG: /home/runner/.copilot/mcp-config.json
          GH_AW_MODEL_DETECTION_COPILOT: ${{ vars.GH_AW_MODEL_DETECTION_COPILOT || '' }}
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_MCP_SERVER_TOKEN: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN || secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_STEP_SUMMARY: ${{ env.GITHUB_STEP_SUMMARY }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          XDG_CONFIG_HOME: /home/runner
      - name: Copy Copilot session state files to logs
        if: always()
        continue-on-error: true
        run: |
          # Copy Copilot session state files to logs folder for artifact collection
          # This ensures they are in /tmp/gh-aw/ where secret redaction can scan them
          SESSION_STATE_DIR="$HOME/.copilot/session-state"
          LOGS_DIR="/tmp/gh-aw/sandbox/agent/logs"
          
          if [ -d "$SESSION_STATE_DIR" ]; then
            echo "Copying Copilot session state files from $SESSION_STATE_DIR to $LOGS_DIR"
            mkdir -p "$LOGS_DIR"
            cp -v "$SESSION_STATE_DIR"/*.jsonl "$LOGS_DIR/" 2>/dev/null || true
            echo "Session state files copied successfully"
          else
            echo "No session-state directory found at $SESSION_STATE_DIR"
          fi
      - name: Redact secrets in logs
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/redact_secrets.cjs');
            await main();
        env:
          GH_AW_SECRET_NAMES: 'COPILOT_GITHUB_TOKEN,GH_AW_GITHUB_MCP_SERVER_TOKEN,GH_AW_GITHUB_TOKEN,GITHUB_TOKEN'
          SECRET_COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          SECRET_GH_AW_GITHUB_MCP_SERVER_TOKEN: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN }}
          SECRET_GH_AW_GITHUB_TOKEN: ${{ secrets.GH_AW_GITHUB_TOKEN }}
          SECRET_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload engine output files
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: agent_outputs
          path: |
            /tmp/gh-aw/sandbox/agent/logs/
            /tmp/gh-aw/redacted-urls.log
          if-no-files-found: ignore
      - name: Parse agent logs for step summary
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_AGENT_OUTPUT: /tmp/gh-aw/sandbox/agent/logs/
        with:
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/parse_copilot_log.cjs');
            await main();
      - name: Upload agent artifacts
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: agent-artifacts
          path: |
            /tmp/gh-aw/aw-prompts/prompt.txt
            /tmp/gh-aw/aw_info.json
            /tmp/gh-aw/mcp-logs/
            /tmp/gh-aw/agent-stdio.log
          if-no-files-found: ignore

