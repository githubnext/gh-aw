name: Campaign Issue to PR

"on":
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-campaign-pr:
    if: contains(github.event.issue.labels.*.name, 'campaign')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          fetch-depth: 0

      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
        with:
          go-version-file: go.mod
          cache: true

      - run: make build

      - id: spec
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          SPEC_PATH=$(echo "$ISSUE_BODY" | ./gh-aw campaign new --from-issue)
          echo "campaign-id=$(basename "$SPEC_PATH" .campaign.md)" >> "$GITHUB_OUTPUT"
          echo "campaign-name=$(grep "^name:" "$SPEC_PATH" | sed 's/name: //')" >> "$GITHUB_OUTPUT"

      - run: ./gh-aw compile --validate --verbose

      - uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const { execSync } = require('child_process');
            const id = '${{ steps.spec.outputs.campaign-id }}';
            const name = '${{ steps.spec.outputs.campaign-name }}';
            const issue = context.payload.issue.number;
            
            execSync('git config user.name "github-actions[bot]"');
            execSync('git config user.email "github-actions[bot]@users.noreply.github.com"');
            execSync(`git checkout -b campaign/${id}`);
            execSync('git add .github/workflows/');
            execSync(`git commit -m "Add campaign spec for ${name} (#${issue})"`);
            execSync(`git push origin campaign/${id}`);
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Campaign: ${name}`,
              head: `campaign/${id}`,
              base: 'main',
              body: `Closes #${issue}`
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue,
              body: `Campaign spec PR created: #${pr.number}`
            });
