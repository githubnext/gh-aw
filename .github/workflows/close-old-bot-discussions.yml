name: Close Old Bot Discussions

on:
  schedule:
    - cron: "0 0 * * *"  # Daily at midnight UTC
  workflow_dispatch:

permissions:
  discussions: write

jobs:
  close-old-discussions:
    runs-on: ubuntu-latest
    steps:
      - name: Close discussions older than 1 month
        uses: actions/github-script@v7
        with:
          script: |
            const ONE_MONTH_MS = 30 * 24 * 60 * 60 * 1000;
            const cutoffDate = new Date(Date.now() - ONE_MONTH_MS);
            
            core.info(`Looking for discussions created by github-actions[bot] before ${cutoffDate.toISOString()}`);
            
            // Fetch all open discussions using GraphQL pagination
            let hasNextPage = true;
            let cursor = null;
            let closedCount = 0;
            
            while (hasNextPage) {
              const query = `
                query($owner: String!, $repo: String!, $cursor: String) {
                  repository(owner: $owner, name: $repo) {
                    discussions(first: 100, after: $cursor, states: [OPEN]) {
                      pageInfo {
                        hasNextPage
                        endCursor
                      }
                      nodes {
                        id
                        number
                        title
                        createdAt
                        author {
                          login
                        }
                      }
                    }
                  }
                }
              `;
              
              const result = await github.graphql(query, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                cursor: cursor
              });
              
              const discussions = result.repository.discussions.nodes;
              hasNextPage = result.repository.discussions.pageInfo.hasNextPage;
              cursor = result.repository.discussions.pageInfo.endCursor;
              
              for (const discussion of discussions) {
                // Check if created by github-actions[bot]
                if (discussion.author?.login !== 'github-actions[bot]') {
                  continue;
                }
                
                // Check if older than 1 month
                const createdAt = new Date(discussion.createdAt);
                if (createdAt >= cutoffDate) {
                  continue;
                }
                
                core.info(`Closing discussion #${discussion.number}: "${discussion.title}" (created ${discussion.createdAt})`);
                
                // Close the discussion with a comment
                const closeComment = `This discussion was automatically closed because it was created by github-actions[bot] more than 1 month ago.`;
                
                // Add a comment before closing
                await github.graphql(`
                  mutation($discussionId: ID!, $body: String!) {
                    addDiscussionComment(input: { discussionId: $discussionId, body: $body }) {
                      comment {
                        id
                      }
                    }
                  }
                `, {
                  discussionId: discussion.id,
                  body: closeComment
                });
                
                // Close the discussion
                await github.graphql(`
                  mutation($discussionId: ID!, $reason: DiscussionCloseReason!) {
                    closeDiscussion(input: { discussionId: $discussionId, reason: $reason }) {
                      discussion {
                        id
                      }
                    }
                  }
                `, {
                  discussionId: discussion.id,
                  reason: 'OUTDATED'
                });
                
                closedCount++;
              }
            }
            
            core.info(`Closed ${closedCount} discussion(s)`);
            
            // Write summary
            await core.summary
              .addHeading('Close Old Bot Discussions', 2)
              .addRaw(`Closed **${closedCount}** discussion(s) created by \`github-actions[bot]\` that were older than 1 month.`)
              .write();
