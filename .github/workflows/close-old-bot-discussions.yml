name: Close Old Bot Discussions

on:
  schedule:
    - cron: "0 0 * * *"  # Daily at midnight UTC
  workflow_dispatch:

permissions:
  discussions: write
  issues: write

jobs:
  close-old-discussions:
    runs-on: ubuntu-latest
    steps:
      - name: Close discussions older than 3 days
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const THREE_DAYS_MS = 3 * 24 * 60 * 60 * 1000;
            const GRAPHQL_DELAY_MS = 500;
            const cutoffDate = new Date(Date.now() - THREE_DAYS_MS);
            
            // Helper function for delay between API calls
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            core.info(`Looking for agentic workflow discussions (containing "> AI generated by") created before ${cutoffDate.toISOString()}`);
            
            // Fetch all open discussions using GraphQL pagination
            let hasNextPage = true;
            let cursor = null;
            let closedCount = 0;
            
            while (hasNextPage) {
              const query = `
                query($owner: String!, $repo: String!, $cursor: String) {
                  repository(owner: $owner, name: $repo) {
                    discussions(first: 100, after: $cursor, states: [OPEN]) {
                      pageInfo {
                        hasNextPage
                        endCursor
                      }
                      nodes {
                        id
                        number
                        title
                        body
                        createdAt
                        author {
                          login
                        }
                      }
                    }
                  }
                }
              `;
              
              const result = await github.graphql(query, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                cursor: cursor
              });
              
              const discussions = result.repository.discussions.nodes;
              hasNextPage = result.repository.discussions.pageInfo.hasNextPage;
              cursor = result.repository.discussions.pageInfo.endCursor;
              
              for (let i = 0; i < discussions.length; i++) {
                const discussion = discussions[i];
                // Check if created by an agentic workflow (body contains "> AI generated by" at start of line)
                const agenticPattern = /^> AI generated by/m;
                const isAgenticWorkflow = discussion.body && agenticPattern.test(discussion.body);
                if (!isAgenticWorkflow) {
                  continue;
                }
                
                // Check if older than 3 days
                const createdAt = new Date(discussion.createdAt);
                if (createdAt >= cutoffDate) {
                  continue;
                }
                
                core.info(`Closing discussion #${discussion.number}: "${discussion.title}" (created ${discussion.createdAt})`);
                
                // Close the discussion with a comment
                const closeComment = `This discussion was automatically closed because it was created by an agentic workflow more than 3 days ago.`;
                
                // Add a comment before closing
                await github.graphql(`
                  mutation($discussionId: ID!, $body: String!) {
                    addDiscussionComment(input: { discussionId: $discussionId, body: $body }) {
                      comment {
                        id
                      }
                    }
                  }
                `, {
                  discussionId: discussion.id,
                  body: closeComment
                });
                
                // Close the discussion
                await github.graphql(`
                  mutation($discussionId: ID!, $reason: DiscussionCloseReason!) {
                    closeDiscussion(input: { discussionId: $discussionId, reason: $reason }) {
                      discussion {
                        id
                      }
                    }
                  }
                `, {
                  discussionId: discussion.id,
                  reason: 'OUTDATED'
                });
                
                closedCount++;
                
                // Add delay between GraphQL operations to avoid rate limiting
                if (i < discussions.length - 1) {
                  await delay(GRAPHQL_DELAY_MS);
                }
              }
            }
            
            core.info(`Closed ${closedCount} discussion(s)`);
            
            // Write summary
            await core.summary
              .addHeading('Close Old Bot Discussions', 2)
              .addRaw(`Closed **${closedCount}** discussion(s) created by agentic workflows that were older than 3 days.`)
              .write();

  close-old-smoke-claude-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Close issues labeled smoke-claude older than 1 hour
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const ONE_HOUR_MS = 60 * 60 * 1000;
            const cutoffDate = new Date(Date.now() - ONE_HOUR_MS);
            
            core.info(`Looking for issues labeled "smoke-claude" created before ${cutoffDate.toISOString()}`);
            
            // Fetch all open issues with smoke-claude label
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'smoke-claude',
              per_page: 100
            });
            
            core.info(`Found ${issues.length} open issue(s) with smoke-claude label`);
            
            let closedCount = 0;
            
            for (const issue of issues) {
              // Skip pull requests (they show up in issues API)
              if (issue.pull_request) {
                continue;
              }
              
              // Check if older than 1 hour
              const createdAt = new Date(issue.created_at);
              if (createdAt >= cutoffDate) {
                core.info(`Skipping issue #${issue.number}: "${issue.title}" (created ${issue.created_at}, not old enough)`);
                continue;
              }
              
              core.info(`Closing issue #${issue.number}: "${issue.title}" (created ${issue.created_at})`);
              
              // Close the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'not_planned'
              });
              
              closedCount++;
              
              // Add delay between API calls to avoid rate limiting
              await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            core.info(`Closed ${closedCount} issue(s)`);
            
            // Write summary
            await core.summary
              .addHeading('Close Old Smoke-Claude Issues', 2)
              .addRaw(`Closed **${closedCount}** issue(s) labeled with "smoke-claude" that were older than 1 hour.`)
              .write();
