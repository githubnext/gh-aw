---
on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, synchronize]
  schedule:
    - cron: "0 9 * * 1"  # Weekly on Mondays at 9 AM

safe-outputs:
  create-code-scanning-alert:
    max: 10
  staged: true

engine:
  id: custom
  steps:
    - name: Generate Code Scanning Alert Safe Output
      run: |
        # Generate a test security finding - error level
        echo '{"type": "create-code-scanning-alert", "file": "src/main.js", "line": 15, "column": 8, "severity": "error", "message": "This is a test security finding generated by the custom engine workflow to validate the create-code-scanning-alert safe output functionality. This represents a high-severity security issue for testing purposes and does not indicate an actual vulnerability.", "ruleIdSuffix": "test-custom-engine-error"}' >> $GITHUB_AW_SAFE_OUTPUTS
        
        # Generate a warning level finding
        echo '{"type": "create-code-scanning-alert", "file": "package.json", "line": 25, "severity": "warning", "message": "Test warning-level security finding for dependency management. This is a simulated finding to test warning-level alert generation.", "ruleIdSuffix": "test-dependency-warning"}' >> $GITHUB_AW_SAFE_OUTPUTS
        
        # Generate an info level finding
        echo '{"type": "create-code-scanning-alert", "file": "README.md", "line": 1, "severity": "info", "message": "Informational security finding for documentation. This tests the info-level severity in the SARIF generation process.", "ruleIdSuffix": "test-documentation-info"}' >> $GITHUB_AW_SAFE_OUTPUTS
        
        # Generate a note level finding
        echo '{"type": "create-code-scanning-alert", "file": "config/settings.yml", "line": 10, "column": 15, "severity": "note", "message": "This is a note-level security finding used for testing the create-code-scanning-alert safe output functionality. It demonstrates the lowest severity level available in SARIF reports.", "ruleIdSuffix": "test-config-note"}' >> $GITHUB_AW_SAFE_OUTPUTS
        
        # Generate a finding without custom rule ID suffix (tests default naming)
        echo '{"type": "create-code-scanning-alert", "file": "lib/utils.py", "line": 42, "severity": "warning", "message": "Test finding without custom rule ID suffix to validate default SARIF rule naming convention."}' >> $GITHUB_AW_SAFE_OUTPUTS
        
    - name: Verify Safe Output File
      run: |
        echo "Generated safe output entries:"
        if [ -f "$GITHUB_AW_SAFE_OUTPUTS" ]; then
          cat "$GITHUB_AW_SAFE_OUTPUTS"
        else
          echo "No safe outputs file found"
        fi

permissions: read-all
---

# Test Safe Output - Create Code Scanning Alert

This workflow tests the `create-code-scanning-alert` safe output functionality using a custom engine that directly writes to the safe output file.

## Purpose

This workflow validates the create-code-scanning-alert safe output type by:
- Generating JSON entries with the `create-code-scanning-alert` type
- Including all required fields: file, line, severity, message
- Testing all severity levels: error, warning, info, note
- Testing optional fields: column, ruleIdSuffix
- Using staged mode to prevent actual GitHub interactions
- Demonstrating custom engine safe output writing for security findings

## Trigger Events

- **workflow_dispatch**: Manual execution for testing
- **push**: Responds to pushes on main and develop branches (common for security scans)
- **pull_request.opened**: Responds to new pull requests
- **pull_request.synchronize**: Responds to PR updates
- **schedule**: Weekly security scan simulation

## Safe Output Configuration

- **staged: true**: Prevents real GitHub interactions
- **max: 10**: Allows up to 10 security findings per workflow run

## Custom Engine Implementation

The workflow uses a custom engine with GitHub Actions steps to:
1. Generate multiple security finding JSON outputs with different severity levels
2. Test all supported severity levels (error, warning, info, note)
3. Include both required and optional fields
4. Test custom rule ID suffixes and default naming
5. Target different file types (JavaScript, JSON, Markdown, YAML, Python)
6. Append entries to the $GITHUB_AW_SAFE_OUTPUTS file
7. Verify the outputs were generated correctly

This demonstrates how custom engines can leverage the safe output system for creating SARIF-compliant security findings that integrate with GitHub Code Scanning, enabling automated security reporting.