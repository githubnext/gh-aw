---
on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize]

safe-outputs:
  push-to-pr-branch:
    target: "*"
    if-no-changes: "warn"
  staged: true

engine:
  id: custom
  steps:
    - name: Create Test File Changes for Branch Push
      run: |
        # Create test files to demonstrate branch push functionality
        echo "# Branch Push Test File" > branch-push-test-$(date +%Y%m%d-%H%M%S).md
        echo "This file tests the push-to-pr-branch safe output functionality." >> branch-push-test-$(date +%Y%m%d-%H%M%S).md
        echo "Created by custom engine at: $(date)" >> branch-push-test-$(date +%Y%m%d-%H%M%S).md
        echo "Event: ${{ github.event_name }}" >> branch-push-test-$(date +%Y%m%d-%H%M%S).md
        echo "Repository: ${{ github.repository }}" >> branch-push-test-$(date +%Y%m%d-%H%M%S).md
        echo "Run ID: ${{ github.run_id }}" >> branch-push-test-$(date +%Y%m%d-%H%M%S).md
        
        # Create another test file for additional changes
        echo "# Additional Changes File" > additional-changes-$(date +%Y%m%d-%H%M%S).txt
        echo "This demonstrates multiple file changes in a single push." >> additional-changes-$(date +%Y%m%d-%H%M%S).txt
        echo "Timestamp: $(date)" >> additional-changes-$(date +%Y%m%d-%H%M%S).txt
        
    - name: Generate Push to PR Branch Safe Output
      run: |
        echo '{"type": "push-to-pr-branch", "message": "Custom engine test: Push to branch functionality\n\nThis commit was generated by the test-safe-output-push-to-pr-branch workflow to validate the push-to-pr-branch safe output functionality.\n\nFiles created:\n- branch-push-test-[timestamp].md\n- additional-changes-[timestamp].txt\n\nTest Information:\n- Safe Output Type: push-to-pr-branch\n- Engine: Custom (GitHub Actions steps)\n- Test executed at: '"$(date)"'\n- Event: ${{ github.event_name }}\n- Staged Mode: true\n\nThis push should not modify actual GitHub branches due to staged mode."}' >> $GITHUB_AW_SAFE_OUTPUTS
        
    - name: Verify Safe Output File
      run: |
        echo "Generated safe output entries:"
        if [ -f "$GITHUB_AW_SAFE_OUTPUTS" ]; then
          cat "$GITHUB_AW_SAFE_OUTPUTS"
        else
          echo "No safe outputs file found"
        fi
        
        echo "Test files created for push:"
        ls -la *.md *.txt 2>/dev/null || echo "No test files found"

permissions: read-all
---

# Test Safe Output - Push to PR Branch

This workflow tests the `push-to-pr-branch` safe output functionality using a custom engine that creates file changes and writes to the safe output file.

## Purpose

This workflow validates the push-to-pr-branch safe output type by:
- Creating actual file changes to push to the branch
- Generating a JSON entry with the `push-to-pr-branch` type
- Including a descriptive commit message
- Using staged mode to prevent actual GitHub interactions
- Demonstrating custom engine safe output writing for branch pushes

## Trigger Events

- **workflow_dispatch**: Manual execution for testing
- **pull_request.opened**: Responds to new pull requests being created
- **pull_request.synchronize**: Responds to PR updates

## Safe Output Configuration

- **staged: true**: Prevents real GitHub interactions
- **target: "*"**: Allows pushes to any pull request (with pull_request_number in output)
- **if-no-changes: "warn"**: Warns but succeeds if no changes are detected

## Custom Engine Implementation

The workflow uses a custom engine with GitHub Actions steps to:
1. Create multiple test files to demonstrate file changes
2. Generate the appropriate push-to-pr-branch JSON output
3. Include a comprehensive commit message with test information
4. Append it to the $GITHUB_AW_SAFE_OUTPUTS file
5. Verify both the output and created files

This demonstrates how custom engines can leverage the safe output system for pushing changes to PR branches while creating actual file modifications.