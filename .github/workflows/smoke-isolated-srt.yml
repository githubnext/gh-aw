name: "Smoke Isolated SRT"

on:
  pull_request:
    types:
      - labeled
  workflow_dispatch: null

permissions:
  contents: read

jobs:
  test-srt-env:
    if: >
      (github.event_name != 'pull_request') ||
      ((github.event.action != 'labeled') || (github.event.label.name == 'test-srt'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Sandbox Runtime System Dependencies
        run: |
          echo "Installing system dependencies for Sandbox Runtime"
          sudo apt-get update
          sudo apt-get install -y ripgrep bubblewrap socat
          echo "System dependencies installed successfully"
          echo "Verifying installations:"
          rg --version
          bwrap --version
          socat -V

      - name: Configure System
        run: |
          echo "Disabling AppArmor namespace restrictions for bubblewrap"
          sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0

      - name: Install Sandbox Runtime
        run: |
          echo "Installing @anthropic-ai/sandbox-runtime"
          npm install @anthropic-ai/sandbox-runtime

      - name: Install GitHub Copilot CLI
        run: npm install @github/copilot@0.0.358

      - name: Test Copilot (without SRT)
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN || secrets.COPILOT_CLI_TOKEN }}
          COPILOT_AGENT_RUNNER_TYPE: STANDALONE
        run: |
          echo "=== Testing Copilot directly (no sandbox) ==="
          echo "COPILOT_GITHUB_TOKEN length: ${#COPILOT_GITHUB_TOKEN}"
          echo "COPILOT_AGENT_RUNNER_TYPE: $COPILOT_AGENT_RUNNER_TYPE"
          echo ""
          echo "Running: ./node_modules/.bin/copilot -p \"what's on example.com\" --allow-all-tools"
          ./node_modules/.bin/copilot -p "what's on example.com" --allow-all-tools
          echo ""
          echo "âœ“ Copilot authentication works without SRT"

      - name: Test Copilot with SRT
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN || secrets.COPILOT_CLI_TOKEN }}
          COPILOT_AGENT_RUNNER_TYPE: STANDALONE
          XDG_CONFIG_HOME: /home/runner
        run: |
          set -e

          # Pre-create copilot directory for auth cache
          mkdir -p /home/runner/.copilot

          # Create minimal SRT config
          cat > .srt-settings.json << 'EOF'
          {
            "network": {
              "allowedDomains": [
                "*.githubusercontent.com",
                "api.enterprise.githubcopilot.com",
                "api.github.com",
                "api.snapcraft.io",
                "archive.ubuntu.com",
                "azure.archive.ubuntu.com",
                "codeload.github.com",
                "crl.geotrust.com",
                "crl.globalsign.com",
                "crl.identrust.com",
                "crl.sectigo.com",
                "crl.thawte.com",
                "crl.usertrust.com",
                "crl.verisign.com",
                "crl3.digicert.com",
                "crl4.digicert.com",
                "crls.ssl.com",
                "github-cloud.githubusercontent.com",
                "github-cloud.s3.amazonaws.com",
                "github.com",
                "json-schema.org",
                "json.schemastore.org",
                "keyserver.ubuntu.com",
                "lfs.github.com",
                "objects.githubusercontent.com",
                "ocsp.digicert.com",
                "ocsp.geotrust.com",
                "ocsp.globalsign.com",
                "ocsp.identrust.com",
                "ocsp.sectigo.com",
                "ocsp.ssl.com",
                "ocsp.thawte.com",
                "ocsp.usertrust.com",
                "ocsp.verisign.com",
                "packagecloud.io",
                "packages.cloud.google.com",
                "packages.microsoft.com",
                "ppa.launchpad.net",
                "raw.githubusercontent.com",
                "registry.npmjs.org",
                "registry.npmjs.com",
                "registry.bower.io",
                "registry.yarnpkg.com",
                "repo.yarnpkg.com",
                "api.npms.io",
                "bun.sh",
                "deb.nodesource.com",
                "deno.land",
                "get.pnpm.io",
                "nodejs.org",
                "npm.pkg.github.com",
                "npmjs.com",
                "npmjs.org",
                "www.npmjs.com",
                "www.npmjs.org",
                "yarnpkg.com",
                "skimdb.npmjs.com",
                "s.symcb.com",
                "s.symcd.com",
                "security.ubuntu.com",
                "ts-crl.ws.symantec.com",
                "ts-ocsp.ws.symantec.com",
                "example.com"
              ],
              "allowUnixSockets": [
                "/var/run/docker.sock"
              ],
              "allowLocalBinding": false
            },
            "filesystem": {
              "allowWrite": [".", "/home/runner/.copilot", "/tmp", "/home/runner"]
            },
            "enableWeakerNestedSandbox": true
          }
          EOF

          echo "=== SRT Config ==="
          cat .srt-settings.json

          # Create SRT wrapper
          cat > ./.srt-wrapper.js << 'EOF'
          const { SandboxManager } = require('@anthropic-ai/sandbox-runtime');
          const { spawn } = require('child_process');
          const { readFileSync } = require('fs');

          async function main() {
            try {
              const configData = readFileSync('.srt-settings.json', 'utf-8');
              const config = JSON.parse(configData);

              console.log('=== Initializing Sandbox Runtime ===');
              await SandboxManager.initialize(config);
              console.log('Sandbox Runtime initialized');

              // Environment variables to pass through
              const requiredEnvVars = [
                'COPILOT_GITHUB_TOKEN',
                'COPILOT_AGENT_RUNNER_TYPE',
                'XDG_CONFIG_HOME',
              ];

              console.log('\n=== Environment Variables in Node.js ===');
              requiredEnvVars.forEach(key => {
                if (process.env[key] !== undefined) {
                  const displayValue = key.includes('TOKEN') ?
                    `[${process.env[key].length} chars]` :
                    process.env[key];
                  console.log(`  ${key}=${displayValue}`);
                } else {
                  console.log(`  ${key}=<not set>`);
                }
              });

              // Build export statements AND also test the env vars are in process.env
              const envPrefix = requiredEnvVars
                .filter(key => process.env[key] !== undefined)
                .map(key => {
                  const value = process.env[key].replace(/'/g, "'\\''");
                  return `export ${key}='${value}';`;
                })
                .join(' ');

              console.log('\n=== Export Prefix ===');
              console.log(`Length: ${envPrefix.length} chars`);

              // Test command - check filesystem access and run copilot
              const command = envPrefix + ' echo "=== Inside Sandbox ===" && echo "XDG_CONFIG_HOME=$XDG_CONFIG_HOME" && echo "HOME=$HOME" && node -e "console.log(\'Node.js sees COPILOT_GITHUB_TOKEN:\', process.env.COPILOT_GITHUB_TOKEN ? \'YES [length \' + process.env.COPILOT_GITHUB_TOKEN.length + \']\' : \'NO\'); console.log(\'Node.js sees COPILOT_AGENT_RUNNER_TYPE:\', process.env.COPILOT_AGENT_RUNNER_TYPE || \'NO\'); console.log(\'Node.js sees XDG_CONFIG_HOME:\', process.env.XDG_CONFIG_HOME || \'NO\');" && echo "=== Current directory ===" && pwd && echo "=== Copilot directory check ===" && ls -la /home/runner/.copilot || echo "Directory does not exist" && echo "=== Copilot binary exists? ===" && ls -la ./node_modules/.bin/copilot && echo "=== Running copilot ===" && node ./node_modules/.bin/copilot -p "what\'s on example.com" --allow-all-tools';

              console.log('\n=== Command Length ===');
              console.log(`Total: ${command.length} chars`);

              // Wrap with sandbox
              const sandboxedCommand = await SandboxManager.wrapWithSandbox(command);

              console.log('\n=== Sandboxed Command ===');
              console.log(sandboxedCommand);

              console.log('\n=== Executing Command ===');

              // Build environment for the sandboxed process
              // Pass all required env vars directly through spawn's env option
              const sandboxEnv = { ...process.env };
              requiredEnvVars.forEach(key => {
                if (process.env[key] !== undefined) {
                  sandboxEnv[key] = process.env[key];
                }
              });

              console.log('\n=== Environment passed to spawn ===');
              requiredEnvVars.forEach(key => {
                if (sandboxEnv[key] !== undefined) {
                  const displayValue = key.includes('TOKEN') ?
                    `[${sandboxEnv[key].length} chars]` :
                    sandboxEnv[key];
                  console.log(`  ${key}=${displayValue}`);
                }
              });

              // Execute
              const child = spawn(sandboxedCommand, {
                shell: true,
                stdio: 'inherit',
                env: sandboxEnv
              });

              child.on('exit', async (code) => {
                console.log(`\n=== Command exited with code ${code} ===`);
                await SandboxManager.reset();
                process.exit(code || 0);
              });

              child.on('error', async (err) => {
                console.error('\n=== Error executing command ===', err);
                await SandboxManager.reset();
                process.exit(1);
              });
            } catch (err) {
              console.error('\n=== Fatal error ===', err);
              try {
                await SandboxManager.reset();
              } catch (cleanupErr) {
                console.error('Error during cleanup:', cleanupErr);
              }
              process.exit(1);
            }
          }

          main();
          EOF

          echo ""
          echo "=== Running SRT Wrapper ==="
          node ./.srt-wrapper.js
