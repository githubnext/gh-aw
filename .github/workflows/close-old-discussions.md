---
description: Automatically closes outdated discussions - agentic workflow discussions older than 3 days, and daily reports superseded by fresher versions
on:
  workflow_dispatch:
  schedule:
    - cron: "0 14 * * 1-5"  # Weekdays at 2 PM UTC
permissions:
  contents: read
  actions: read
  discussions: read
  issues: read
  pull-requests: read
engine: codex
imports:
  - shared/jqschema.md
  - shared/discussions-data-fetch.md
tools:
  github:
    toolsets: [default, discussions]
  bash:
    - "jq *"
    - "cat *"
    - "date *"
safe-outputs:
  close-discussion:
    max: 100
timeout-minutes: 10
strict: true
steps:
  - name: Analyze and filter discussions
    id: analyze-discussions
    run: |
      # Calculate cutoff date (3 days ago)
      CUTOFF_DATE=$(date -u -d '3 days ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-3d +%Y-%m-%dT%H:%M:%SZ)
      echo "Cutoff date for old discussions: $CUTOFF_DATE"
      
      # Check if discussions data exists
      DISCUSSIONS_FILE="/tmp/gh-aw/discussions-data/discussions.json"
      if [ ! -f "$DISCUSSIONS_FILE" ]; then
        echo "No discussions data found"
        echo '[]' > /tmp/gh-aw/old-discussions.json
        echo '[]' > /tmp/gh-aw/superseded-reports.json
        exit 0
      fi
      
      # 1. Find old agentic workflow discussions (older than 3 days, created by agentic workflows)
      # Uses isAgenticWorkflow flag which checks for "> AI generated by" in body
      jq --arg cutoff "$CUTOFF_DATE" '
        [.[] | select(
          .isAgenticWorkflow == true and 
          .createdAt < $cutoff
        )]
      ' "$DISCUSSIONS_FILE" > /tmp/gh-aw/old-discussions.json
      
      OLD_COUNT=$(jq 'length' /tmp/gh-aw/old-discussions.json)
      echo "Found $OLD_COUNT old agentic workflow discussions (>3 days)"
      
      # 2. Find superseded daily reports (reports with fresher versions)
      # Daily reports typically have titles like "Daily Report - 2025-11-25" or "[Report] Activity Summary - Nov 25"
      # We want to keep only the newest report of each type/category and close older ones
      jq '
        # Filter to only agentic workflow discussions with report-like titles
        [.[] | select(
          .isAgenticWorkflow == true and
          (.title | test("report|summary|analysis|digest|update|insights|metrics|status"; "i"))
        )] |
        
        # Group by title pattern (extract base title without date)
        group_by(
          .title | 
          # Remove common date patterns from title to get base report name
          gsub(" - [0-9]{4}-[0-9]{2}-[0-9]{2}.*$"; "") |
          gsub(" - (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) [0-9]{1,2}.*$"; "") |
          gsub(" [0-9]{4}-[0-9]{2}-[0-9]{2}$"; "") |
          gsub(" \\([0-9]{4}-[0-9]{2}-[0-9]{2}\\)$"; "") |
          gsub("\\[.*\\] "; "")
        ) |
        
        # For each group, keep only the latest and mark others as superseded
        map(
          sort_by(.createdAt) | reverse |
          # Skip the first (newest) and mark rest as superseded
          .[1:] // []
        ) |
        flatten
      ' "$DISCUSSIONS_FILE" > /tmp/gh-aw/superseded-reports.json
      
      SUPERSEDED_COUNT=$(jq 'length' /tmp/gh-aw/superseded-reports.json)
      echo "Found $SUPERSEDED_COUNT superseded daily reports"
      
      # 3. Mark superseded reports with a flag
      jq 'map(. + {is_superseded_report: true})' /tmp/gh-aw/superseded-reports.json > /tmp/gh-aw/superseded-reports-flagged.json
      
      # 4. Mark old discussions as NOT superseded reports
      jq 'map(. + {is_superseded_report: false})' /tmp/gh-aw/old-discussions.json > /tmp/gh-aw/old-discussions-flagged.json
      
      # 5. Merge and deduplicate the two lists (superseded reports take priority for the flag)
      jq -s '
        # Flatten both arrays
        add | 
        # Group by discussion number to handle duplicates
        group_by(.number) |
        # For each group, prefer the one marked as superseded (if any)
        map(
          if length == 1 then .[0]
          else (
            # If there are duplicates, keep the superseded version if it exists
            if any(.is_superseded_report) then
              (.[] | select(.is_superseded_report))
            else
              .[0]
            end
          )
          end
        ) |
        # Clean up and normalize the output
        map({
          number,
          title,
          createdAt,
          author,
          category: (.category // "unknown"),
          is_superseded_report
        })
      ' /tmp/gh-aw/old-discussions-flagged.json /tmp/gh-aw/superseded-reports-flagged.json > /tmp/gh-aw/discussions-to-close.json
      
      TOTAL_COUNT=$(jq 'length' /tmp/gh-aw/discussions-to-close.json)
      echo "Total discussions to close: $TOTAL_COUNT"
      
      # Output for agent analysis
      jq -c '.[]' /tmp/gh-aw/discussions-to-close.json > /tmp/gh-aw/filtered-discussions.jsonl
      
      # Summary for logging
      echo ""
      echo "=== Summary ==="
      echo "Old bot discussions (>3 days): $OLD_COUNT"
      echo "Superseded reports: $SUPERSEDED_COUNT"
      echo "Total to close (deduplicated): $TOTAL_COUNT"
    env:
      GH_TOKEN: ${{ github.token }}
---

# Close Outdated Discussions

This workflow automatically closes outdated discussions:
1. **Old agentic workflow discussions**: Discussions created by agentic workflows (identified by "> AI generated by" in body) that are older than 3 days
2. **Superseded reports**: Daily/weekly reports that have been superseded by fresher versions with the same title pattern

## Pre-filtered Discussion Data

The workflow has already analyzed discussions using the shared `discussions-data-fetch.md` component. The filtered data is available in `/tmp/gh-aw/filtered-discussions.jsonl` with discussions that meet one of these criteria:
- Created by an agentic workflow (contains "> AI generated by" footer) AND older than 3 days
- Is a report-type discussion (title contains "report", "summary", "analysis", etc.) that has been superseded by a newer version

Each line in the JSONL file has this structure:
```json
{"number":123,"title":"Daily Report - 2025-11-20","createdAt":"2025-11-20T10:00:00Z","author":"pelikhan","category":"General","is_superseded_report":true}
```

## Task

Read the pre-filtered discussion data from `/tmp/gh-aw/filtered-discussions.jsonl` and generate `close_discussion` outputs for each discussion.

**Important**: Do NOT call the GitHub API to list discussions - the data has already been fetched and analyzed.

### Instructions

1. **Read the filtered data**: Load `/tmp/gh-aw/filtered-discussions.jsonl` using bash `cat` command
2. **Generate close outputs**: For each discussion in the file, create a `close_discussion` output with an appropriate closing message:
   - For **superseded reports** (`is_superseded_report: true`): Use message like "This report has been superseded by a newer version and is now closed as outdated."
   - For **old agentic workflow discussions**: Use message like "This discussion was automatically closed because it was created by an agentic workflow more than 3 days ago."
   - **reason**: Always use "OUTDATED"

### Output Format

Output each close_discussion as a JSONL line:
```jsonl
{"type":"close_discussion","discussion_number":123,"body":"<closing message>","reason":"OUTDATED"}
```

### Example

If `/tmp/gh-aw/filtered-discussions.jsonl` contains:
```jsonl
{"number":1234,"title":"Daily Report - 2025-11-10","createdAt":"2025-11-10T00:00:00Z","author":"github-actions[bot]","is_superseded_report":true}
{"number":1235,"title":"Weekly Analysis","createdAt":"2025-11-11T00:00:00Z","author":"github-actions[bot]","is_superseded_report":false}
```

You should output:
```jsonl
{"type":"close_discussion","discussion_number":1234,"body":"This report has been superseded by a newer version and is now closed as outdated.","reason":"OUTDATED"}
{"type":"close_discussion","discussion_number":1235,"body":"This discussion was automatically closed because it was created by an agentic workflow more than 3 days ago.","reason":"OUTDATED"}
```

## Notes

- Maximum closures: Up to 100 discussions per run (configured via safe-outputs max)
- Data is pre-filtered: No need to check author or age - all discussions in the file should be closed
- If the file is empty or doesn't exist: Use the `noop` tool to report that no discussions need to be closed

Begin the task now. Read the filtered data and generate close_discussion outputs.
