name: Secrets Diagnostics

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Mondays at 9:00 AM UTC
    - cron: '0 9 * * 1'

permissions:
  contents: read

jobs:
  diagnostics:
    name: Run Secrets Diagnostics
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      
      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: '22'
      
      - name: Run diagnostics script
        id: diagnostics
        env:
          # GitHub tokens
          GH_AW_GITHUB_TOKEN: ${{ secrets.GH_AW_GITHUB_TOKEN }}
          GH_AW_GITHUB_MCP_SERVER_TOKEN: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN }}
          GH_AW_PROJECT_GITHUB_TOKEN: ${{ secrets.GH_AW_PROJECT_GITHUB_TOKEN }}
          GH_AW_COPILOT_TOKEN: ${{ secrets.GH_AW_COPILOT_TOKEN }}
          # AI Engine API keys
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
          # Integration tokens
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          # Repository context
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          node .github/scripts/secrets-diagnostics.cjs
      
      - name: Display report in step summary
        if: always()
        run: |
          echo "# üîê Secrets Diagnostic Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f diagnostics.md ]; then
            cat diagnostics.md >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è No diagnostic report generated" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload diagnostic report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: secrets-diagnostic-report
          path: diagnostics.md
          retention-days: 30
          if-no-files-found: error
      
      - name: Check for failures
        if: always()
        run: |
          if [ -f diagnostics.md ]; then
            # Count failures in the report
            FAILURES=$(grep -c "‚ùå Failed:" diagnostics.md || echo "0")
            NOT_SET=$(grep -c "‚ö™ Not Set:" diagnostics.md || echo "0")
            
            echo "üìä Test Results Summary:"
            echo "  - Failures: $FAILURES"
            echo "  - Not Set: $NOT_SET"
            
            if [ "$FAILURES" -gt "0" ]; then
              echo ""
              echo "‚ö†Ô∏è Some secrets failed validation. Check the diagnostic report for details."
              echo "This is informational only - the workflow will not fail."
            fi
            
            if [ "$NOT_SET" -gt "0" ]; then
              echo ""
              echo "‚ÑπÔ∏è Some secrets are not configured. This is expected if they are not needed."
            fi
          else
            echo "‚ùå Diagnostic report not found"
            exit 1
          fi
