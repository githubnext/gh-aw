# This file was automatically generated by gh-aw. DO NOT EDIT.
# To update this file, edit the corresponding .md file and run:
#   gh aw compile

name: "Codex Pull Request Summary"
on:
    pull_request:
        branches:
            - '*codex*'
        types:
            - opened
            - synchronize
            - reopened
    workflow_dispatch: null

permissions: {}

concurrency:
  group: "gh-aw-${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

run-name: "Codex Pull Request Summary"

jobs:
  task:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      text: ${{ steps.compute-text.outputs.text }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github
          fetch-depth: 1
      - name: Compute current body text
        id: compute-text
        uses: ./.github/actions/compute-text

  add-reaction:
    needs: task
    if: github.event_name == 'issues' || github.event_name == 'pull_request' || github.event_name == 'issue_comment' || github.event_name == 'pull_request_comment' || github.event_name == 'pull_request_review_comment'
    runs-on: ubuntu-latest
    permissions:
      contents: write # Read .github
      issues: write
      pull-requests: write
    outputs:
      reaction_id: ${{ steps.react.outputs.reaction-id }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github
      - name: Add eyes reaction to the triggering item
        id: react
        uses: ./.github/actions/reaction
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          mode: add
          reaction: eyes

  codex-pull-request-summary:
    needs: task
    runs-on: ubuntu-latest
    permissions:
        actions: read
        contents: read
        issues: read
        pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      - name: Install Codex
        run: npm install -g @openai/codex
      - name: Setup MCPs
        run: |
          mkdir -p /tmp/mcp-config
          cat > /tmp/mcp-config/config.toml << EOF
          
          [mcp_servers.github]
          command = "docker"
          args = [
            "run",
            "-i",
            "--rm",
            "-e",
            "GITHUB_PERSONAL_ACCESS_TOKEN",
            "ghcr.io/github/github-mcp-server:sha-45e90ae"
          ]
          env = { "GITHUB_PERSONAL_ACCESS_TOKEN" = "${{ secrets.GITHUB_TOKEN }}" }
          EOF
      - name: Create prompt
        run: |
          mkdir -p /tmp/aw-prompts
          cat > /tmp/aw-prompts/prompt.txt << 'EOF'
          # Codex Pull Request Summary
          
          ## Job Description
          
          You are a code review assistant powered by Codex. Your task is to analyze the changes in this pull request and provide a comprehensive summary.
          
          ### Analysis Tasks
          
          1. **Review the Pull Request Details**
             - Examine the PR title, description, and metadata
             - Identify the branch name and verify it contains "codex"
             - List all modified, added, and deleted files
          
          2. **Code Change Analysis**
             - Analyze the diff for each changed file
             - Identify the purpose and impact of each change
             - Look for patterns, refactoring, new features, or bug fixes
             - Assess code quality and potential issues
          
          3. **Generate Summary Report**
             Create a detailed comment on the pull request with the following sections:
          
             #### 🤖 Codex PR Summary
             
             **Branch:** `${{ github.head_ref }}`
             **Files Changed:** [number] files
             
             #### 📋 Change Overview
             - Brief description of what this PR accomplishes
             - Type of changes (feature, bugfix, refactor, docs, etc.)
             
             #### 📁 Files Modified
             For each changed file:
             - **File:** `path/to/file`
             - **Change Type:** Added/Modified/Deleted
             - **Description:** Brief explanation of changes
             - **Impact:** How this affects the codebase
             
             #### 🔍 Key Changes
             - Highlight the most important changes
             - New functionality added
             - Breaking changes (if any)
             - Dependencies or configuration changes
             
             #### 🎯 Recommendations
             - Code quality observations
             - Potential improvements or concerns
             - Testing suggestions
             
             #### 🔗 Related
             - Link to any related issues or discussions
             - Reference to documentation updates needed
             
             ---
             *Generated by Codex AI on ${{ github.event.pull_request.created_at }}*
          
          ### Instructions
          
          1. Use the GitHub API to fetch the pull request details and file changes
          2. Analyze each file's diff to understand the changes
          3. Generate a comprehensive but concise summary
          4. Post the summary as a comment on the pull request
          5. Focus on being helpful for code reviewers and maintainers
          
          ### Error Handling
          
          If you encounter issues:
          - Log any API errors clearly
          - Provide a fallback summary with available information
          - Mention any limitations in the analysis
          
          Remember to be objective, constructive, and focus on helping the development team understand the changes quickly and effectively.
          
          EOF
      - name: Print prompt to step summary
        run: |
          echo "## Generated Prompt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '``````markdown' >> $GITHUB_STEP_SUMMARY
          cat /tmp/aw-prompts/prompt.txt >> $GITHUB_STEP_SUMMARY
          echo '``````' >> $GITHUB_STEP_SUMMARY
      - name: Run Codex
        run: |
          INSTRUCTION=$(cat /tmp/aw-prompts/prompt.txt)
          export CODEX_HOME=/tmp/mcp-config
          
          # Create log directory outside git repo
          mkdir -p /tmp/aw-logs
          
          # Run codex with log capture
          codex exec \
            -c model=gpt-4o \
            --full-auto "$INSTRUCTION" 2>&1 | tee /tmp/aw-logs//tmp/codex-pull-request-summary.log.log
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      - name: Check if workflow-complete.txt exists, if so upload it
        id: check_file
        run: |
          if [ -f workflow-complete.txt ]; then
            echo "File exists"
            echo "upload=true" >> $GITHUB_OUTPUT
          else
            echo "File does not exist"
            echo "upload=false" >> $GITHUB_OUTPUT
          fi
      - name: Upload workflow-complete.txt
        if: steps.check_file.outputs.upload == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: workflow-complete
          path: workflow-complete.txt
      - name: Upload agentic engine logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex-pull-request-summary.log
          path: /tmp/codex-pull-request-summary.log
          if-no-files-found: warn

