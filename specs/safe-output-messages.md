# Safe Output Messages Design System

This document catalogs all messages, footers, and UI patterns used across GitHub Agentic Workflows safe output functions.

## Overview

Safe output functions are JavaScript files that handle GitHub API write operations (creating issues, discussions, comments, PRs, etc.) from AI-generated content. They produce consistent, user-facing messages with:

- AI attribution footers
- Workflow installation instructions
- Related items references
- Staged mode preview messages
- Error and warning messages

## Message Categories

### 1. AI Attribution Footer

**Purpose**: Identifies content as AI-generated and links to the workflow run.

**Pattern**: Blockquote with workflow link and optional triggering context.

#### Basic Footer Format

```markdown
> AI generated by [WorkflowName](run_url)
```

**Components**:
- `WorkflowName`: From `GH_AW_WORKFLOW_NAME` environment variable (default: "Workflow")
- `run_url`: GitHub Actions run URL constructed from repository and run ID

**Source Files**:
- `create_issue.cjs` (lines 30-56)
- `add_comment.cjs` (lines 15-41)
- `create_pr_review_comment.cjs` (lines 15-41)
- `create_discussion.cjs` (line 170)
- `create_pull_request.cjs` (line 274)

#### Footer with Triggering Context

```markdown
> AI generated by [WorkflowName](run_url) for #123
```

**Context Variations**:
- `for #N` - When triggered by an issue (no pull_request field)
- `for #N` - When triggered by a pull request
- `for discussion #N` - When triggered by a discussion

**Logic** (in `create_issue.cjs`, `add_comment.cjs`, `create_pr_review_comment.cjs`):
```javascript
if (triggeringIssueNumber) {
  footer += ` for #${triggeringIssueNumber}`;
} else if (triggeringPRNumber) {
  footer += ` for #${triggeringPRNumber}`;
} else if (triggeringDiscussionNumber) {
  footer += ` for discussion #${triggeringDiscussionNumber}`;
}
```

**Source Files**:
- `create_issue.cjs` (lines 42-48)
- `add_comment.cjs` (lines 27-33)
- `create_pr_review_comment.cjs` (lines 27-33)

### 2. Workflow Installation Instructions

**Purpose**: Provides command to add the workflow to user's repository.

**Pattern**: Multi-line blockquote with CLI command and documentation link.

```markdown
>
> To add this workflow in your repository, run `gh aw add owner/repo/path@ref`. See [usage guide](https://githubnext.github.io/gh-aw/tools/cli/).
```

**Components**:
- `workflowSource`: Workflow source identifier (e.g., `owner/repo/path@ref`)
- `workflowSourceURL`: GitHub URL for the workflow source
- Documentation link: Static URL to usage guide

**Conditions**: Only added if both `workflowSource` and `workflowSourceURL` are provided.

**Source Files**:
- `create_issue.cjs` (lines 50-52)
- `add_comment.cjs` (lines 35-37)
- `create_pr_review_comment.cjs` (lines 35-37)

**Note**: Not present in `create_discussion.cjs` or `create_pull_request.cjs` (simplified footers).

### 3. Related Items References

**Purpose**: Links AI-generated comments to related issues, discussions, or pull requests created in the same workflow.

**Pattern**: Markdown heading with bulleted list of links.

```markdown
#### Related Items

- Issue: [#123](issue_url)
- Discussion: [#456](discussion_url)
- Pull Request: [#789](pr_url)
```

**Environment Variables**:
- `GH_AW_CREATED_ISSUE_URL` + `GH_AW_CREATED_ISSUE_NUMBER`
- `GH_AW_CREATED_DISCUSSION_URL` + `GH_AW_CREATED_DISCUSSION_NUMBER`
- `GH_AW_CREATED_PULL_REQUEST_URL` + `GH_AW_CREATED_PULL_REQUEST_NUMBER`

**Usage Context**: Added to comments (both in staged mode preview and actual comments)

**Source Files**:
- `add_comment.cjs` (lines 222-232, 358-375)

**Implementation**:
```javascript
let referencesSection = "\n\n#### Related Items\n\n";
if (createdIssueUrl && createdIssueNumber) {
  referencesSection += `- Issue: [#${createdIssueNumber}](${createdIssueUrl})\n`;
}
if (createdDiscussionUrl && createdDiscussionNumber) {
  referencesSection += `- Discussion: [#${createdDiscussionNumber}](${createdDiscussionUrl})\n`;
}
if (createdPullRequestUrl && createdPullRequestNumber) {
  referencesSection += `- Pull Request: [#${createdPullRequestNumber}](${createdPullRequestUrl})\n`;
}
```

### 4. Staged Mode Preview Messages

**Purpose**: Show preview of safe output operations without executing them, for testing and validation.

**Pattern**: Step summary with emoji header and detailed preview content.

#### Header Format

All staged mode previews use the ðŸŽ­ emoji:

```markdown
## ðŸŽ­ Staged Mode: [Operation Type] Preview

The following [items] would be [action] if staged mode was disabled:
```

#### Variations by Safe Output Type

##### Create Issues Preview
**File**: `create_issue.cjs` (lines 102-118)

```markdown
## ðŸŽ­ Staged Mode: Create Issues Preview

The following issues would be created if staged mode was disabled:

### Issue 1
**Title:** Issue title here

**Body:**
Issue body content here

**Labels:** label1, label2

---
```

##### Create Discussions Preview
**File**: `create_discussion.cjs` (lines 47-63)

```markdown
## ðŸŽ­ Staged Mode: Create Discussions Preview

The following discussions would be created if staged mode was disabled:

### Discussion 1
**Title:** Discussion title here

**Body:**
Discussion body content here

**Category:** category-name

---
```

##### Add Comments Preview
**File**: `add_comment.cjs` (lines 210-262)

```markdown
## ðŸŽ­ Staged Mode: Add Comments Preview

The following comments would be added if staged mode was disabled:

#### Related Items
- Issue: [#123](url)
- Discussion: [#456](url)
- Pull Request: [#789](url)

### Comment 1
**Target Issue:** [#123](url)

**Body:**
Comment body content here

---
```

##### Create Pull Request Preview
**File**: `create_pull_request.cjs` (lines 224-248)

```markdown
## ðŸŽ­ Staged Mode: Create Pull Request Preview

The following pull request would be created if staged mode was disabled:

**Title:** PR title here

**Branch:** branch-name

**Base:** main

**Body:**
PR body content here

**Changes:** Patch file exists with 123 lines

<details><summary>Show patch preview</summary>

```diff
[patch content up to 2000 chars]
... (truncated)
```

</details>
```

##### Create PR Review Comments Preview
**File**: `create_pr_review_comment.cjs` (lines 116-142)

```markdown
## ðŸŽ­ Staged Mode: Create PR Review Comments Preview

The following review comments would be created if staged mode was disabled:

### Review Comment 1
**Target PR:** [#123](url)

**File:** path/to/file.js

**Line:** 42

**Start Line:** 40

**Side:** RIGHT

**Body:**
Review comment body here

---
```

##### Update Issues Preview
**File**: `update_issue.cjs` (lines 56-83)

```markdown
## ðŸŽ­ Staged Mode: Update Issues Preview

The following issue updates would be applied if staged mode was disabled:

### Issue Update 1
**Target Issue:** #123

**New Title:** Updated title

**New Body:**
Updated body content

**New Status:** closed

---
```

### 5. Patch Preview Messages

**Purpose**: Display git patches in pull request bodies with size limits and truncation.

**Pattern**: Collapsible details section with syntax-highlighted diff.

#### Standard Patch Preview

```markdown
<details><summary>Show patch (N lines)</summary>

```diff
[patch content]
```

</details>
```

**Used when**: Patch is under 500 lines and 2000 characters

#### Truncated Patch Preview

```markdown
<details><summary>Show patch preview (500 of 1234 lines)</summary>

```diff
[truncated patch content]
... (truncated)
```

</details>
```

**Used when**: Patch exceeds 500 lines or 2000 characters

**Limits**:
- Max lines: 500
- Max chars: 2000

**Source Files**:
- `create_pull_request.cjs` (lines 14-39)

**Implementation**:
```javascript
function generatePatchPreview(patchContent) {
  const lines = patchContent.split("\n");
  const maxLines = 500;
  const maxChars = 2000;
  
  let preview = lines.length <= maxLines ? patchContent : lines.slice(0, maxLines).join("\n");
  const lineTruncated = lines.length > maxLines;
  
  const charTruncated = preview.length > maxChars;
  if (charTruncated) {
    preview = preview.slice(0, maxChars);
  }
  
  const truncated = lineTruncated || charTruncated;
  const summary = truncated
    ? `Show patch preview (${Math.min(maxLines, lines.length)} of ${lines.length} lines)`
    : `Show patch (${lines.length} lines)`;
    
  return `\n\n<details><summary>${summary}</summary>\n\n\`\`\`diff\n${preview}${truncated ? "\n... (truncated)" : ""}\n\`\`\`\n\n</details>`;
}
```

### 6. Fallback Messages

**Purpose**: Provide alternative actions when primary operations fail (e.g., PR creation fails).

#### Push Failure Fallback

**File**: `create_pull_request.cjs` (lines 356-394)

```markdown
---

> [!NOTE]
> This was originally intended as a pull request, but the git push operation failed.
>
> **Workflow Run:** [View run details and download patch artifact](run_url)
>
> The patch file is available as an artifact (`aw.patch`) in the workflow run linked above.

To apply the patch locally:

```sh
# Download the artifact from the workflow run [url]
# (Use GitHub MCP tools if gh CLI is not available)
gh run download [run_id] -n aw.patch

# Apply the patch
git am aw.patch
```

[patch preview if available]
```

**Conditions**: When `git push` fails but patch generation succeeded.

#### PR Creation Fallback

**File**: `create_pull_request.cjs` (lines 498-522)

```markdown
---

**Note:** This was originally intended as a pull request, but PR creation failed. The changes have been pushed to the branch [`branch-name`](branch_url).

**Original error:** [error message]

You can manually create a pull request from the branch if needed.

[patch preview if available]
```

**Conditions**: When PR creation fails but branch push succeeded.

### 7. Issue Parent References

**Purpose**: Link created issues to their parent issue.

**Pattern**: Simple markdown reference at end of issue body.

```markdown
Related to #123
```

**Source Files**:
- `create_issue.cjs` (lines 168-171)

**Conditions**: When `effectiveParentIssueNumber` is available (from context or explicit parent field).

**Note**: Code also attempts GraphQL sub-issue linking, with fallback to comment if GraphQL fails.

### 8. Success Summary Messages

**Purpose**: Provide step summary after successful operations.

**Pattern**: Markdown heading with bulleted list of created items.

#### GitHub Issues Summary
**File**: `create_issue.cjs` (lines 291-297)

```markdown
## GitHub Issues
- Issue #123: [Issue Title](issue_url)
- Issue #456: [Another Issue](issue_url)
```

#### GitHub Discussions Summary
**File**: `create_discussion.cjs` (lines 215-221)

```markdown
## GitHub Discussions
- Discussion #123: [Discussion Title](discussion_url)
- Discussion #456: [Another Discussion](discussion_url)
```

#### GitHub Comments Summary
**File**: `add_comment.cjs` (lines 447-453)

```markdown
## GitHub Comments
- Comment #12345: [View Comment](comment_url)
- Comment #67890: [View Comment](comment_url)
```

#### GitHub PR Review Comments Summary
**File**: `create_pr_review_comment.cjs` (lines 353-359)

```markdown
## GitHub PR Review Comments
- Review Comment #12345: [View Comment](comment_url)
- Review Comment #67890: [View Comment](comment_url)
```

#### Pull Request Summary
**File**: `create_pull_request.cjs` (lines 486-496)

```markdown
## Pull Request
- **Pull Request**: [#123](pr_url)
- **Branch**: `branch-name`
- **Base Branch**: `main`
```

#### Push Failure Fallback Summary
**File**: `create_pull_request.cjs` (lines 415-427)

```markdown
## Push Failure Fallback
- **Push Error:** [error message]
- **Fallback Issue:** [#123](issue_url)
- **Patch Artifact:** Available in workflow run artifacts
- **Note:** Push failed, created issue as fallback
```

#### PR Fallback Summary
**File**: `create_pull_request.cjs` (lines 542-552)

```markdown
## Fallback Issue Created
- **Issue**: [#123](issue_url)
- **Branch**: [`branch-name`](branch_url)
- **Base Branch**: `main`
- **Note**: Pull request creation failed, created issue as fallback
```

#### Updated Issues Summary
**File**: `update_issue.cjs` (lines 220-226)

```markdown
## Updated Issues
- Issue #123: [Updated Title](issue_url)
- Issue #456: [Another Updated Issue](issue_url)
```

## Safe Output Function Reference

### create_issue.cjs

**Type**: Create GitHub Issues

**Messages Used**:
- AI Attribution Footer (with triggering context)
- Workflow Installation Instructions
- Issue Parent References
- Staged Mode Preview
- Success Summary

**Environment Variables**:
- `GH_AW_SAFE_OUTPUTS_STAGED`: Enable staged mode
- `GH_AW_AGENT_OUTPUT`: Path to agent output file
- `GH_AW_ISSUE_LABELS`: Comma-separated labels
- `GH_AW_ISSUE_TITLE_PREFIX`: Prefix for issue titles
- `GH_AW_WORKFLOW_NAME`: Workflow display name
- `GH_AW_WORKFLOW_SOURCE`: Workflow source identifier
- `GH_AW_WORKFLOW_SOURCE_URL`: Workflow source URL

**Key Features**:
- Label sanitization (removes control chars, escapes @mentions)
- Sub-issue linking via GraphQL (with fallback to comment)
- Parent issue references

### create_discussion.cjs

**Type**: Create GitHub Discussions

**Messages Used**:
- AI Attribution Footer (basic, no triggering context)
- Staged Mode Preview
- Success Summary

**Environment Variables**:
- `GH_AW_SAFE_OUTPUTS_STAGED`: Enable staged mode
- `GH_AW_AGENT_OUTPUT`: Path to agent output file
- `GH_AW_DISCUSSION_CATEGORY`: Category ID/name/slug
- `GH_AW_DISCUSSION_TITLE_PREFIX`: Prefix for discussion titles
- `GH_AW_WORKFLOW_NAME`: Workflow display name

**Key Features**:
- Category resolution (by ID, name, or slug)
- GraphQL-based creation
- No workflow installation instructions

### add_comment.cjs

**Type**: Add Comments to Issues/PRs/Discussions

**Messages Used**:
- AI Attribution Footer (with triggering context)
- Workflow Installation Instructions
- Related Items References
- Staged Mode Preview
- Success Summary

**Environment Variables**:
- `GH_AW_SAFE_OUTPUTS_STAGED`: Enable staged mode
- `GH_AW_AGENT_OUTPUT`: Path to agent output file
- `GH_AW_COMMENT_TARGET`: Target configuration ("triggering", "*", or number)
- `GITHUB_AW_COMMENT_DISCUSSION`: Force discussion comment mode
- `GH_AW_WORKFLOW_NAME`: Workflow display name
- `GH_AW_WORKFLOW_SOURCE`: Workflow source identifier
- `GH_AW_WORKFLOW_SOURCE_URL`: Workflow source URL
- `GH_AW_CREATED_ISSUE_URL/NUMBER`: Related issue info
- `GH_AW_CREATED_DISCUSSION_URL/NUMBER`: Related discussion info
- `GH_AW_CREATED_PULL_REQUEST_URL/NUMBER`: Related PR info
- `GH_AW_TARGET_REPO_SLUG`: Target repo for trial mode

**Key Features**:
- Supports issues, PRs, and discussions
- Threaded replies for discussion comments
- Related items linking
- Target-based routing

### create_pull_request.cjs

**Type**: Create Pull Requests

**Messages Used**:
- AI Attribution Footer (basic, no triggering context)
- Patch Preview (with truncation)
- Fallback Messages (push failure, PR creation failure)
- Staged Mode Preview
- Success Summary
- Fallback Summary

**Environment Variables**:
- `GH_AW_SAFE_OUTPUTS_STAGED`: Enable staged mode
- `GH_AW_AGENT_OUTPUT`: Path to agent output file
- `GH_AW_WORKFLOW_ID`: Workflow identifier for branch naming
- `GH_AW_BASE_BRANCH`: Base branch for PR
- `GH_AW_PR_TITLE_PREFIX`: Prefix for PR titles
- `GH_AW_PR_LABELS`: Comma-separated labels
- `GH_AW_PR_DRAFT`: Draft PR flag (default: true)
- `GH_AW_PR_IF_NO_CHANGES`: Behavior when no changes ("error", "warn", "ignore")
- `GH_AW_MAX_PATCH_SIZE`: Max patch size in KB (default: 1024)
- `GH_AW_WORKFLOW_NAME`: Workflow display name

**Key Features**:
- Patch validation and size limits
- Cryptographic random branch names
- Fallback to issue creation on failure
- Empty patch handling

### create_pr_review_comment.cjs

**Type**: Create PR Review Comments

**Messages Used**:
- AI Attribution Footer (with triggering context)
- Workflow Installation Instructions
- Staged Mode Preview
- Success Summary

**Environment Variables**:
- `GH_AW_SAFE_OUTPUTS_STAGED`: Enable staged mode
- `GH_AW_AGENT_OUTPUT`: Path to agent output file
- `GH_AW_PR_REVIEW_COMMENT_SIDE`: Default side ("LEFT" or "RIGHT")
- `GH_AW_PR_REVIEW_COMMENT_TARGET`: Target configuration
- `GH_AW_WORKFLOW_NAME`: Workflow display name
- `GH_AW_WORKFLOW_SOURCE`: Workflow source identifier
- `GH_AW_WORKFLOW_SOURCE_URL`: Workflow source URL
- `GH_AW_TARGET_REPO_SLUG`: Target repo for trial mode

**Key Features**:
- Line-specific and multi-line comments
- Side specification (LEFT/RIGHT)
- Commit SHA validation
- Target-based routing

### update_issue.cjs

**Type**: Update GitHub Issues

**Messages Used**:
- Staged Mode Preview
- Success Summary

**Environment Variables**:
- `GH_AW_SAFE_OUTPUTS_STAGED`: Enable staged mode
- `GH_AW_AGENT_OUTPUT`: Path to agent output file
- `GH_AW_UPDATE_TARGET`: Target configuration ("triggering", "*", or number)
- `GH_AW_UPDATE_STATUS`: Allow status updates
- `GH_AW_UPDATE_TITLE`: Allow title updates
- `GH_AW_UPDATE_BODY`: Allow body updates

**Key Features**:
- Selective field updates (status, title, body)
- Permission-based restrictions
- Target-based routing
- No AI footer (updates existing content)

## Common Patterns

### Environment Variable Naming

All safe output environment variables follow the pattern:
- `GH_AW_*` - General workflow variables
- `GH_AW_[OUTPUT_TYPE]_*` - Output-type-specific variables

Examples:
- `GH_AW_ISSUE_LABELS` - Issue-specific
- `GH_AW_PR_DRAFT` - Pull request-specific
- `GH_AW_DISCUSSION_CATEGORY` - Discussion-specific

### Footer Generation

Shared `generateFooter()` function used in:
- `create_issue.cjs`
- `add_comment.cjs`
- `create_pr_review_comment.cjs`

Inline footer in:
- `create_discussion.cjs` (simplified)
- `create_pull_request.cjs` (simplified)

### Staged Mode Detection

All files check: `process.env.GH_AW_SAFE_OUTPUTS_STAGED === "true"`

When staged:
- No GitHub API calls
- Preview written to step summary
- Early return after preview

### Error Handling

Common patterns:
- Try-catch around GitHub API calls
- Specific error messages for disabled features
- Fallback mechanisms (PR â†’ Issue)
- Warning vs error distinction

### Output Setting

All files set outputs for last created item:
- `core.setOutput("issue_number", ...)` 
- `core.setOutput("issue_url", ...)`
- Similar patterns for discussions, PRs, comments

## Design Principles

### Consistency
- All AI-generated content uses blockquote footer
- ðŸŽ­ emoji consistently marks staged previews
- URL patterns match GitHub conventions

### Clarity
- Clear distinction between preview and actual operations
- Explicit error messages
- Helpful fallback instructions

### Discoverability
- Installation instructions in footers
- Related items automatically linked
- Step summaries for all operations

### Safety
- Label sanitization (control chars, @mentions)
- Patch size validation
- Staged mode for testing
- Graceful degradation on errors

## Future Considerations

### Localization
Currently all messages are English-only. Future internationalization would require:
- Message template system
- Locale detection
- Translation resources

### Customization
Users may want to:
- Customize footer format
- Add organization-specific branding
- Control message verbosity

### Metrics
Potential tracking:
- Message delivery rates
- Fallback frequency
- User interaction with links

---

**Last Updated**: 2024-10-23  
**Version**: 1.0  
**Maintainers**: GitHub Next Team
