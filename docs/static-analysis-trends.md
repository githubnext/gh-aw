# Static Analysis Trend Tracking

This document explains how the automated static analysis trend tracking system works in gh-aw.

## Overview

The static analysis trend tracking system monitors security scan results over time to identify improvements and regressions in the repository's security posture.

## Components

### 1. Trend Analysis Script (`pkg/workflow/js/analyze_security_trends.cjs`)

Core functionality for analyzing security scan trends:

- **Parses scan results** from discussion bodies generated by the static-analysis-report workflow
- **Loads historical data** from cache-memory
- **Compares scans** to calculate changes
- **Generates trend metrics** (percentage changes, new/resolved issues)
- **Stores results** in cache-memory for future reference
- **Outputs markdown** trend analysis for inclusion in reports

### 2. Workflow Integration (`.github/workflows/static-analysis-report.md`)

The static-analysis-report workflow includes:

- **Cache-memory enabled** for data persistence
- **Phase 3 instructions** for storing scan data
- **Trend calculation steps** for comparing with historical scans
- **Discussion template** with trend analysis section

### 3. Trend Report Template (`.github/workflows/shared/templates/trend-report.md`)

Reusable template providing:

- **Formatting guidelines** for trend sections
- **Example templates** for different trend types
- **Calculation formulas** for metrics
- **Best practices** for trend analysis

## Data Structure

### Cache Memory Layout

```
/tmp/gh-aw/cache-memory/security-scans/
â”œâ”€â”€ index.json              # Master index of all scans (90-day rolling)
â”œâ”€â”€ 2025-11-05.json         # Daily scan results
â”œâ”€â”€ 2025-11-06.json
â””â”€â”€ trends/
    â”œâ”€â”€ weekly.json         # Weekly aggregates (last 12 weeks)
    â””â”€â”€ monthly.json        # Monthly aggregates (last 12 months)
```

### Scan Data Format

Each daily scan file (`YYYY-MM-DD.json`) contains:

```json
{
  "date": "2025-11-05",
  "timestamp": "2025-11-05T09:00:00Z",
  "total": 116,
  "byTool": {
    "zizmor": {
      "total": 50,
      "bySeverity": { "critical": 0, "high": 0, "medium": 5, "low": 45 }
    },
    "poutine": {
      "total": 30,
      "bySeverity": { "critical": 0, "high": 0, "medium": 0, "low": 30 }
    },
    "actionlint": { "total": 36 }
  },
  "comparison": {
    "totalChange": -20,
    "totalChangePercent": -14.7,
    "trend": "improvement",
    "newIssues": 0,
    "resolvedIssues": 20,
    "byTool": {
      "zizmor": { "change": -10, "changePercent": -16.7 },
      "poutine": { "change": -6, "changePercent": -16.7 },
      "actionlint": { "change": -4, "changePercent": -10.0 }
    }
  }
}
```

### Index Format

The index file (`index.json`) tracks all scans:

```json
{
  "scans": [
    { "date": "2025-11-05", "total": 116 },
    { "date": "2025-11-04", "total": 136 },
    { "date": "2025-11-03", "total": 142 }
  ]
}
```

## Workflow Execution

### First Scan (Baseline)

1. Workflow runs static analysis tools (zizmor, poutine, actionlint)
2. Agent analyzes findings and creates discussion
3. No historical data exists
4. Scan data saved to cache-memory
5. Discussion includes "First scan - baseline established" message

### Subsequent Scans (Trend Analysis)

1. Workflow runs static analysis tools
2. Agent loads previous scan from cache-memory
3. Compares current vs. previous findings
4. Calculates:
   - Total change (absolute and percentage)
   - Per-tool changes
   - Trend direction (improvement/regression/stable)
   - New vs. resolved issues
5. Saves current scan with comparison data
6. Updates weekly/monthly aggregates
7. Includes trend analysis in discussion

## Trend Indicators

The system uses Unicode symbols to indicate trends:

- **â†“** (Improvement) - Total findings decreased
- **â†‘** (Regression) - Total findings increased
- **â†’** (Stable) - Total findings unchanged

## Example Output

### Trend Analysis Section

```markdown
## ðŸ“ˆ Trend Analysis

**Week-over-Week Change**: â†“ 14.7% improvement

| Metric | Current | Previous | Change |
|--------|---------|----------|--------|
| Total Findings | 116 | 136 | â†“ -20 (-14.7%) |
| Zizmor | 50 | 60 | â†“ -10 (-16.7%) |
| Poutine | 30 | 36 | â†“ -6 (-16.7%) |
| Actionlint | 36 | 40 | â†“ -4 (-10.0%) |

**Improvements**:
- Resolved 20 issues since last scan
- Security posture improving week-over-week
```

## Metrics Tracked

### Primary Metrics

- **Total findings** - All issues across all tools
- **Findings by tool** - Separate counts for zizmor, poutine, actionlint
- **Findings by severity** - Critical, High, Medium, Low (zizmor, poutine only)

### Derived Metrics

- **Change count** - Absolute difference from previous scan
- **Change percentage** - Relative change from previous scan
- **Trend direction** - Improvement, regression, or stable
- **New issues** - Count of newly detected issues
- **Resolved issues** - Count of fixed issues

### Aggregate Metrics

- **Weekly average** - Mean findings per week (last 12 weeks)
- **Monthly average** - Mean findings per month (last 12 months)

## Data Retention

- **Daily scans**: 90-day rolling retention
- **Weekly aggregates**: Last 12 weeks
- **Monthly aggregates**: Last 12 months

Older data is automatically pruned to keep cache-memory size manageable.

## Testing

The trend analysis system includes comprehensive test coverage:

- **Unit tests** (`analyze_security_trends.test.cjs`):
  - Scan parsing from discussion bodies
  - Historical data loading and storage
  - Trend comparison logic
  - Percentage calculations
  - Data structure validation
  - Edge cases (first scan, missing data, etc.)

Run tests with:

```bash
cd pkg/workflow/js
npm test -- analyze_security_trends.test.cjs
```

## Usage in Other Workflows

The trend analysis functionality can be reused in other workflows:

1. **Import the template**:
   ```yaml
   imports:
     - shared/templates/trend-report.md
   ```

2. **Follow the formatting guidelines** in the template

3. **Use cache-memory** to store and retrieve historical data

## Troubleshooting

### No trend data showing

- **Cause**: First scan, no historical data
- **Solution**: Normal behavior, trends will appear on next scan

### Incorrect percentage calculations

- **Cause**: Previous scan had 0 findings
- **Solution**: Handled automatically, shows 0% change

### Missing scan files

- **Cause**: Cache-memory not persisted between workflow runs
- **Solution**: Ensure `cache-memory: true` is set in workflow frontmatter

### Trend direction incorrect

- **Cause**: Parsing error in discussion body
- **Solution**: Verify discussion body matches expected table format

## Future Enhancements

Potential improvements to the trend tracking system:

1. **Regression alerts** - Automatic notifications when findings increase significantly
2. **Long-term trends** - Quarterly and yearly aggregates
3. **Visualization** - Generate charts/graphs of trends
4. **Forecasting** - Predict future security posture based on trends
5. **Custom thresholds** - Configurable alert thresholds per tool
6. **Export capability** - Export trend data for external analysis

## References

- **Main script**: `pkg/workflow/js/analyze_security_trends.cjs`
- **Unit tests**: `pkg/workflow/js/analyze_security_trends.test.cjs`
- **Workflow**: `.github/workflows/static-analysis-report.md`
- **Template**: `.github/workflows/shared/templates/trend-report.md`
- **Issue**: githubnext/gh-aw#3280 (Static Analysis Trend Tracking)
