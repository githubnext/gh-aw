---
import { Code } from 'astro-expressive-code/components';
import type { Conclusion, HeroWorkflow, WorkflowRunSnapshot } from '../lib/workflow-hero/types';
import { parseActionsWorkflowGraph } from '../lib/workflow-hero/parseActionsYaml';
import { workflowGraphToMermaid } from '../lib/workflow-hero/toMermaid';
import { loadPlaygroundSnapshots } from '../lib/workflow-hero/loadSnapshots';
import heroClientUrl from './WorkflowHeroPlayground.client.ts?url';

import fs from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

type HeroWorkflowInput = {
  id: string;
  label: string;

  // Inline content (current behavior)
  sourceMarkdown?: string;
  compiledYaml?: string;
  snapshot?: WorkflowRunSnapshot;

  // Optional URL-based sources (for workflows that live in other repos)
  // If both inline and URL values are provided, inline wins.
  sourceMarkdownUrl?: string;
  compiledYamlUrl?: string;
  snapshotUrl?: string;
};

interface Props {
  workflows: HeroWorkflowInput[];
  initialWorkflowId?: string;
  layout?: 'two' | 'three';
}

const { workflows, initialWorkflowId, layout = 'two' } = Astro.props;

if (!workflows || workflows.length === 0) {
  throw new Error('WorkflowHeroPlayground requires at least one workflow');
}

const initialId =
  initialWorkflowId && workflows.some((w) => w.id === initialWorkflowId)
    ? initialWorkflowId
    : workflows[0].id;

async function fetchText(url: string): Promise<string | undefined> {
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 5000);
    const res = await fetch(url, {
      signal: controller.signal,
      headers: {
        // Make it explicit this is a build-time fetch.
        Accept: 'text/plain,*/*',
      },
    });
    clearTimeout(timeout);
    if (!res.ok) return undefined;
    return await res.text();
  } catch {
    return undefined;
  }
}

async function fetchSnapshot(url: string): Promise<WorkflowRunSnapshot | undefined> {
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 5000);
    const res = await fetch(url, {
      signal: controller.signal,
      headers: {
        Accept: 'application/json',
      },
    });
    clearTimeout(timeout);
    if (!res.ok) return undefined;

    const value = (await res.json()) as any;
    if (!value || typeof value !== 'object') return undefined;

    const workflowId = typeof value.workflowId === 'string' ? value.workflowId : '';
    const updatedAt = typeof value.updatedAt === 'string' ? value.updatedAt : '';
    const conclusion = value.conclusion ?? null;
    const runUrl = typeof value.runUrl === 'string' ? value.runUrl : undefined;
    const jobs = Array.isArray(value.jobs) ? value.jobs : [];

    if (!workflowId || !updatedAt) return undefined;
    return {
      workflowId,
      updatedAt,
      conclusion,
      runUrl,
      jobs,
    } as WorkflowRunSnapshot;
  } catch {
    return undefined;
  }
}

async function resolveWorkflow(input: HeroWorkflowInput): Promise<HeroWorkflow> {
  const orgOwnedDir = fileURLToPath(new URL('../assets/playground-workflows/org-owned/', import.meta.url));
  const userOwnedDir = fileURLToPath(new URL('../assets/playground-workflows/user-owned/', import.meta.url));
  const localMdPaths = [path.join(orgOwnedDir, `${input.id}.md`), path.join(userOwnedDir, `${input.id}.md`)];
  const localLockPaths = [
    path.join(orgOwnedDir, `${input.id}.lock.yml`),
    path.join(userOwnedDir, `${input.id}.lock.yml`),
  ];

  const sourceMarkdownFromLocal =
    (await fs.readFile(localMdPaths[0], 'utf8').catch(() => undefined)) ??
    (await fs.readFile(localMdPaths[1], 'utf8').catch(() => undefined));
  const sourceMarkdownFromUrl =
    typeof input.sourceMarkdownUrl === 'string' ? await fetchText(input.sourceMarkdownUrl) : undefined;

  const sourceMarkdown = input.sourceMarkdown ?? sourceMarkdownFromLocal ?? sourceMarkdownFromUrl;

  const compiledYamlFromLocal =
    (await fs.readFile(localLockPaths[0], 'utf8').catch(() => undefined)) ??
    (await fs.readFile(localLockPaths[1], 'utf8').catch(() => undefined));
  const compiledYamlFromUrl =
    typeof input.compiledYamlUrl === 'string' ? await fetchText(input.compiledYamlUrl) : undefined;

  const compiledYaml = input.compiledYaml ?? compiledYamlFromLocal ?? compiledYamlFromUrl ?? '';

  const bundledSnapshots = loadPlaygroundSnapshots();
  const snapshotFromBundle = bundledSnapshots[input.id];

  const snapshot =
    input.snapshot ??
    snapshotFromBundle ??
    (typeof input.snapshotUrl === 'string' ? await fetchSnapshot(input.snapshotUrl) : undefined);

  return {
    id: input.id,
    label: input.label,
    sourceMarkdown,
    compiledYaml,
    snapshot,
  };
}

const resolvedWorkflows: HeroWorkflow[] = await Promise.all(workflows.map(resolveWorkflow));

function safeJsonForHtmlScriptTag(value: unknown): string {
  // Prevent embedded JSON from prematurely closing the script tag.
  return JSON.stringify(value).replaceAll('</script', '<\\/script');
}

type WorkflowWithRenderData = HeroWorkflow & {
  mermaidSource?: string;
  mermaidError?: string;
};

const workflowsWithRenderData: WorkflowWithRenderData[] = resolvedWorkflows.map((w) => {
  try {
    const graph = parseActionsWorkflowGraph(w.compiledYaml);

    const normalize = (value: string): string => value.toLowerCase().replace(/[^a-z0-9]+/g, '');
    const snapshotJobs = w.snapshot?.jobs ?? [];
    const snapshotByNormalizedName = new Map<string, (typeof snapshotJobs)[number]>();
    for (const j of snapshotJobs) {
      snapshotByNormalizedName.set(normalize(j.name), j);
    }

    const jobConclusions: Record<string, Conclusion | undefined> = {};
    for (const jobId of Object.keys(graph.jobs)) {
      const match = snapshotByNormalizedName.get(normalize(jobId));
      jobConclusions[jobId] = match?.conclusion ?? undefined;
    }

    return {
      ...w,
      mermaidSource: workflowGraphToMermaid(graph, jobConclusions),
    };
  } catch (err) {
    return {
      ...w,
      mermaidSource: undefined,
      mermaidError: err instanceof Error ? err.message : String(err),
    };
  }
});

function getNonEmptyMarkdownSource(w: HeroWorkflow): string {
  const trimmed = (w.sourceMarkdown ?? '').trim();
  if (trimmed.length > 0) return w.sourceMarkdown as string;
  return '# Source unavailable\n\nThis example is missing its source Markdown.';
}

function summarize(snapshot?: WorkflowRunSnapshot): string {
  if (!snapshot) return 'No recent run snapshot available.';
  const jobs = snapshot.jobs?.length ?? 0;
  const steps = snapshot.jobs?.reduce((acc, j) => acc + (j.steps?.length ?? 0), 0) ?? 0;
  return `${snapshot.conclusion ?? 'unknown'} • ${jobs} job(s) • ${steps} step(s)`;
}
---

<div
  class="hero"
  data-hero-playground
  data-hero-layout={layout}
>
  <script
    type="application/json"
    data-hero-payload
    set:html={safeJsonForHtmlScriptTag({ workflows: workflowsWithRenderData, initialId })}
  ></script>

  <div class="hero-header">
    <div class="hero-title">Playground</div>

    <div class="hero-controls">
      <label class="hero-select">
        <span class="hero-select-label">Workflow:</span>
        <select data-hero-select>
          {workflowsWithRenderData.map((w) => (
            <option value={w.id} selected={w.id === initialId}>
              {w.label}
            </option>
          ))}
        </select>
      </label>
    </div>
  </div>

  <div class="hero-grid">
    <section class="hero-pane hero-pane-code">
      <div class="pane-header">Workflow (Markdown)</div>
      <div class="pane-body" data-hero-code>
        {workflowsWithRenderData.map((w) => (
          <div data-hero-code-block data-hero-id={w.id} hidden={w.id !== initialId}>
            <Code code={getNonEmptyMarkdownSource(w)} lang="md" />
          </div>
        ))}
      </div>
    </section>

    <section class="hero-pane hero-pane-graph">
      <div class="pane-header">Graph</div>
      <div class="pane-body">
        <div class="graph" data-hero-graph>
          <div class="graph-canvas" data-hero-graph-canvas></div>
          <div class="graph-error" data-hero-graph-error hidden></div>
        </div>
      </div>
    </section>

    <section class="hero-pane hero-pane-run">
      <div class="pane-header">
        <span>Last run</span>
        <a class="run-link" data-hero-run-link target="_blank" rel="noopener noreferrer" hidden>Open run</a>
      </div>
      <div class="pane-body run" data-hero-run>
        <div class="run-meta" data-hero-run-meta></div>
        <div class="run-selected" data-hero-run-selected hidden></div>
        <div class="run-jobs" data-hero-run-jobs></div>
      </div>
    </section>
  </div>
</div>

<script type="module" src={heroClientUrl}></script>

<style>
  .hero {
    border: 1px solid var(--sl-color-hairline);
    border-radius: 8px;
    overflow: hidden;
    margin: 1.5rem 0;
  }

  .hero-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-bottom: 1px solid var(--sl-color-hairline);
    background: var(--sl-color-bg-nav);
    gap: 1rem;
    flex-wrap: wrap;
  }

  .hero-title {
    font-weight: 700;
    font-size: 1.25rem;
  }

  .hero-controls {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .hero-select {
    display: inline-flex;
    gap: 0.5rem;
    align-items: center;
  }

  .hero-select-label {
    font-size: 0.875rem;
    color: var(--sl-color-text-accent);
  }

  select {
    padding: 0.4rem 0.6rem;
    border: 1px solid var(--sl-color-hairline);
    border-radius: 6px;
    background: var(--sl-color-bg);
    color: var(--sl-color-text);
  }

  .hero-grid {
    display: grid;
    grid-template-columns: 1fr;
    min-width: 0;
    align-items: stretch;
  }

  @media (min-width: 900px) {
    .hero-grid {
      grid-template-columns: 1.2fr 1fr;
      grid-template-areas:
        'code graph'
        'run graph';
    }
  }

  @media (min-width: 1100px) {
    .hero[data-hero-layout='three'] .hero-grid {
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-areas: 'code graph run';
    }
  }

  .hero-pane {
    display: flex;
    flex-direction: column;
    min-height: 260px;
    min-width: 0;
    margin: 0;
    border-top: 1px solid var(--sl-color-hairline);
  }

  /* Interactive selection styling */
  :global([data-hero-graph-canvas] .node.is-active > rect),
  :global([data-hero-graph-canvas] .node.is-active > polygon),
  :global([data-hero-graph-canvas] .node.is-active > path) {
    stroke: var(--sl-color-accent) !important;
    stroke-width: 3px !important;
  }

  :global([data-hero-code-block] .ec-line.is-active) {
    background: color-mix(in srgb, var(--sl-color-accent) 18%, transparent);
  }

  .hero-pane:first-child {
    border-top: none;
  }

  .hero-pane-graph {
    grid-area: graph;
  }

  .hero-pane-run {
    grid-area: run;
  }

  .hero-pane-code {
    grid-area: code;
  }

  @media (min-width: 900px) {
    .hero-pane {
      border-top: none;
    }

    .hero-pane-graph {
      border-left: 1px solid var(--sl-color-hairline);
    }

    .hero-pane-run {
      border-top: 1px solid var(--sl-color-hairline);
    }
  }

  @media (min-width: 1100px) {
    .hero[data-hero-layout='three'] .hero-pane-run {
      border-top: none;
      border-left: 1px solid var(--sl-color-hairline);
    }
  }

  .pane-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--sl-color-hairline);
    background: var(--sl-color-bg-nav);
    font-weight: 600;
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 1rem;
  }

  .pane-body {
    padding: 0;
    overflow: auto;
    flex: 1;
    min-width: 0;
  }

  .graph {
    padding: 1rem;
    border-bottom: 1px solid var(--sl-color-hairline);
  }

  .graph-canvas :global(svg) {
    width: 100%;
    height: auto;
  }

  .graph-error {
    color: var(--sl-color-text-accent);
    font-size: 0.875rem;
  }

  .run {
    padding: 1rem;
  }

  .run-link {
    font-size: 0.875rem;
  }

  .run-meta {
    font-size: 0.875rem;
    color: var(--sl-color-gray-3);
    margin: 0.25rem 0 0.75rem;
  }

  .run-selected {
    margin: 0 0 0.75rem;
  }

  .job {
    border: 1px solid var(--sl-color-hairline);
    border-radius: 8px;
    padding: 0.35rem 0.75rem;
    margin: 0.5rem 0;
    background: var(--sl-color-bg);
  }

  .job summary {
    cursor: pointer;
    font-weight: 600;
    list-style: none;
  }

  /* Hide default disclosure marker across browsers. */
  .job summary::marker {
    content: '';
  }

  /* Hide default disclosure triangle (GitHub-like list row). */
  .job summary::-webkit-details-marker {
    display: none;
  }

  .job-summary {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0;
  }

  /* GitHub-like chevron */
  .job-summary::before {
    content: '›';
    display: inline-block;
    width: 1ch;
    color: var(--sl-color-gray-4);
    transform: rotate(0deg);
    transition: transform 120ms ease;
    flex: 0 0 auto;
  }

  .job[open] > .job-summary::before {
    transform: rotate(90deg);
  }

  .job-name {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .job-meta {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }

  .job-ai-summary {
    margin: 0 0 0.5rem;
    padding-left: 1.6rem;
    font-size: 0.875rem;
    color: var(--sl-color-gray-3);
  }

  .status-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 999px;
    border: 1px solid var(--sl-color-hairline);
    background: var(--sl-color-gray-4);
    flex: 0 0 auto;
  }

  .status-dot[data-conclusion='success'] {
    background: var(--sl-color-accent);
  }
  .status-dot[data-conclusion='failure'],
  .status-dot[data-conclusion='timed_out'],
  .status-dot[data-conclusion='action_required'] {
    background: var(--sl-color-accent-low);
  }
  .status-dot[data-conclusion='cancelled'],
  .status-dot[data-conclusion='skipped'],
  .status-dot[data-conclusion='neutral'] {
    background: var(--sl-color-gray-3);
  }
  .status-dot[data-conclusion='in progress'] {
    background: var(--sl-color-accent);
  }

  .steps {
    margin: 0.4rem 0 0;
    padding: 0;
    font-size: 0.9rem;
    list-style: none;
  }

  .step-item {
    padding: 0;
    margin: 0;
    list-style: none;
  }

  .step-details {
    margin: 0;
    padding: 0;
  }

  .step-details > summary {
    cursor: pointer;
    list-style: none;
  }

  .step-details > summary::marker {
    content: '';
  }

  .step-details > summary::-webkit-details-marker {
    display: none;
  }

  .step {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.2rem 0;
  }

  .step-details > .step::before {
    content: '›';
    display: inline-block;
    width: 1ch;
    color: var(--sl-color-gray-4);
    transform: rotate(0deg);
    transition: transform 120ms ease;
    flex: 0 0 auto;
  }

  .step-details[open] > .step::before {
    transform: rotate(90deg);
  }

  .step-log {
    padding: 0.25rem 0 0.5rem 1.2rem;
  }

  .job-log {
    padding: 0.25rem 0 0.5rem 0;
    margin-top: 0.5rem;
  }

  .log-group {
    border-left: 1px solid var(--sl-color-hairline);
    margin: 0.35rem 0 0.35rem 0.25rem;
    padding-left: 0.6rem;
  }

  .log-group-summary {
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--sl-color-text);
    list-style: none;
  }

  .log-group-summary::marker {
    content: '';
  }

  .log-group-summary::-webkit-details-marker {
    display: none;
  }

  .log-group-meta {
    color: var(--sl-color-gray-3);
    font-weight: 400;
  }

  .log-lines {
    margin: 0.35rem 0;
    padding: 0.5rem;
    border: 1px solid var(--sl-color-hairline);
    border-radius: 6px;
    background: var(--sl-color-bg);
    font-size: 0.8rem;
    line-height: 1.25;
    white-space: pre-wrap;
    overflow-wrap: anywhere;
  }

  .log-omitted {
    font-size: 0.8rem;
    color: var(--sl-color-gray-3);
    margin: 0.25rem 0;
  }

  .step-name {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .step-meta {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }

  .step-details {
    display: none;
    font-size: 0.75rem;
    color: var(--sl-color-gray-3);
    white-space: nowrap;
  }

  .step:hover .step-details {
    display: inline;
  }

  .pill {
    display: inline-block;
    border: 1px solid var(--sl-color-hairline);
    border-radius: 999px;
    padding: 0.1rem 0.45rem;
    font-size: 0.75rem;
    margin-right: 0;
    color: var(--sl-color-text-accent);
    background: var(--sl-color-bg-nav);
  }

  .pill[data-conclusion='success'] {
    background: var(--sl-color-accent-low);
    color: var(--sl-color-text);
  }

  .pill[data-conclusion='failure'],
  .pill[data-conclusion='timed_out'],
  .pill[data-conclusion='action_required'] {
    background: var(--sl-color-gray-6);
    color: var(--sl-color-text);
  }

  .pill[data-conclusion='cancelled'],
  .pill[data-conclusion='skipped'],
  .pill[data-conclusion='neutral'] {
    background: var(--sl-color-bg);
    color: var(--sl-color-gray-3);
  }
</style>
