---
import octicons from '@primer/octicons';
import { Steps } from '@astrojs/starlight/components';

interface Step {
  id: string;
  title: string;
  description: string;
  codeLines?: [number, number]; // [start, end] line numbers to highlight
}

interface Props {
  title: string;
  workflowContent: string;
  steps: Step[];
  playgroundUrl?: string;
}

const { title, workflowContent, steps, playgroundUrl } = Astro.props;

const playIcon = octicons['play'].toSVG({ width: 16, height: 16 });
const copyIcon = octicons['copy'].toSVG({ width: 16, height: 16 });
const checkIcon = octicons['check'].toSVG({ width: 16, height: 16 });
---

<div class="workflow-playground">
  <div class="playground-header">
    <h3 class="playground-title">{title}</h3>
    {playgroundUrl && (
      <a href={playgroundUrl} target="_blank" rel="noopener noreferrer" class="playground-link">
        <span set:html={playIcon} />
        Try in Playground
      </a>
    )}
  </div>

  <div class="workflow-viewer">
    <div class="viewer-header">
      <span class="viewer-title">workflow.md</span>
      <button class="copy-button" data-copy-content={workflowContent}>
        <span class="copy-icon" set:html={copyIcon} />
        <span class="check-icon" set:html={checkIcon} />
        <span class="button-text">Copy</span>
      </button>
    </div>
    <div class="code-container">
      <pre class="workflow-code" data-workflow-content={workflowContent}><code>{workflowContent}</code></pre>
    </div>
  </div>

  <div class="steps-section">
    <h4 class="steps-heading">Understanding the Workflow</h4>
    <Steps>
      <ol>
        {steps.map((step) => (
          <li>
            <strong>{step.title}</strong>
            <p>{step.description}</p>
          </li>
        ))}
      </ol>
    </Steps>
  </div>
</div>

<script>
  // Copy to clipboard functionality
  document.addEventListener('DOMContentLoaded', () => {
    const copyButtons = document.querySelectorAll('.copy-button');
    
    copyButtons.forEach(button => {
      button.addEventListener('click', async () => {
        const content = button.getAttribute('data-copy-content');
        if (content) {
          try {
            await navigator.clipboard.writeText(content);
            button.classList.add('copied');
            setTimeout(() => {
              button.classList.remove('copied');
            }, 2000);
          } catch (err) {
            console.error('Failed to copy:', err);
          }
        }
      });
    });
  });
</script>

<style>
  .workflow-playground {
    margin: 2rem 0;
    border: 1px solid var(--sl-color-hairline);
    border-radius: 8px;
    background: rgba(13, 17, 23, 0.4);
    backdrop-filter: blur(8px);
    overflow: hidden;
  }

  .playground-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--sl-color-hairline);
    background: rgba(13, 17, 23, 0.6);
    flex-wrap: wrap;
    gap: 1rem;
  }

  .playground-title {
    margin: 0 !important;
    font-size: 1.5rem !important;
    font-weight: 700 !important;
    color: var(--sl-color-text);
  }

  .playground-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 6px;
    color: #c4b5fd;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.2s ease;
  }

  .playground-link:hover {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(139, 92, 246, 0.15));
    border-color: rgba(139, 92, 246, 0.5);
    color: #ddd6fe;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
  }

  .playground-link :global(svg) {
    fill: currentColor;
  }

  .workflow-viewer {
    display: flex;
    flex-direction: column;
  }

  .viewer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background: rgba(13, 17, 23, 0.6);
    border-bottom: 1px solid var(--sl-color-hairline);
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .viewer-title {
    font-family: var(--sl-font-mono);
    font-size: 0.875rem;
    color: var(--sl-color-gray-3);
    font-weight: 600;
  }

  .copy-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 4px;
    color: #c4b5fd;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .copy-button:hover {
    background: rgba(139, 92, 246, 0.15);
    border-color: rgba(139, 92, 246, 0.3);
  }

  .copy-button .check-icon {
    display: none;
  }

  .copy-button.copied .copy-icon {
    display: none;
  }

  .copy-button.copied .check-icon {
    display: inline-flex;
  }

  .copy-button.copied {
    background: rgba(46, 160, 67, 0.15);
    border-color: rgba(46, 160, 67, 0.3);
    color: #57d9a3;
  }

  .copy-button :global(svg) {
    fill: currentColor;
  }

  .code-container {
    overflow: auto;
    max-height: 500px;
  }

  .workflow-code {
    margin: 0 !important;
    padding: 1.5rem !important;
    background: transparent !important;
    font-family: var(--sl-font-mono) !important;
    font-size: 0.875rem !important;
    line-height: 1.6 !important;
    color: var(--sl-color-text) !important;
    white-space: pre !important;
    overflow-x: auto !important;
  }

  .workflow-code code {
    display: block;
    background: transparent !important;
    padding: 0 !important;
  }

  .steps-section {
    padding: 1.5rem;
    background: rgba(13, 17, 23, 0.3);
    border-top: 1px solid var(--sl-color-hairline);
  }

  .steps-heading {
    margin: 0 0 1rem 0 !important;
    font-size: 1.125rem !important;
    font-weight: 600 !important;
    color: var(--sl-color-text);
  }

  /* Light theme adjustments */
  :global([data-theme='light']) .workflow-playground {
    background: rgba(255, 255, 255, 0.8);
    border-color: #d0d7de;
  }

  :global([data-theme='light']) .playground-header,
  :global([data-theme='light']) .viewer-header {
    background: rgba(246, 248, 250, 0.8);
  }

  :global([data-theme='light']) .playground-link {
    background: linear-gradient(135deg, rgba(130, 80, 223, 0.15), rgba(130, 80, 223, 0.08));
    border-color: rgba(130, 80, 223, 0.3);
    color: #6639ba;
  }

  :global([data-theme='light']) .playground-link:hover {
    background: linear-gradient(135deg, rgba(130, 80, 223, 0.2), rgba(130, 80, 223, 0.12));
    border-color: rgba(130, 80, 223, 0.4);
    color: #8250df;
  }

  :global([data-theme='light']) .steps-section {
    background: rgba(246, 248, 250, 0.5);
  }

  :global([data-theme='light']) .copy-button {
    background: rgba(130, 80, 223, 0.1);
    border-color: rgba(130, 80, 223, 0.2);
    color: #6639ba;
  }

  :global([data-theme='light']) .copy-button:hover {
    background: rgba(130, 80, 223, 0.15);
    border-color: rgba(130, 80, 223, 0.3);
  }

  @media (prefers-reduced-motion: reduce) {
    .playground-link,
    .copy-button {
      transition: none;
    }
  }
</style>
