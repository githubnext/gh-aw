---
import octicons from '@primer/octicons';

interface Step {
  id: string;
  title: string;
  description: string;
  codeLines?: [number, number]; // [start, end] line numbers to highlight
}

interface Props {
  title: string;
  workflowContent: string;
  steps: Step[];
  playgroundUrl?: string;
}

const { title, workflowContent, steps, playgroundUrl } = Astro.props;

const playIcon = octicons['play'].toSVG({ width: 16, height: 16 });
const copyIcon = octicons['copy'].toSVG({ width: 16, height: 16 });
const checkIcon = octicons['check'].toSVG({ width: 16, height: 16 });
const infoIcon = octicons['info'].toSVG({ width: 16, height: 16 });
---

<div class="workflow-playground">
  <div class="playground-header">
    <h3 class="playground-title">{title}</h3>
    {playgroundUrl && (
      <a href={playgroundUrl} target="_blank" rel="noopener noreferrer" class="playground-link">
        <span set:html={playIcon} />
        Try in Playground
      </a>
    )}
  </div>

  <div class="playground-container">
    <div class="workflow-viewer">
      <div class="viewer-header">
        <span class="viewer-title">workflow.md</span>
        <button class="copy-button" data-copy-content={workflowContent}>
          <span class="copy-icon" set:html={copyIcon} />
          <span class="check-icon" set:html={checkIcon} />
          <span class="button-text">Copy</span>
        </button>
      </div>
      <div class="code-container">
        <pre class="workflow-code" data-workflow-content={workflowContent}><code>{workflowContent}</code></pre>
      </div>
    </div>

    <div class="steps-panel">
      <div class="steps-header">
        <span set:html={infoIcon} />
        Step-by-Step Guide
      </div>
      <div class="steps-list">
        {steps.map((step, index) => (
          <div 
            class="step-item" 
            data-step-id={step.id}
            data-code-lines={step.codeLines ? JSON.stringify(step.codeLines) : null}
          >
            <div class="step-number">{index + 1}</div>
            <div class="step-content">
              <h4 class="step-title">{step.title}</h4>
              <p class="step-description">{step.description}</p>
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>
</div>

<script>
  // Copy to clipboard functionality
  document.addEventListener('DOMContentLoaded', () => {
    const copyButtons = document.querySelectorAll('.copy-button');
    
    copyButtons.forEach(button => {
      button.addEventListener('click', async () => {
        const content = button.getAttribute('data-copy-content');
        if (content) {
          try {
            await navigator.clipboard.writeText(content);
            button.classList.add('copied');
            setTimeout(() => {
              button.classList.remove('copied');
            }, 2000);
          } catch (err) {
            console.error('Failed to copy:', err);
          }
        }
      });
    });

    // Step highlighting functionality
    const stepItems = document.querySelectorAll('.step-item');
    const codeElements = document.querySelectorAll('.workflow-code');

    stepItems.forEach(stepItem => {
      stepItem.addEventListener('mouseenter', () => {
        // Remove active state from all steps
        stepItems.forEach(item => item.classList.remove('active'));
        
        // Add active state to current step
        stepItem.classList.add('active');

        // Highlight corresponding code lines
        const codeLinesAttr = stepItem.getAttribute('data-code-lines');
        if (codeLinesAttr) {
          const codeLines = JSON.parse(codeLinesAttr);
          highlightCodeLines(codeLines);
        }
      });

      stepItem.addEventListener('mouseleave', () => {
        stepItem.classList.remove('active');
        clearHighlights();
      });
    });

    function highlightCodeLines(lines: [number, number]) {
      const [start, end] = lines;
      const codeElement = document.querySelector('.workflow-code code');
      if (!codeElement) return;

      const codeText = codeElement.textContent || '';
      const codeLineArray = codeText.split('\n');
      
      // Add highlight class to lines (simple approach)
      const container = codeElement.closest('.code-container');
      if (container) {
        container.setAttribute('data-highlight-start', String(start));
        container.setAttribute('data-highlight-end', String(end));
      }
    }

    function clearHighlights() {
      const containers = document.querySelectorAll('.code-container');
      containers.forEach(container => {
        container.removeAttribute('data-highlight-start');
        container.removeAttribute('data-highlight-end');
      });
    }
  });
</script>

<style>
  .workflow-playground {
    margin: 2rem 0;
    border: 1px solid var(--sl-color-hairline);
    border-radius: 8px;
    background: rgba(13, 17, 23, 0.4);
    backdrop-filter: blur(8px);
    overflow: hidden;
  }

  .playground-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--sl-color-hairline);
    background: rgba(13, 17, 23, 0.6);
  }

  .playground-title {
    margin: 0 !important;
    font-size: 1.5rem !important;
    font-weight: 700 !important;
    color: var(--sl-color-text);
  }

  .playground-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 6px;
    color: #c4b5fd;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.2s ease;
  }

  .playground-link:hover {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(139, 92, 246, 0.15));
    border-color: rgba(139, 92, 246, 0.5);
    color: #ddd6fe;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
  }

  .playground-link :global(svg) {
    fill: currentColor;
  }

  .playground-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    min-height: 500px;
  }

  @media (max-width: 768px) {
    .playground-container {
      grid-template-columns: 1fr;
    }
  }

  .workflow-viewer {
    border-right: 1px solid var(--sl-color-hairline);
    display: flex;
    flex-direction: column;
  }

  @media (max-width: 768px) {
    .workflow-viewer {
      border-right: none;
      border-bottom: 1px solid var(--sl-color-hairline);
    }
  }

  .viewer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background: rgba(13, 17, 23, 0.6);
    border-bottom: 1px solid var(--sl-color-hairline);
  }

  .viewer-title {
    font-family: var(--sl-font-mono);
    font-size: 0.875rem;
    color: var(--sl-color-gray-3);
    font-weight: 600;
  }

  .copy-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 4px;
    color: #c4b5fd;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .copy-button:hover {
    background: rgba(139, 92, 246, 0.15);
    border-color: rgba(139, 92, 246, 0.3);
  }

  .copy-button .check-icon {
    display: none;
  }

  .copy-button.copied .copy-icon {
    display: none;
  }

  .copy-button.copied .check-icon {
    display: inline-flex;
  }

  .copy-button.copied {
    background: rgba(46, 160, 67, 0.15);
    border-color: rgba(46, 160, 67, 0.3);
    color: #57d9a3;
  }

  .copy-button :global(svg) {
    fill: currentColor;
  }

  .code-container {
    flex: 1;
    overflow: auto;
    position: relative;
  }

  .workflow-code {
    margin: 0 !important;
    padding: 1.5rem !important;
    background: transparent !important;
    font-family: var(--sl-font-mono) !important;
    font-size: 0.875rem !important;
    line-height: 1.6 !important;
    color: var(--sl-color-text) !important;
    white-space: pre !important;
    overflow-x: auto !important;
  }

  .workflow-code code {
    display: block;
    background: transparent !important;
    padding: 0 !important;
  }

  .steps-panel {
    display: flex;
    flex-direction: column;
    background: rgba(13, 17, 23, 0.3);
  }

  .steps-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    background: rgba(13, 17, 23, 0.6);
    border-bottom: 1px solid var(--sl-color-hairline);
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--sl-color-gray-3);
  }

  .steps-header :global(svg) {
    fill: currentColor;
  }

  .steps-list {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
  }

  .step-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    border: 1px solid rgba(139, 92, 246, 0.15);
    border-radius: 6px;
    background: rgba(13, 17, 23, 0.4);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .step-item:last-child {
    margin-bottom: 0;
  }

  .step-item:hover,
  .step-item.active {
    background: rgba(139, 92, 246, 0.08);
    border-color: rgba(139, 92, 246, 0.3);
    transform: translateX(4px);
  }

  .step-number {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 50%;
    font-weight: 700;
    font-size: 0.875rem;
    color: #c4b5fd;
  }

  .step-item.active .step-number {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), rgba(139, 92, 246, 0.2));
    border-color: rgba(139, 92, 246, 0.5);
    color: #ddd6fe;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
  }

  .step-content {
    flex: 1;
    min-width: 0;
  }

  .step-title {
    margin: 0 0 0.5rem 0 !important;
    font-size: 1rem !important;
    font-weight: 600 !important;
    color: var(--sl-color-text);
  }

  .step-description {
    margin: 0 !important;
    font-size: 0.875rem !important;
    line-height: 1.5 !important;
    color: var(--sl-color-gray-3);
  }

  /* Light theme adjustments */
  :global([data-theme='light']) .workflow-playground {
    background: rgba(255, 255, 255, 0.8);
    border-color: #d0d7de;
  }

  :global([data-theme='light']) .playground-header,
  :global([data-theme='light']) .viewer-header,
  :global([data-theme='light']) .steps-header {
    background: rgba(246, 248, 250, 0.8);
  }

  :global([data-theme='light']) .playground-link {
    background: linear-gradient(135deg, rgba(130, 80, 223, 0.15), rgba(130, 80, 223, 0.08));
    border-color: rgba(130, 80, 223, 0.3);
    color: #6639ba;
  }

  :global([data-theme='light']) .playground-link:hover {
    background: linear-gradient(135deg, rgba(130, 80, 223, 0.2), rgba(130, 80, 223, 0.12));
    border-color: rgba(130, 80, 223, 0.4);
    color: #8250df;
  }

  :global([data-theme='light']) .steps-panel {
    background: rgba(246, 248, 250, 0.5);
  }

  :global([data-theme='light']) .step-item {
    background: rgba(255, 255, 255, 0.8);
    border-color: rgba(130, 80, 223, 0.15);
  }

  :global([data-theme='light']) .step-item:hover,
  :global([data-theme='light']) .step-item.active {
    background: rgba(130, 80, 223, 0.08);
    border-color: rgba(130, 80, 223, 0.3);
  }

  :global([data-theme='light']) .copy-button {
    background: rgba(130, 80, 223, 0.1);
    border-color: rgba(130, 80, 223, 0.2);
    color: #6639ba;
  }

  :global([data-theme='light']) .copy-button:hover {
    background: rgba(130, 80, 223, 0.15);
    border-color: rgba(130, 80, 223, 0.3);
  }

  :global([data-theme='light']) .step-number {
    background: linear-gradient(135deg, rgba(130, 80, 223, 0.15), rgba(130, 80, 223, 0.08));
    border-color: rgba(130, 80, 223, 0.3);
    color: #6639ba;
  }

  :global([data-theme='light']) .step-item.active .step-number {
    background: linear-gradient(135deg, rgba(130, 80, 223, 0.3), rgba(130, 80, 223, 0.15));
    border-color: rgba(130, 80, 223, 0.5);
    color: #8250df;
  }

  @media (prefers-reduced-motion: reduce) {
    .playground-link,
    .copy-button,
    .step-item,
    .step-number {
      transition: none;
    }
  }
</style>
